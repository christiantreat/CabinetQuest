<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cabinet Quest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Courier New', Courier, monospace;
            background: #e8dcc4;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 4px),
                repeating-linear-gradient(90deg, transparent, transparent 2px, rgba(0,0,0,.02) 2px, rgba(0,0,0,.02) 4px);
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }

        /* Main Container */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Retro Header */
        .header {
            background: linear-gradient(180deg, #6b5d47 0%, #5a4d38 100%);
            padding: 8px 12px;
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.2),
                0 3px 8px rgba(0,0,0,0.4);
            z-index: 100;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            border-bottom: 3px solid #3d3426;
        }

        .header h1 {
            font-size: 14px;
            color: #f5e6d3;
            margin: 0;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-weight: bold;
            letter-spacing: 1px;
            text-shadow: 2px 2px 3px rgba(0,0,0,0.5);
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .scenario-name {
            font-size: 15px;
            color: #d4850e;
            font-weight: bold;
            display: block;
            margin-bottom: 4px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
        }

        /* Retro Chunky Buttons */
        .settings-btn, .scenarios-menu-btn {
            background: linear-gradient(180deg, #8b7355 0%, #6b5847 100%);
            border: 2px solid #4a3f2f;
            border-bottom-width: 4px;
            border-right-width: 3px;
            font-size: 16px;
            cursor: pointer;
            padding: 6px 10px;
            color: #f5e6d3;
            border-radius: 3px;
            transition: all 0.1s;
            flex-shrink: 0;
            font-weight: bold;
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.3),
                2px 2px 4px rgba(0,0,0,0.4);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .settings-btn:active, .scenarios-menu-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.3),
                1px 1px 2px rgba(0,0,0,0.4);
        }

        .scenarios-menu-btn {
            background: linear-gradient(180deg, #9b8b47 0%, #7a6b38 100%);
        }

        /* Retro CRT Monitor Style Task Bar */
        .scenario-description-box {
            background: #2a2520;
            border: 4px solid #5a4d38;
            border-radius: 4px;
            padding: 12px;
            margin: 8px;
            font-size: 12px;
            color: #6fb33f;
            display: none;
            line-height: 1.4;
            box-shadow: 
                inset 0 0 20px rgba(0,0,0,0.5),
                inset 0 0 8px rgba(111,179,63,0.3),
                0 4px 8px rgba(0,0,0,0.3);
            font-family: 'Courier New', Courier, monospace;
            position: relative;
        }

        .scenario-description-box::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                rgba(111,179,63,0.03) 0px,
                rgba(111,179,63,0.03) 2px,
                transparent 2px,
                transparent 4px
            );
            pointer-events: none;
            border-radius: 2px;
        }

        .scenario-description-box.active {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .scenario-task-row {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .scenario-task-text {
            flex: 1;
            min-width: 0;
        }

        .scenario-task-text strong {
            font-weight: bold;
            display: none;
        }

        /* Chunky Retro Action Buttons */
        .scenario-actions {
            display: flex;
            gap: 8px;
            flex-wrap: nowrap;
        }

        .scenario-action-btn {
            flex: 1;
            min-width: 75px;
            padding: 10px 12px;
            border: 3px solid;
            border-radius: 4px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.1s ease;
            min-height: 42px;
            white-space: nowrap;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.3),
                3px 3px 0 rgba(0,0,0,0.3);
        }

        .scenario-action-btn:active {
            transform: translate(2px, 2px);
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.3),
                1px 1px 0 rgba(0,0,0,0.3);
        }

        /* Floating Action Bar */
        .floating-action-bar {
            position: fixed;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            background: rgba(42, 37, 32, 0.95);
            padding: 10px;
            border-radius: 8px;
            border: 3px solid #5a4d38;
            box-shadow:
                0 4px 12px rgba(0,0,0,0.4),
                inset 0 0 20px rgba(0,0,0,0.3);
            z-index: 100;
        }

        /* Scenario Info Button */
        .scenario-info-btn {
            background: linear-gradient(180deg, #6b8fb5 0%, #5a7a9f 100%);
            border: 2px solid #3d5a7a;
            border-bottom-width: 4px;
            border-right-width: 3px;
            font-size: 14px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            color: #f5e6d3;
            font-weight: bold;
            transition: all 0.1s ease;
            margin-left: 8px;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.3),
                2px 2px 4px rgba(0,0,0,0.4);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .scenario-info-btn:active {
            transform: translateY(2px);
            border-bottom-width: 2px;
            box-shadow:
                inset 0 1px 0 rgba(255,255,255,0.3),
                1px 1px 2px rgba(0,0,0,0.4);
        }

        /* Restart button - Burnt Orange */
        .restart-btn {
            background: linear-gradient(180deg, #d4850e 0%, #b56f0a 100%);
            color: #2a2520;
            border-color: #8b5608;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
        }

        /* Submit button - Avocado Green */
        .submit-btn-yellow {
            background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%);
            color: #2a2520;
            border-color: #5a7b24;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
        }

        .submit-btn-yellow:not(:disabled) {
            animation: retro-pulse 2s ease-in-out infinite;
        }

        @keyframes retro-pulse {
            0%, 100% { 
                box-shadow: 
                    inset 0 1px 0 rgba(255,255,255,0.3),
                    3px 3px 0 rgba(0,0,0,0.3);
            }
            50% { 
                box-shadow: 
                    inset 0 1px 0 rgba(255,255,255,0.3),
                    3px 3px 0 rgba(0,0,0,0.3),
                    0 0 15px rgba(143,179,63,0.6);
            }
        }

        .submit-btn-yellow:disabled {
            background: linear-gradient(180deg, #8b7d6a 0%, #6b5d52 100%);
            border-color: #4a3f2f;
            box-shadow: 
                inset 0 1px 0 rgba(0,0,0,0.3),
                1px 1px 0 rgba(0,0,0,0.3);
            animation: none;
            cursor: not-allowed;
            opacity: 0.5;
            color: #5a4d38;
            text-shadow: none;
        }

        /* Advance button - Brown */
        .advance-btn {
            background: linear-gradient(180deg, #8b7355 0%, #6b5847 100%);
            color: #f5e6d3;
            border-color: #4a3f2f;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Feedback area in scenario box */
        .scenario-feedback {
            padding: 10px;
            border-radius: 4px;
            font-size: 12px;
            line-height: 1.5;
            display: none;
            border: 2px solid;
            font-family: 'Courier New', Courier, monospace;
        }

        .scenario-feedback.active {
            display: block;
        }

        .scenario-feedback.success {
            background: #3d4a2f;
            border-color: #6fb33f;
            color: #b8d88f;
        }

        .scenario-feedback.partial {
            background: #4a3d2a;
            border-color: #d4850e;
            color: #f5c77e;
        }

        .scenario-feedback.error {
            background: #4a2f2f;
            border-color: #b54a3d;
            color: #f5b8b0;
        }

        .scenario-feedback strong {
            font-weight: bold;
            display: block;
            margin-bottom: 5px;
        }

        .stats-compact {
            display: flex;
            gap: 10px;
            font-size: 11px;
            flex-shrink: 0;
            font-family: 'Courier New', Courier, monospace;
        }

        .stat-compact {
            color: #f5e6d3;
            font-weight: bold;
            white-space: nowrap;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .stat-compact .label {
            color: #c4b5a3;
            font-weight: normal;
        }

        /* Room View */
        .room-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #d4c4a8;
            box-shadow: inset 0 4px 12px rgba(0,0,0,0.2);
        }

        #room-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        /* Room Hint Overlay - Retro Style */
        .room-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #f5e6d3 0%, #e8dcc4 100%);
            color: #3d3426;
            padding: 18px 24px;
            border-radius: 4px;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
            box-shadow: 
                0 4px 0 #5a4d38,
                0 8px 16px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 50;
            border: 3px solid #6b5d47;
            font-weight: bold;
            font-family: 'Courier New', Courier, monospace;
        }

        .room-hint.hidden {
            display: none;
        }

        /* Modals - Retro Style */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(42, 37, 32, 0.85);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(180deg, #f5e6d3 0%, #e8dcc4 100%);
            border-radius: 6px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 
                0 0 0 4px #6b5d47,
                0 0 0 8px #3d3426,
                0 12px 32px rgba(0,0,0,0.6);
            border: 3px solid #8b7355;
        }

        .modal-header {
            padding: 20px;
            border-bottom: 3px solid #8b7355;
            background: linear-gradient(180deg, #6b5d47 0%, #5a4d38 100%);
        }

        .modal-header h2 {
            font-size: 20px;
            color: #f5e6d3;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-shadow: 2px 2px 3px rgba(0,0,0,0.5);
        }

        .modal-header p {
            color: #c4b5a3;
            margin-top: 5px;
        }

        .modal-body {
            padding: 20px;
            font-family: 'Courier New', Courier, monospace;
        }

        .modal-footer {
            padding: 20px;
            border-top: 3px solid #8b7355;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            background: linear-gradient(180deg, #e8dcc4 0%, #d4c4a8 100%);
        }

        .modal-footer button {
            flex: 1;
            padding: 12px;
            border: 3px solid;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.3),
                3px 3px 0 rgba(0,0,0,0.3);
        }

        .modal-footer button:active {
            transform: translate(2px, 2px);
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.3),
                1px 1px 0 rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%);
            color: #2a2520;
            border-color: #5a7b24;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
        }

        .btn-secondary {
            background: linear-gradient(180deg, #8b7355 0%, #6b5847 100%);
            color: #f5e6d3;
            border-color: #4a3f2f;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        /* Scenarios List in Modal */
        .scenarios-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
        }

        .scenario-item {
            background: linear-gradient(180deg, #f5e6d3 0%, #ebe0cd 100%);
            border: 3px solid #8b7355;
            border-radius: 4px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.1s;
            position: relative;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.2);
        }

        .scenario-item:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }

        .scenario-item.active {
            border-color: #8fb33f;
            background: linear-gradient(180deg, #d8e8c4 0%, #c8d8b4 100%);
            box-shadow: 
                0 0 0 2px #6fb33f,
                3px 3px 0 rgba(0,0,0,0.2);
        }

        .scenario-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
            background: linear-gradient(180deg, #d4c4a8 0%, #c4b498 100%);
        }

        .scenario-item.completed {
            border-color: #8fb33f;
        }

        .scenario-item.completed::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #6fb33f;
            font-size: 24px;
            font-weight: bold;
            text-shadow: 2px 2px 3px rgba(0,0,0,0.3);
        }

        .scenario-item h4 {
            font-size: 15px;
            margin-bottom: 6px;
            color: #3d3426;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
        }

        .scenario-item p {
            font-size: 12px;
            color: #5a4d38;
            line-height: 1.5;
        }

        /* Retro Cart with Drawers */
        .cart-visual-container {
            perspective: 1200px;
            padding: 20px;
        }

        .cart-label {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #3d3426;
            margin-bottom: 20px;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .cart-visual {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(to bottom, #4a3f2f, #3d3426);
            padding: 15px;
            border-radius: 4px;
            box-shadow: 
                0 0 0 3px #6b5d47,
                0 8px 20px rgba(0,0,0,0.5);
            border: 2px solid #2a2520;
        }

        .drawer-visual {
            position: relative;
            height: 85px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.2s ease;
        }

        .drawer-visual:hover {
            transform: translateZ(8px);
        }

        .drawer-visual:active {
            transform: translateZ(3px) translateX(15px);
            transition: transform 0.15s ease-out;
        }

        .drawer-face {
            width: 100%;
            height: 100%;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -2px 4px rgba(0,0,0,0.3),
                0 3px 8px rgba(0,0,0,0.4),
                -3px 0 8px rgba(0,0,0,0.2);
            position: relative;
            border: 3px solid;
            background: linear-gradient(to right, 
                var(--drawer-color) 0%, 
                var(--drawer-color-light) 50%, 
                var(--drawer-color) 100%);
        }

        .drawer-visual:active .drawer-face {
            box-shadow: 
                inset 0 2px 4px rgba(255,255,255,0.2),
                inset 0 -2px 4px rgba(0,0,0,0.3),
                0 2px 4px rgba(0,0,0,0.4),
                -8px 0 16px rgba(0,0,0,0.3);
        }

        /* Retro drawer handle */
        .drawer-handle {
            width: 70px;
            height: 12px;
            background: linear-gradient(to bottom, #5a4d38, #3d3426);
            border-radius: 2px;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.5),
                inset 0 1px 2px rgba(255,255,255,0.2);
            position: relative;
            border: 1px solid #2a2520;
        }

        .drawer-handle::before,
        .drawer-handle::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #2a2520 30%, #4a3f2f 70%, #2a2520 100%);
            border-radius: 50%;
            top: 2px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.6);
            border: 1px solid #1a1510;
        }

        .drawer-handle::before {
            left: 5px;
        }

        .drawer-handle::after {
            right: 5px;
        }

        .drawer-label {
            font-size: 14px;
            font-weight: bold;
            color: #2a2520;
            text-shadow: 
                1px 1px 0 rgba(255,255,255,0.3),
                -1px -1px 0 rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
        }

        /* Item count indicator */
        .drawer-item-count {
            background: linear-gradient(180deg, #f5e6d3 0%, #e8dcc4 100%);
            color: #3d3426;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 
                0 2px 4px rgba(0,0,0,0.3),
                inset 0 1px 0 rgba(255,255,255,0.5);
            border: 1px solid #8b7355;
        }

        /* Essential items indicator */
        .drawer-has-essential::after {
            content: '‚òÖ';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #d4850e;
            font-size: 24px;
            text-shadow: 
                0 0 8px rgba(212, 133, 14, 0.8),
                2px 2px 4px rgba(0,0,0,0.5);
            animation: retro-twinkle 2s ease-in-out infinite;
        }

        @keyframes retro-twinkle {
            0%, 100% { opacity: 1; transform: scale(1) rotate(0deg); }
            50% { opacity: 0.7; transform: scale(1.1) rotate(15deg); }
        }

        /* Item Grid */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .item-card {
            background: linear-gradient(180deg, #f5e6d3 0%, #ebe0cd 100%);
            border: 3px solid #8b7355;
            border-radius: 4px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.1s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.2);
        }

        .item-card:active {
            transform: translate(1px, 1px);
            box-shadow: 1px 1px 0 rgba(0,0,0,0.2);
        }

        .item-card.selected {
            border-color: #8fb33f;
            background: linear-gradient(180deg, #d8e8c4 0%, #c8d8b4 100%);
            box-shadow: 
                0 0 0 2px #6fb33f,
                2px 2px 0 rgba(0,0,0,0.2);
        }

        .item-card.in-inventory {
            border-color: #8b7355;
            background: linear-gradient(180deg, #d4c4a8 0%, #c4b498 100%);
            opacity: 0.7;
        }

        .item-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            background: linear-gradient(180deg, #c4b5a3 0%, #b4a593 100%);
            font-size: 14px;
            font-weight: bold;
            color: #3d3426;
            overflow: hidden;
            border: 2px solid #8b7d6a;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        .item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 2px;
        }

        .item-icon.loading {
            background: linear-gradient(90deg, #c4b5a3 25%, #b4a593 50%, #c4b5a3 75%);
            background-size: 200% 100%;
            animation: retro-shimmer 1.5s infinite;
        }

        @keyframes retro-shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .item-card h5 {
            font-size: 12px;
            color: #3d3426;
            margin: 0;
            font-family: 'Courier New', Courier, monospace;
            font-weight: bold;
        }

        /* Procedure Table in Room */
        .procedure-table {
            display: none !important;
        }

        /* Inventory Modal Items */
        .procedure-table-items {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .procedure-table-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: linear-gradient(180deg, #ebe0cd 0%, #dbd0bd 100%);
            padding: 10px;
            border-radius: 3px;
            font-size: 12px;
            border: 2px solid #8b7355;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        .procedure-table-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(180deg, #8b7355 0%, #6b5847 100%);
            color: #f5e6d3;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
            flex-shrink: 0;
            border: 2px solid #4a3f2f;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2);
        }

        .procedure-table-info {
            flex: 1;
            min-width: 0;
        }

        .procedure-table-info strong {
            display: block;
            font-size: 12px;
            color: #3d3426;
            margin-bottom: 3px;
            font-family: 'Courier New', Courier, monospace;
        }

        .procedure-table-info small {
            display: block;
            font-size: 10px;
            color: #6b5d47;
        }

        .procedure-table-remove {
            background: linear-gradient(180deg, #b54a3d 0%, #954030 100%);
            color: #f5e6d3;
            border: 2px solid #753020;
            border-radius: 3px;
            width: 24px;
            height: 24px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-weight: bold;
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.2),
                2px 2px 0 rgba(0,0,0,0.2);
        }

        .procedure-table-remove:active {
            transform: translate(1px, 1px);
            box-shadow: 
                inset 0 1px 0 rgba(255,255,255,0.2),
                1px 1px 0 rgba(0,0,0,0.2);
        }

        .procedure-table-empty {
            text-align: center;
            padding: 20px;
            color: #8b7d6a;
            font-size: 12px;
        }

        .item-badge {
            font-size: 9px;
            padding: 2px 5px;
            border-radius: 2px;
            margin-left: 4px;
            font-weight: bold;
            border: 1px solid;
        }

        .badge-essential {
            background: linear-gradient(180deg, #b54a3d 0%, #954030 100%);
            color: #f5e6d3;
            border-color: #753020;
        }

        .badge-optional {
            background: linear-gradient(180deg, #d4850e 0%, #b56f0a 100%);
            color: #2a2520;
            border-color: #8b5608;
        }

        /* Missed items list in feedback */
        .missed-items-section {
            margin: 15px 0;
            padding: 12px;
            background: linear-gradient(180deg, #ebe0cd 0%, #dbd0bd 100%);
            border-radius: 4px;
            border: 2px solid #8b7355;
        }

        .missed-items-section h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #3d3426;
            font-family: 'Courier New', Courier, monospace;
        }

        .missed-items-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .missed-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: linear-gradient(180deg, #f5e6d3 0%, #ebe0cd 100%);
            border-radius: 3px;
            border: 2px solid #8b7d6a;
            font-size: 12px;
        }

        .missed-item-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(180deg, #8b7d6a 0%, #6b5d52 100%);
            color: #f5e6d3;
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 11px;
            flex-shrink: 0;
            border: 2px solid #4a3f2f;
        }

        .missed-item-icon.essential {
            background: linear-gradient(180deg, #b54a3d 0%, #954030 100%);
            border-color: #753020;
        }

        .missed-item-info {
            flex: 1;
        }

        .missed-item-info strong {
            display: block;
            color: #3d3426;
            font-family: 'Courier New', Courier, monospace;
        }

        .missed-item-info small {
            color: #6b5d47;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 6px;
            justify-content: center;
            margin: 15px 0;
            font-size: 32px;
        }

        .star {
            color: #c4b5a3;
            transition: color 0.3s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .star.filled {
            color: #d4850e;
            animation: retro-star-pop 0.5s ease;
            text-shadow: 
                0 0 8px rgba(212, 133, 14, 0.6),
                2px 2px 4px rgba(0,0,0,0.4);
        }

        @keyframes retro-star-pop {
            0%, 100% { transform: scale(1) rotate(0deg); }
            50% { transform: scale(1.3) rotate(15deg); }
        }

        /* Progress Bars */
        .progress-container {
            width: 100%;
            height: 10px;
            background: linear-gradient(180deg, #c4b5a3 0%, #b4a593 100%);
            border-radius: 2px;
            overflow: hidden;
            border: 2px solid #8b7d6a;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%);
            transition: width 0.5s ease;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.3);
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(180deg, #d4850e 0%, #b56f0a 100%);
            color: #2a2520;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 
                0 0 0 3px #8b5608,
                0 4px 16px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            animation: retro-slide-in 0.5s ease;
            min-width: 250px;
            border: 2px solid #5a3b05;
        }

        .achievement-toast.show {
            display: block;
        }

        @keyframes retro-slide-in {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .achievement-toast h4 {
            font-size: 16px;
            margin-bottom: 5px;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
        }

        .achievement-toast p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Points Award Animation */
        .points-award {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%);
            color: #2a2520;
            padding: 20px 30px;
            border-radius: 4px;
            box-shadow: 
                0 0 0 4px #5a7b24,
                0 8px 24px rgba(0,0,0,0.6);
            z-index: 2000;
            display: none;
            animation: retro-points-pop 0.8s ease;
            font-size: 24px;
            font-weight: bold;
            border: 3px solid #3d5015;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 1px 1px 1px rgba(255,255,255,0.3);
        }

        .points-award.show {
            display: block;
        }

        @keyframes retro-points-pop {
            0% {
                transform: translate(-50%, -50%) scale(0) rotate(-15deg);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2) rotate(5deg);
            }
            100% {
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        /* Item Collected Toast */
        .item-collected-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(180deg, #8b7355 0%, #6b5847 100%);
            color: #f5e6d3;
            padding: 12px 20px;
            border-radius: 4px;
            box-shadow: 
                0 0 0 3px #4a3f2f,
                0 4px 16px rgba(0,0,0,0.5);
            z-index: 2000;
            display: none;
            animation: retro-item-toast 0.6s ease;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            min-width: 200px;
            border: 2px solid #2a2520;
            font-family: 'Courier New', Courier, monospace;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }

        .item-collected-toast.show {
            display: block;
        }

        @keyframes retro-item-toast {
            0% {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            20% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            80% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
        }

        /* Pulse animation for inventory count */
        @keyframes retro-inventory-pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
                color: #8fb33f;
                text-shadow: 0 0 8px rgba(143,179,63,0.8);
            }
        }

        .stat-pulse {
            animation: retro-inventory-pulse 0.4s ease;
        }

        /* Tutorial specific styles */
        .tutorial-step {
            display: none;
        }

        .tutorial-step.active {
            display: block;
            animation: retro-fade-in 0.3s ease;
        }

        @keyframes retro-fade-in {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tutorial-step h3 {
            font-size: 18px;
            color: #3d3426;
            margin-bottom: 15px;
            text-align: center;
            font-family: 'Courier New', Courier, monospace;
            text-transform: uppercase;
        }

        .tutorial-step p {
            font-size: 14px;
            line-height: 1.6;
            color: #5a4d38;
            text-align: center;
        }

        .tutorial-icon {
            font-size: 64px;
            text-align: center;
            margin: 20px 0;
            filter: sepia(0.5) brightness(1.1);
        }

        .tutorial-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .tutorial-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #c4b5a3;
            transition: all 0.3s;
            border: 2px solid #8b7d6a;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.3);
        }

        .tutorial-dot.active {
            background: #8fb33f;
            transform: scale(1.3);
            border-color: #5a7b24;
            box-shadow: 
                0 0 8px rgba(143,179,63,0.6),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        /* Results in settings modal */
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            background: linear-gradient(180deg, #ebe0cd 0%, #dbd0bd 100%);
            border: 2px solid #8b7355;
            border-radius: 4px;
            padding: 12px;
            box-shadow: 2px 2px 0 rgba(0,0,0,0.1);
        }

        .result-item h4 {
            font-size: 14px;
            color: #3d3426;
            margin-bottom: 5px;
            font-family: 'Courier New', Courier, monospace;
        }

        .result-item p {
            font-size: 12px;
            color: #5a4d38;
            margin: 3px 0;
        }

        /* Extra compact on very small screens */
        @media (max-width: 380px) {
            .header h1 {
                font-size: 12px;
            }

            .stats-compact {
                font-size: 10px;
                gap: 8px;
            }

            .scenario-description-box {
                font-size: 11px;
                padding: 8px;
            }

            .scenario-action-btn {
                font-size: 11px;
                padding: 8px 10px;
                min-height: 38px;
                min-width: 70px;
            }
            
            .scenario-name {
                font-size: 13px;
            }
        }

        /* Checkbox styling */
        input[type="checkbox"] {
            appearance: none;
            width: 20px;
            height: 20px;
            background: linear-gradient(180deg, #ebe0cd 0%, #dbd0bd 100%);
            border: 3px solid #8b7355;
            border-radius: 3px;
            cursor: pointer;
            position: relative;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
        }

        input[type="checkbox"]:checked {
            background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%);
            border-color: #5a7b24;
        }

        input[type="checkbox"]:checked::after {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #2a2520;
            font-size: 14px;
            font-weight: bold;
        }

        label {
            font-family: 'Courier New', Courier, monospace;
            color: #3d3426;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Retro Header -->
        <div class="header">
            <button class="scenarios-menu-btn" onclick="openScenariosModal()" title="Scenarios">üìã</button>
            <h1>üóÑÔ∏è CABINET QUEST</h1>
            <div class="header-info">
                <div class="stats-compact">
                    <div class="stat-compact">
                        ‚è±<span id="stat-time">0:00</span>
                    </div>
                    <div class="stat-compact">
                        üì¶<span id="stat-items">0</span>
                    </div>
                </div>
                <button class="scenario-info-btn" id="scenario-info-btn" onclick="openScenarioDetailsModal()" title="View Scenario Details" style="display: none;">
                    ‚ÑπÔ∏è
                </button>
            </div>
            <button class="settings-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
        </div>

        <!-- Hidden storage for scenario data -->
        <div style="display: none;">
            <span class="scenario-name" id="scenario-name">Select a scenario</span>
            <span id="task-description"></span>
            <div class="scenario-feedback" id="scenario-feedback"></div>
        </div>

        <!-- Floating Action Bar -->
        <div class="floating-action-bar" id="floating-action-bar" style="display: none;">
            <button class="scenario-action-btn restart-btn" id="restart-btn" onclick="retryScenario()" style="display: none;">
                üîÑ Retry
            </button>
            <button class="scenario-action-btn submit-btn-yellow" id="submit-btn-yellow" onclick="submitInventory()" disabled>
                ‚úì Submit
            </button>
            <button class="scenario-action-btn advance-btn" id="advance-btn" onclick="continueToNext()" style="display: none;">
                ‚Üí Next
            </button>
        </div>

        <!-- Room Container -->
        <div class="room-container">
            <canvas id="room-canvas"></canvas>
            <div class="room-hint" id="room-hint">Open Scenarios menu to begin</div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal" id="tutorial-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tutorial-header">üéì Welcome to Cabinet Quest!</h2>
                <div class="tutorial-progress" id="tutorial-progress"></div>
            </div>
            <div class="modal-body">
                <div class="tutorial-step active" data-step="0">
                    <div class="tutorial-icon">üóÑÔ∏è</div>
                    <h3>Welcome!</h3>
                    <p>Learn how to use Cabinet Quest to master emergency medical equipment locations and procedures.</p>
                </div>

                <div class="tutorial-step" data-step="1">
                    <div class="tutorial-icon">üìã</div>
                    <h3>Choose a Scenario</h3>
                    <p>Click "Scenarios" to select a medical emergency. You'll work through them one at a time, learning what equipment you need for each situation.</p>
                </div>

                <div class="tutorial-step" data-step="2">
                    <div class="tutorial-icon">üö™</div>
                    <h3>Explore the Room</h3>
                    <p>Tap on carts in the trauma room to open them. Each cart has 3 drawers you can see and interact with.</p>
                </div>

                <div class="tutorial-step" data-step="3">
                    <div class="tutorial-icon">üéí</div>
                    <h3>Collect Items</h3>
                    <p>Tap drawers to open them and select items. Selected items will be highlighted. Tap "Add to Table" to collect them. View your collected items by tapping the Procedure Table cart in the center.</p>
                </div>

                <div class="tutorial-step" data-step="4">
                    <div class="tutorial-icon">‚úì</div>
                    <h3>Submit & Learn</h3>
                    <p>When ready, submit your inventory to see how you did. You'll see what you got right and what you missed. You can retry or continue to the next scenario.</p>
                </div>

                <div class="tutorial-step" data-step="5">
                    <div class="tutorial-icon">‚≠ê</div>
                    <h3>Earn Rewards</h3>
                    <p>Complete scenarios to earn stars, points, and unlock achievements. Improve your knowledge of trauma room equipment locations!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="tutorial-prev" onclick="prevTutorialStep()" style="display: none;">‚Üê Back</button>
                <button class="btn-primary" id="tutorial-next" onclick="nextTutorialStep()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Scenarios Modal -->
    <div class="modal" id="scenarios-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Select Scenario</h2>
                <p style="font-size: 12px; color: #c4b5a3; margin-top: 5px;">
                    Progress: <strong id="progress-badge-modal">0/0</strong>
                </p>
            </div>
            <div class="modal-body">
                <div class="scenarios-grid" id="scenarios-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('scenarios-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
            </div>
            <div class="modal-body">
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sound-toggle" onchange="toggleSound()" checked>
                        <span>üîä Sound Effects</span>
                    </label>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="haptic-toggle" onchange="toggleHaptic()" checked>
                        <span>üì≥ Haptic Feedback</span>
                    </label>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 2px solid #8b7355;">

                <h3 style="font-size: 16px; margin-bottom: 10px; font-family: 'Courier New', Courier, monospace; color: #3d3426;">üë§ Participant Info</h3>
                <div id="participant-info-display" style="background: #f5e6d3; padding: 12px; border-radius: 4px; margin-bottom: 10px; font-size: 13px;">
                    <strong>ID:</strong> <span id="participant-id-display">Not enrolled</span>
                </div>
                <div style="margin: 15px 0;">
                    <button onclick="openEnrollmentModal()" style="width: 100%; padding: 12px; background: linear-gradient(180deg, #6b8fb5 0%, #5a7a9f 100%); color: #f5e6d3; border: 3px solid #3d5a7a; border-radius: 4px; cursor: pointer; font-family: 'Courier New', Courier, monospace; font-weight: bold; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); font-size: 14px;">
                        üë§ Update Participant Info
                    </button>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 2px solid #8b7355;">

                <h3 style="font-size: 16px; margin-bottom: 10px; font-family: 'Courier New', Courier, monospace; color: #3d3426;">üìä Your Results</h3>
                <div class="results-list" id="results-list">
                    <div class="procedure-table-empty">No results yet. Complete a scenario to see your performance!</div>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 2px solid #8b7355;">

                <h3 style="font-size: 16px; margin-bottom: 10px; font-family: 'Courier New', Courier, monospace; color: #3d3426;">üì• Research Data Export</h3>
                <div style="margin: 15px 0;">
                    <button onclick="exportResearchJSON()" style="width: 100%; padding: 12px; background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%); color: #2a2520; border: 3px solid #5a7b24; border-radius: 4px; cursor: pointer; font-family: 'Courier New', Courier, monospace; font-weight: bold; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); font-size: 14px; margin-bottom: 8px;">
                        üìÑ Export Research Data (JSON)
                    </button>
                    <button onclick="exportResearchCSV()" style="width: 100%; padding: 12px; background: linear-gradient(180deg, #8fb33f 0%, #739b2f 100%); color: #2a2520; border: 3px solid #5a7b24; border-radius: 4px; cursor: pointer; font-family: 'Courier New', Courier, monospace; font-weight: bold; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); font-size: 14px;">
                        üìä Export Research Data (CSV)
                    </button>
                </div>
                <div style="margin: 15px 0;">
                    <button onclick="exportAnalytics()" style="width: 100%; padding: 12px; background: linear-gradient(180deg, #d4850e 0%, #b56f0a 100%); color: #2a2520; border: 3px solid #8b5608; border-radius: 4px; cursor: pointer; font-family: 'Courier New', Courier, monospace; font-weight: bold; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); font-size: 14px;">
                        üìä Export Legacy Analytics
                    </button>
                </div>

                <hr style="margin: 20px 0; border: none; border-top: 2px solid #8b7355;">

                <div style="margin: 15px 0;">
                    <button onclick="resetProgress()" style="width: 100%; padding: 12px; background: linear-gradient(180deg, #b54a3d 0%, #954030 100%); color: #f5e6d3; border: 3px solid #753020; border-radius: 4px; cursor: pointer; font-family: 'Courier New', Courier, monospace; font-weight: bold; box-shadow: 3px 3px 0 rgba(0,0,0,0.3); font-size: 14px;">
                        üîÑ Reset All Progress
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('settings-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Participant Enrollment Modal -->
    <div class="modal" id="enrollment-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Research Participant Enrollment</h2>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px; color: #5a4d38;">Please provide your information to participate in the research study.</p>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Participant ID *</label>
                    <input type="text" id="participant-id-input" placeholder="e.g., P001"
                           style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Training Level *</label>
                    <select id="training-level-input" style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                        <option value="">Select...</option>
                        <option value="pgy1">PGY-1</option>
                        <option value="pgy2">PGY-2</option>
                        <option value="pgy3">PGY-3</option>
                        <option value="pgy4">PGY-4</option>
                        <option value="fellow">Fellow</option>
                        <option value="attending">Attending</option>
                    </select>
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Prior EM Experience (months)</label>
                    <input type="number" id="prior-em-months-input" placeholder="0" min="0"
                           style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Prior Trauma Level Experience</label>
                    <select id="prior-trauma-input" style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                        <option value="none">None</option>
                        <option value="level3">Level 3</option>
                        <option value="level2">Level 2</option>
                        <option value="level1">Level 1</option>
                    </select>
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Fellowship Type</label>
                    <select id="fellowship-type-input" style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                        <option value="none">None</option>
                        <option value="ultrasound">Ultrasound</option>
                        <option value="toxicology">Toxicology</option>
                        <option value="ems">EMS</option>
                        <option value="wilderness">Wilderness</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Medical Degree</label>
                    <select id="medical-degree-input" style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                        <option value="md_us">MD (US)</option>
                        <option value="do_us">DO (US)</option>
                        <option value="img">IMG</option>
                    </select>
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Gender (optional)</label>
                    <select id="gender-input" style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                        <option value="prefer_not_to_say">Prefer not to say</option>
                        <option value="m">Male</option>
                        <option value="f">Female</option>
                        <option value="nb">Non-binary</option>
                    </select>
                </div>

                <div style="margin: 15px 0;">
                    <label style="display: block; margin-bottom: 5px; font-weight: bold;">Age Range (optional)</label>
                    <select id="age-range-input" style="width: 100%; padding: 10px; border: 2px solid #8b7355; border-radius: 4px; font-family: 'Courier New', Courier, monospace;">
                        <option value="prefer_not_to_say">Prefer not to say</option>
                        <option value="25-29">25-29</option>
                        <option value="30-34">30-34</option>
                        <option value="35-39">35-39</option>
                        <option value="40+">40+</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="skipEnrollment()">Skip (Demo Mode)</button>
                <button class="btn-primary" onclick="submitEnrollment()">Enroll</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal - Retro Visual Drawers -->
    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="cart-modal-title">Select Drawer</h2>
            </div>
            <div class="modal-body" id="cart-modal-body">
                <!-- Will be populated with visual cart -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('cart-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="modal" id="item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="item-modal-title">Select Items</h2>
            </div>
            <div class="modal-body">
                <div class="item-grid" id="item-grid"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="backToCart()">‚Üê Back to Drawers</button>
                <button class="btn-primary" onclick="collectSelectedItems()">Add to Table</button>
            </div>
        </div>
    </div>

    <!-- Scenario Details Modal -->
    <div class="modal" id="scenario-details-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="scenario-details-title">üìã Current Scenario</h2>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px;">
                    <h3 style="color: #5a4d38; font-size: 16px; margin-bottom: 8px;" id="scenario-details-name">Scenario Name</h3>
                    <p style="color: #3d3426; font-size: 14px; line-height: 1.6;" id="scenario-details-description">Scenario description will appear here.</p>
                </div>
                <div id="scenario-details-feedback" style="margin-top: 15px;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('scenario-details-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal" id="inventory-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Procedure Table</h2>
                <p style="font-size: 12px; color: #c4b5a3; margin-top: 5px;">
                    Items collected: <strong id="inventory-count">0</strong>
                </p>
            </div>
            <div class="modal-body">
                <div class="procedure-table-items" id="inventory-modal-items">
                    <div class="procedure-table-empty">No items collected yet</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('inventory-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal" id="feedback-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="feedback-modal-title">Results</h2>
            </div>
            <div class="modal-body" id="feedback-modal-body">
                <!-- Dynamic feedback content goes here -->
            </div>
            <div class="modal-footer" id="feedback-modal-footer">
                <button class="btn-secondary" onclick="closeModal('feedback-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Achievement Toast -->
    <div class="achievement-toast" id="achievement-toast">
        <h4 id="achievement-title">üèÜ Achievement Unlocked!</h4>
        <p id="achievement-desc">Description</p>
    </div>

    <!-- Points Award -->
    <div class="points-award" id="points-award">
        +500 Points!
    </div>

    <!-- Item Collected Toast -->
    <div class="item-collected-toast" id="item-collected-toast">
        ‚úì Items Added to Table!
    </div>

    <script>
        // ===== DATA =====
        const DATA = {
            carts: [
                { id: 'airway', name: 'Green IV Cart', x: 0.25, y: 0.25, color: '#8fb33f' },
                { id: 'resus', name: 'Resuscitation Cart', x: 0.25, y: 0.65, color: '#b33f6f' },
                { id: 'inventory', name: 'Procedure Table', x: 0.5, y: 0.5, color: '#8b7355', isInventory: true }
            ],
            drawers: [
                // Green IV Cart (formerly Airway Cart)
                { id: 'airway-d1', cart: 'airway', name: 'Top Drawer', number: 1 },
                { id: 'airway-d2', cart: 'airway', name: 'Middle Drawer', number: 2 },
                { id: 'airway-d3', cart: 'airway', name: 'Bottom Drawer', number: 3 },

                // Resuscitation Cart
                { id: 'resus-d1', cart: 'resus', name: 'Top Drawer', number: 1 },
                { id: 'resus-d2', cart: 'resus', name: 'Drawer 2', number: 2 },
                { id: 'resus-d3', cart: 'resus', name: 'Drawer 3', number: 3 },
                { id: 'resus-d4', cart: 'resus', name: 'Drawer 4', number: 4 },
                { id: 'resus-d5', cart: 'resus', name: 'Drawer 5', number: 5 },
                { id: 'resus-d6', cart: 'resus', name: 'Bottom Drawer', number: 6 }
            ],
            items: [
                // Green IV Cart (formerly Airway Cart)
                { id: 'ett', name: 'Endotracheal Tube', cart: 'airway', drawer: 'airway-d1', image: 'images/ett.png' },
                { id: 'laryngoscope', name: 'Laryngoscope', cart: 'airway', drawer: 'airway-d1', image: 'images/laryngoscope.png' },
                { id: 'bvm', name: 'Bag-Valve-Mask', cart: 'airway', drawer: 'airway-d2', image: 'images/bvm.png' },
                { id: 'oropharyngeal', name: 'Oropharyngeal Airway', cart: 'airway', drawer: 'airway-d2', image: 'images/oropharyngeal.png' },
                { id: 'suction', name: 'Suction Catheter', cart: 'airway', drawer: 'airway-d3', image: 'images/suction.png' },
                { id: 'oxygen', name: 'Oxygen Mask', cart: 'airway', drawer: 'airway-d3', image: 'images/oxygen.png' },

                // Resuscitation Cart - Drawer 1
                { id: 'or-towels', name: 'O.R. Towels', cart: 'resus', drawer: 'resus-d1', image: 'images/or-towels.png' },
                { id: 'silk-suture-2-0', name: '2-0 Silk Suture', cart: 'resus', drawer: 'resus-d1', image: 'images/silk-suture-2-0.png' },
                { id: 'tegaderm-4x4', name: '4x4 Tegaderm', cart: 'resus', drawer: 'resus-d1', image: 'images/tegaderm-4x4.png' },
                { id: 'betadine-bottle', name: 'Betadine Bottle', cart: 'resus', drawer: 'resus-d1', image: 'images/betadine-bottle.png' },

                // Resuscitation Cart - Drawer 2
                { id: 'gauze-bandage-roll', name: 'Gauze Bandage Roll', cart: 'resus', drawer: 'resus-d2', image: 'images/gauze-bandage-roll.png' },
                { id: 'chloraprep', name: 'ChloraPrep', cart: 'resus', drawer: 'resus-d2', image: 'images/chloraprep.png' },

                // Resuscitation Cart - Drawer 3
                { id: 'us-probe-cover', name: 'Ultrasound Probe Cover', cart: 'resus', drawer: 'resus-d3', image: 'images/us-probe-cover.png' },
                { id: 'us-gel', name: 'Ultrasound Gel', cart: 'resus', drawer: 'resus-d3', image: 'images/us-gel.png' },
                { id: 'arterial-line-kit', name: 'Arterial Line Kit', cart: 'resus', drawer: 'resus-d3', image: 'images/arterial-line-kit.png' },
                { id: 'arrow-radial-cath', name: 'Arrow Radial Arterial Cath Kit', cart: 'resus', drawer: 'resus-d3', image: 'images/arrow-radial-cath.png' },

                // Resuscitation Cart - Drawer 4
                { id: 'cl-insertion-tray-1', name: 'Central Line Insertion Tray', cart: 'resus', drawer: 'resus-d4', image: 'images/cl-insertion-tray.png' },
                { id: 'cordis-sheath-7-5', name: '7.5 Fr Cordis Sheath Kit', cart: 'resus', drawer: 'resus-d4', image: 'images/cordis-sheath-7-5.png' },

                // Resuscitation Cart - Drawer 5
                { id: 'cl-insertion-tray-2', name: 'Central Line Insertion Tray', cart: 'resus', drawer: 'resus-d5', image: 'images/cl-insertion-tray.png' },
                { id: 'triple-lumen-cl', name: 'Triple Lumen Central Line Kit', cart: 'resus', drawer: 'resus-d5', image: 'images/triple-lumen-cl.png' },

                // Resuscitation Cart - Drawer 6
                { id: 'chest-tube', name: 'Chest Tube', cart: 'resus', drawer: 'resus-d6', image: 'images/chest-tube.png' },
                { id: 'pleur-evac', name: 'Pleur-evac Chest Drain', cart: 'resus', drawer: 'resus-d6', image: 'images/pleur-evac.png' },
                { id: 'chest-tube-tray', name: 'Chest Tube Tray', cart: 'resus', drawer: 'resus-d6', image: 'images/chest-tube-tray.png' }
            ],
            scenarios: [
                {
                    id: 's2',
                    name: 'Central Line Placement',
                    description: 'Patient requires central venous access for resuscitation.',
                    essential: ['cl-insertion-tray-1', 'triple-lumen-cl', 'chloraprep', 'betadine-bottle'],
                    optional: ['or-towels', 'us-gel', 'us-probe-cover']
                },
                {
                    id: 's3',
                    name: 'Chest Tube Insertion',
                    description: 'Patient with pneumothorax requiring chest tube placement.',
                    essential: ['chest-tube', 'chest-tube-tray', 'pleur-evac', 'betadine-bottle'],
                    optional: ['or-towels', 'chloraprep', 'gauze-bandage-roll']
                },
                {
                    id: 's4',
                    name: 'Arterial Line Placement',
                    description: 'Patient requires arterial line for hemodynamic monitoring.',
                    essential: ['arterial-line-kit', 'arrow-radial-cath', 'chloraprep', 'us-gel'],
                    optional: ['us-probe-cover', 'tegaderm-4x4', 'gauze-bandage-roll']
                }
            ]
        };

        // Achievements definition
        const achievements = [
            { id: 'first-scenario', title: 'First Steps', description: 'Complete your first scenario', icon: 'üéØ' },
            { id: 'perfect-score', title: 'Perfectionist', description: 'Get a perfect score on any scenario', icon: 'üíØ' },
            { id: 'speed-demon', title: 'Speed Demon', description: 'Complete a scenario in under 30 seconds', icon: '‚ö°' },
            { id: 'efficient', title: 'Efficiency Expert', description: 'Perfect score with no extra items', icon: 'üéØ' },
            { id: 'three-scenarios', title: 'Getting the Hang of It', description: 'Complete 3 scenarios', icon: 'üî•' },
            { id: 'all-scenarios', title: 'Master Trainer', description: 'Complete all scenarios', icon: 'üèÜ' }
        ];

        // ===== STATE =====
        const state = {
            currentScenario: null,
            currentScenarioIndex: 0,
            scenariosUnlocked: 1,
            inventory: [],
            startTime: null,
            sessionId: Date.now(),
            selectedCart: null,
            selectedDrawer: null,
            selectedItems: [],
            hasSubmittedOnce: false,
            tutorialCompleted: false,
            completedScenarios: [],
            achievements: [],
            points: 0,
            totalPoints: 0,
            soundEnabled: true,
            hapticEnabled: true,
            sessionResults: []
        };

        // ===== RESEARCH DATA TRACKING MODULE =====
        const ResearchData = {
            // Research state
            participantId: null,
            currentSessionId: null,
            sessionStartTime: null,
            scenarioStartTime: null,
            scenarioAttemptCounter: {},
            drawerOpenCounter: {},
            itemViewedTracker: {},

            // Data storage
            participants: {},
            sessions: [],
            events: [],
            outcomes: [],

            // Helper: Generate unique IDs
            generateSessionId() {
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0].replace(/-/g, '');
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '');
                const random = Math.random().toString(36).substring(2, 6);
                return `S_${dateStr}_${timeStr}_${random}`;
            },

            generateEventId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 5);
                return `E_${timestamp}_${random}`;
            },

            generateOutcomeId() {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substring(2, 5);
                return `O_${timestamp}_${random}`;
            },

            // Get elapsed time since scenario start
            getElapsedTime() {
                return this.scenarioStartTime ?
                    (Date.now() - this.scenarioStartTime) / 1000 : 0;
            },

            // Get attempt number for a scenario
            getAttemptNumber(scenarioId) {
                if (!this.scenarioAttemptCounter[scenarioId]) {
                    this.scenarioAttemptCounter[scenarioId] = 0;
                }
                return this.scenarioAttemptCounter[scenarioId] + 1;
            },

            // Initialize or enroll participant
            enrollParticipant(participantData) {
                this.participantId = participantData.participant_id;
                this.participants[this.participantId] = {
                    participant_id: participantData.participant_id,
                    enrollment_date: new Date().toISOString().split('T')[0],
                    training_level: participantData.training_level || 'unknown',
                    prior_em_months: participantData.prior_em_months || 0,
                    prior_trauma_level: participantData.prior_trauma_level || 'unknown',
                    fellowship_type: participantData.fellowship_type || 'none',
                    medical_degree: participantData.medical_degree || 'unknown',
                    gender: participantData.gender || 'prefer_not_to_say',
                    age_range: participantData.age_range || 'prefer_not_to_say',
                    consent_version: '1.0',
                    consent_date: new Date().toISOString(),
                    study_completion_date: null,
                    notes: participantData.notes || ''
                };
                this.saveResearchData();
                return this.participantId;
            },

            // Start a new session
            startSession() {
                this.currentSessionId = this.generateSessionId();
                this.sessionStartTime = Date.now();

                const session = {
                    session_id: this.currentSessionId,
                    participant_id: this.participantId || 'DEMO',
                    session_start: new Date().toISOString(),
                    session_end: null,
                    device_type: this.getDeviceType(),
                    browser: navigator.userAgent,
                    screen_width: window.innerWidth,
                    screen_height: window.innerHeight,
                    scenarios_attempted: [],
                    scenarios_completed: [],
                    total_session_time: 0,
                    app_version: '1.0.0'
                };

                this.sessions.push(session);
                this.recordEvent('app_opened');
                this.saveResearchData();
                return this.currentSessionId;
            },

            // End current session
            endSession() {
                if (!this.currentSessionId) return;

                const session = this.sessions.find(s => s.session_id === this.currentSessionId);
                if (session) {
                    session.session_end = new Date().toISOString();
                    session.total_session_time = Math.floor((Date.now() - this.sessionStartTime) / 1000);
                }

                this.recordEvent('session_ended');
                this.saveResearchData();
            },

            // Start a scenario
            startScenario(scenario) {
                this.scenarioStartTime = Date.now();
                this.drawerOpenCounter = {};
                this.itemViewedTracker = {};

                const session = this.sessions.find(s => s.session_id === this.currentSessionId);
                if (session && !session.scenarios_attempted.includes(scenario.id)) {
                    session.scenarios_attempted.push(scenario.id);
                }

                this.recordEvent('scenario_started', {
                    scenario_id: scenario.id,
                    scenario_name: scenario.name,
                    attempt_number: this.getAttemptNumber(scenario.id)
                });
            },

            // Record an event
            recordEvent(eventType, additionalData = {}) {
                const event = {
                    event_id: this.generateEventId(),
                    session_id: this.currentSessionId || 'NO_SESSION',
                    participant_id: this.participantId || 'DEMO',
                    timestamp: new Date().toISOString(),
                    scenario_id: state.currentScenario?.id || null,
                    scenario_attempt: state.currentScenario ?
                        this.getAttemptNumber(state.currentScenario.id) : null,
                    elapsed_time: this.getElapsedTime(),
                    event_type: eventType,
                    event_category: this.categorizeEvent(eventType),
                    cart_id: additionalData.cart_id || null,
                    drawer_id: additionalData.drawer_id || null,
                    item_id: additionalData.item_id || null,
                    is_essential: additionalData.is_essential || false,
                    is_optional: additionalData.is_optional || false,
                    is_incorrect: additionalData.is_incorrect || false,
                    in_inventory: additionalData.in_inventory || false,
                    current_inventory_count: state.inventory.length,
                    essential_collected: this.countEssentialCollected(),
                    optional_collected: this.countOptionalCollected(),
                    incorrect_collected: this.countIncorrectCollected(),
                    metadata: additionalData.metadata || {}
                };

                this.events.push(event);

                // Save periodically (every 10 events)
                if (this.events.length % 10 === 0) {
                    this.saveResearchData();
                }
            },

            // Categorize event type
            categorizeEvent(eventType) {
                const categories = {
                    navigation: ['app_opened', 'scenario_selected', 'scenario_started', 'cart_opened',
                                'drawer_opened', 'drawer_closed', 'cart_closed', 'inventory_opened',
                                'inventory_closed'],
                    selection: ['item_selected', 'item_deselected', 'items_collected', 'item_removed'],
                    submission: ['submit_attempted', 'submit_confirmed', 'retry_clicked', 'next_clicked'],
                    outcome: ['scenario_completed', 'scenario_abandoned', 'feedback_viewed', 'session_ended']
                };

                for (const [category, events] of Object.entries(categories)) {
                    if (events.includes(eventType)) return category;
                }
                return 'other';
            },

            // Count items in inventory
            countEssentialCollected() {
                if (!state.currentScenario) return 0;
                return state.inventory.filter(item =>
                    state.currentScenario.essential.includes(item.id)
                ).length;
            },

            countOptionalCollected() {
                if (!state.currentScenario) return 0;
                return state.inventory.filter(item =>
                    state.currentScenario.optional.includes(item.id)
                ).length;
            },

            countIncorrectCollected() {
                if (!state.currentScenario) return 0;
                return state.inventory.filter(item =>
                    !state.currentScenario.essential.includes(item.id) &&
                    !state.currentScenario.optional.includes(item.id)
                ).length;
            },

            // Record scenario outcome
            recordOutcome(scenario, scoreData) {
                const attemptNumber = this.getAttemptNumber(scenario.id);
                this.scenarioAttemptCounter[scenario.id] = attemptNumber;

                const session = this.sessions.find(s => s.session_id === this.currentSessionId);
                if (session && !session.scenarios_completed.includes(scenario.id)) {
                    session.scenarios_completed.push(scenario.id);
                }

                // Calculate efficiency metrics
                const uniqueCartsOpened = new Set(
                    this.events
                        .filter(e => e.scenario_id === scenario.id &&
                                   e.scenario_attempt === attemptNumber &&
                                   e.event_type === 'cart_opened')
                        .map(e => e.cart_id)
                ).size;

                const uniqueDrawersOpened = new Set(
                    this.events
                        .filter(e => e.scenario_id === scenario.id &&
                                   e.scenario_attempt === attemptNumber &&
                                   e.event_type === 'drawer_opened')
                        .map(e => e.drawer_id)
                ).size;

                const totalDrawerOpens = this.events.filter(e =>
                    e.scenario_id === scenario.id &&
                    e.scenario_attempt === attemptNumber &&
                    e.event_type === 'drawer_opened'
                ).length;

                const totalItemsViewed = new Set(
                    this.events
                        .filter(e => e.scenario_id === scenario.id &&
                                   e.scenario_attempt === attemptNumber &&
                                   e.item_id)
                        .map(e => e.item_id)
                ).size;

                const outcome = {
                    outcome_id: this.generateOutcomeId(),
                    session_id: this.currentSessionId || 'NO_SESSION',
                    participant_id: this.participantId || 'DEMO',
                    scenario_id: scenario.id,
                    scenario_name: scenario.name,
                    attempt_number: attemptNumber,
                    attempt_within_session: session ?
                        session.scenarios_attempted.filter(id => id === scenario.id).length : 1,

                    // Timing
                    start_time: new Date(Date.now() - scoreData.timeElapsed * 1000).toISOString(),
                    end_time: new Date().toISOString(),
                    total_time_seconds: scoreData.timeElapsed,

                    // Performance
                    final_score: scoreData.totalScore,
                    stars_earned: scoreData.stars,

                    // Item accuracy
                    essential_total: scenario.essential.length,
                    essential_collected: scoreData.foundEssential.length,
                    essential_missed: scoreData.missingEssential.length,
                    essential_missed_list: scoreData.missingEssential,

                    optional_total: scenario.optional.length,
                    optional_collected: scoreData.foundOptional.length,
                    optional_missed: scoreData.missingOptional.length,
                    optional_missed_list: scoreData.missingOptional,

                    incorrect_collected: scoreData.extra.length,
                    incorrect_list: scoreData.extra,

                    total_items_collected: state.inventory.length,

                    // Efficiency metrics
                    unique_carts_opened: uniqueCartsOpened,
                    unique_drawers_opened: uniqueDrawersOpened,
                    total_drawer_opens: totalDrawerOpens,
                    total_items_viewed: totalItemsViewed,

                    navigation_efficiency: uniqueDrawersOpened > 0 ?
                        (uniqueDrawersOpened / totalDrawerOpens) : 0,
                    selection_efficiency: state.inventory.length > 0 ?
                        ((scoreData.foundEssential.length + scoreData.foundOptional.length) / state.inventory.length) : 0,

                    // Outcome
                    completion_status: 'completed',
                    retry_after_feedback: false,
                    next_scenario: null,

                    // Calculated metrics
                    time_per_item: state.inventory.length > 0 ?
                        (scoreData.timeElapsed / state.inventory.length) : 0,
                    accuracy_rate: scenario.essential.length > 0 ?
                        (scoreData.foundEssential.length / scenario.essential.length) : 0,
                    precision: state.inventory.length > 0 ?
                        ((scoreData.foundEssential.length + scoreData.foundOptional.length) / state.inventory.length) : 0,

                    // Learning indicators
                    previous_attempts_this_scenario: attemptNumber - 1,
                    previous_score_this_scenario: this.getPreviousScore(scenario.id),
                    improvement_from_previous: this.calculateImprovement(scenario.id, scoreData.totalScore)
                };

                this.outcomes.push(outcome);
                this.recordEvent('scenario_completed', {
                    scenario_id: scenario.id,
                    final_score: scoreData.totalScore,
                    stars: scoreData.stars
                });

                this.saveResearchData();
                return outcome;
            },

            // Get previous score for a scenario
            getPreviousScore(scenarioId) {
                const previousOutcomes = this.outcomes.filter(o =>
                    o.scenario_id === scenarioId &&
                    o.participant_id === (this.participantId || 'DEMO')
                );
                return previousOutcomes.length > 0 ?
                    previousOutcomes[previousOutcomes.length - 1].final_score : null;
            },

            // Calculate improvement from previous attempt
            calculateImprovement(scenarioId, currentScore) {
                const previousScore = this.getPreviousScore(scenarioId);
                return previousScore !== null ? (currentScore - previousScore) : null;
            },

            // Get device type
            getDeviceType() {
                const ua = navigator.userAgent;
                if (/(tablet|ipad|playbook|silk)|(android(?!.*mobi))/i.test(ua)) {
                    return 'tablet';
                }
                if (/Mobile|Android|iP(hone|od)|IEMobile|BlackBerry|Kindle|Silk-Accelerated|(hpw|web)OS|Opera M(obi|ini)/.test(ua)) {
                    return 'mobile';
                }
                return 'desktop';
            },

            // Save all research data to localStorage
            saveResearchData() {
                const researchData = {
                    participants: this.participants,
                    sessions: this.sessions,
                    events: this.events,
                    outcomes: this.outcomes,
                    participantId: this.participantId,
                    currentSessionId: this.currentSessionId,
                    scenarioAttemptCounter: this.scenarioAttemptCounter
                };
                localStorage.setItem('cabinetQuestResearch', JSON.stringify(researchData));
            },

            // Load research data from localStorage
            loadResearchData() {
                const saved = localStorage.getItem('cabinetQuestResearch');
                if (saved) {
                    const data = JSON.parse(saved);
                    this.participants = data.participants || {};
                    this.sessions = data.sessions || [];
                    this.events = data.events || [];
                    this.outcomes = data.outcomes || [];
                    this.participantId = data.participantId || null;
                    this.currentSessionId = data.currentSessionId || null;
                    this.scenarioAttemptCounter = data.scenarioAttemptCounter || {};
                }
            },

            // Export data as JSON
            exportJSON() {
                const data = {
                    export_date: new Date().toISOString(),
                    app_version: '1.0.0',
                    participant: this.participants[this.participantId] || null,
                    sessions: this.sessions.filter(s => s.participant_id === (this.participantId || 'DEMO')),
                    events: this.events.filter(e => e.participant_id === (this.participantId || 'DEMO')),
                    outcomes: this.outcomes.filter(o => o.participant_id === (this.participantId || 'DEMO'))
                };

                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `research_data_${this.participantId || 'DEMO'}_${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
            },

            // Export data as CSV
            exportCSV() {
                // Export participants
                this.exportParticipantsCSV();
                // Export outcomes
                this.exportOutcomesCSV();
                // Export events
                this.exportEventsCSV();
            },

            // Export participants as CSV
            exportParticipantsCSV() {
                const participant = this.participants[this.participantId];
                if (!participant) return;

                const headers = ['participant_id', 'enrollment_date', 'training_level', 'prior_em_months',
                               'prior_trauma_level', 'fellowship_type', 'medical_degree', 'gender',
                               'age_range', 'consent_version', 'consent_date'];
                const row = headers.map(h => participant[h] || '');
                const csv = [headers.join(','), row.join(',')].join('\n');

                this.downloadCSV(csv, `participant_${this.participantId}_${Date.now()}.csv`);
            },

            // Export outcomes as CSV
            exportOutcomesCSV() {
                const userOutcomes = this.outcomes.filter(o =>
                    o.participant_id === (this.participantId || 'DEMO')
                );

                if (userOutcomes.length === 0) return;

                const headers = ['outcome_id', 'participant_id', 'scenario_id', 'scenario_name',
                               'attempt_number', 'total_time_seconds', 'final_score', 'stars_earned',
                               'essential_collected', 'essential_missed', 'optional_collected',
                               'incorrect_collected', 'completion_status', 'accuracy_rate', 'precision'];
                const rows = userOutcomes.map(o => [
                    o.outcome_id, o.participant_id, o.scenario_id, o.scenario_name,
                    o.attempt_number, o.total_time_seconds, o.final_score, o.stars_earned,
                    o.essential_collected, o.essential_missed, o.optional_collected,
                    o.incorrect_collected, o.completion_status, o.accuracy_rate.toFixed(2),
                    o.precision.toFixed(2)
                ].join(','));

                const csv = [headers.join(','), ...rows].join('\n');
                this.downloadCSV(csv, `outcomes_${this.participantId || 'DEMO'}_${Date.now()}.csv`);
            },

            // Export events as CSV
            exportEventsCSV() {
                const userEvents = this.events.filter(e =>
                    e.participant_id === (this.participantId || 'DEMO')
                );

                if (userEvents.length === 0) return;

                const headers = ['event_id', 'participant_id', 'scenario_id', 'timestamp',
                               'elapsed_time', 'event_type', 'event_category', 'cart_id',
                               'drawer_id', 'item_id', 'is_essential', 'current_inventory_count'];
                const rows = userEvents.map(e => [
                    e.event_id, e.participant_id, e.scenario_id || '', e.timestamp,
                    e.elapsed_time.toFixed(2), e.event_type, e.event_category,
                    e.cart_id || '', e.drawer_id || '', e.item_id || '', e.is_essential,
                    e.current_inventory_count
                ].join(','));

                const csv = [headers.join(','), ...rows].join('\n');
                this.downloadCSV(csv, `events_${this.participantId || 'DEMO'}_${Date.now()}.csv`);
            },

            // Helper to download CSV
            downloadCSV(csvContent, filename) {
                const blob = new Blob([csvContent], {type: 'text/csv'});
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.click();
                URL.revokeObjectURL(url);
            },

            // Initialize research tracking
            init() {
                this.loadResearchData();

                // If no participant ID, prompt for one
                if (!this.participantId) {
                    const storedId = localStorage.getItem('participantId');
                    if (storedId) {
                        this.participantId = storedId;
                    }
                }

                // Start a new session
                this.startSession();
            }
        };

        // ===== CANVAS SETUP =====
        const canvas = document.getElementById('room-canvas');
        const ctx = canvas.getContext('2d');

        let canvasDPR = 1;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let lastTappedCart = null;
        let tapFeedbackTimeout = null;

        // Helper function to lighten colors
        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }

        function resizeCanvas() {
            canvasDPR = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvasWidth = rect.width;
            canvasHeight = rect.height;
            canvas.width = canvasWidth * canvasDPR;
            canvas.height = canvasHeight * canvasDPR;
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(canvasDPR, canvasDPR);
            drawRoom();
        }

        // Retro-styled cart drawing with visible drawers
        function drawCartWithDrawers(cart, x, y, size) {
            // Calculate actual drawer count for this cart
            const drawerCount = DATA.drawers.filter(d => d.cart === cart.id).length;
            const drawerHeight = size / Math.max(3, drawerCount * 0.75); // Adjust height based on drawer count

            // Calculate cabinet height based on drawer count
            const cabinetHeight = drawerCount * drawerHeight + 16; // Total height needed for all drawers plus padding

            // Cart frame/body - dark brown metal
            const frameGradient = ctx.createLinearGradient(x - size/2, y - size/2, x + size/2, y + size/2);
            frameGradient.addColorStop(0, '#4a3f2f');
            frameGradient.addColorStop(1, '#3d3426');
            ctx.fillStyle = frameGradient;
            ctx.fillRect(x - size/2, y - cabinetHeight/2 - 10, size, cabinetHeight + 20);

            // Frame border
            ctx.strokeStyle = '#2a2520';
            ctx.lineWidth = 3;
            ctx.strokeRect(x - size/2, y - cabinetHeight/2 - 10, size, cabinetHeight + 20);

            // Draw visible drawer fronts based on actual drawer count
            for (let i = 0; i < drawerCount; i++) {
                const drawerY = y - cabinetHeight/2 + (i * drawerHeight) + 8;
                
                // Drawer face with retro gradient
                const gradient = ctx.createLinearGradient(x - size/2, drawerY, x + size/2, drawerY);
                const lightColor = lightenColor(cart.color, 20);
                gradient.addColorStop(0, cart.color);
                gradient.addColorStop(0.5, lightColor);
                gradient.addColorStop(1, cart.color);
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x - size/2 + 8, drawerY, size - 16, drawerHeight - 8);
                
                // Chunky drawer border
                ctx.strokeStyle = 'rgba(0,0,0,0.5)';
                ctx.lineWidth = 3;
                ctx.strokeRect(x - size/2 + 8, drawerY, size - 16, drawerHeight - 8);
                
                // Inner highlight for depth
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x - size/2 + 10, drawerY + 2, size - 20, drawerHeight - 12);
                
                // Retro drawer handle (rectangular bar)
                const handleGradient = ctx.createLinearGradient(x, drawerY, x, drawerY + drawerHeight/2);
                handleGradient.addColorStop(0, '#5a4d38');
                handleGradient.addColorStop(1, '#3d3426');
                ctx.fillStyle = handleGradient;
                ctx.fillRect(x - size/4, drawerY + drawerHeight/2 - 4, size/2, 8);
                
                // Handle border
                ctx.strokeStyle = '#2a2520';
                ctx.lineWidth = 2;
                ctx.strokeRect(x - size/4, drawerY + drawerHeight/2 - 4, size/2, 8);
                
                // Handle highlight
                ctx.fillStyle = 'rgba(255,255,255,0.2)';
                ctx.fillRect(x - size/4, drawerY + drawerHeight/2 - 4, size/2, 2);
                
                // Drawer number
                ctx.fillStyle = '#2a2520';
                ctx.font = `bold ${size * 0.11}px "Courier New", monospace`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${i + 1}`, x, drawerY + drawerHeight/2);
            }
            
            // Cart wheels - chunky retro style
            ctx.fillStyle = '#2a2520';
            const wheelSize = size * 0.12;
            const wheelY = y + cabinetHeight/2 + 10;
            
            // Left wheel
            ctx.fillRect(x - size/3 - wheelSize/2, wheelY - wheelSize/2, wheelSize, wheelSize);
            ctx.strokeStyle = '#1a1510';
            ctx.lineWidth = 2;
            ctx.strokeRect(x - size/3 - wheelSize/2, wheelY - wheelSize/2, wheelSize, wheelSize);
            
            // Right wheel
            ctx.fillRect(x + size/3 - wheelSize/2, wheelY - wheelSize/2, wheelSize, wheelSize);
            ctx.strokeRect(x + size/3 - wheelSize/2, wheelY - wheelSize/2, wheelSize, wheelSize);
            
            // Wheel highlights
            ctx.fillStyle = 'rgba(255,255,255,0.2)';
            ctx.fillRect(x - size/3 - wheelSize/2 + 2, wheelY - wheelSize/2 + 2, wheelSize/2, wheelSize/2);
            ctx.fillRect(x + size/3 - wheelSize/2 + 2, wheelY - wheelSize/2 + 2, wheelSize/2, wheelSize/2);
            
            // Cart label at top - retro style
            ctx.fillStyle = '#2a2520';
            ctx.font = `bold ${size * 0.13}px "Courier New", monospace`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.shadowColor = 'rgba(245,230,211,0.5)';
            ctx.shadowBlur = 3;
            const words = cart.name.split(' ');
            ctx.fillText(words[0].toUpperCase(), x, y - cabinetHeight/2 - 14);
            ctx.shadowBlur = 0;
        }

        function drawRoom() {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            if (width === 0 || height === 0) {
                console.warn('Canvas dimensions not initialized, skipping draw');
                return;
            }

            canvasWidth = width;
            canvasHeight = height;
            ctx.clearRect(0, 0, width, height);

            // Draw carts and procedure table
            DATA.carts.forEach(cart => {
                const x = cart.x * width;
                const y = cart.y * height;
                const size = Math.min(width, height) * 0.22;

                const isTapped = lastTappedCart === cart.id;

                if (isTapped) {
                    ctx.shadowColor = 'rgba(212, 133, 14, 0.8)';
                    ctx.shadowBlur = 15;
                }

                if (cart.isInventory) {
                    // Special rendering for Procedure Table - retro table style (VERTICAL)
                    const tableWidth = size * 0.6;  // Swapped - now narrower
                    const tableHeight = size * 1.2; // Swapped - now taller

                    // Table legs - chunky wood style (adjusted for vertical orientation)
                    const legGradient = ctx.createLinearGradient(x, y, x, y + size * 0.3);
                    legGradient.addColorStop(0, '#5a4d38');
                    legGradient.addColorStop(1, '#3d3426');

                    const legWidth = size * 0.09;
                    const legHeight = size * 0.3;

                    ctx.fillStyle = legGradient;
                    // Front left leg
                    ctx.fillRect(x - tableWidth/2 + legWidth, y + tableHeight/2 - 5, legWidth, legHeight);
                    ctx.strokeStyle = '#2a2520';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(x - tableWidth/2 + legWidth, y + tableHeight/2 - 5, legWidth, legHeight);

                    // Front right leg
                    ctx.fillRect(x + tableWidth/2 - legWidth * 2, y + tableHeight/2 - 5, legWidth, legHeight);
                    ctx.strokeRect(x + tableWidth/2 - legWidth * 2, y + tableHeight/2 - 5, legWidth, legHeight);

                    // Back legs (slightly visible)
                    ctx.fillStyle = '#3d3426';
                    ctx.fillRect(x - tableWidth/2 + legWidth * 1.5, y - tableHeight/2 + 5, legWidth * 0.7, legHeight * 0.8);
                    ctx.fillRect(x + tableWidth/2 - legWidth * 2.2, y - tableHeight/2 + 5, legWidth * 0.7, legHeight * 0.8);
                    
                    // Table top - retro brown gradient
                    const topGradient = ctx.createLinearGradient(x - tableWidth/2, y - tableHeight/2, x + tableWidth/2, y + tableHeight/2);
                    topGradient.addColorStop(0, lightenColor(cart.color, 25));
                    topGradient.addColorStop(0.5, cart.color);
                    topGradient.addColorStop(1, lightenColor(cart.color, 15));
                    
                    ctx.fillStyle = topGradient;
                    ctx.fillRect(x - tableWidth/2, y - tableHeight/2, tableWidth, tableHeight);
                    
                    // Table top border
                    ctx.strokeStyle = '#3d3426';
                    ctx.lineWidth = 4;
                    ctx.strokeRect(x - tableWidth/2, y - tableHeight/2, tableWidth, tableHeight);
                    
                    // Highlight on top
                    ctx.strokeStyle = 'rgba(245,230,211,0.4)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.moveTo(x - tableWidth/2 + 3, y - tableHeight/2 + 3);
                    ctx.lineTo(x + tableWidth/2 - 3, y - tableHeight/2 + 3);
                    ctx.stroke();
                    
                    // Table label - retro typewriter style
                    ctx.fillStyle = '#2a2520';
                    ctx.font = `bold ${size * 0.14}px "Courier New", monospace`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(245,230,211,0.5)';
                    ctx.shadowBlur = 3;
                    ctx.fillText('PROCEDURE', x, y - size * 0.08);
                    ctx.fillText('TABLE', x, y + size * 0.08);
                    ctx.shadowBlur = 0;
                    
                    // Item count badge if items collected
                    if (state.inventory.length > 0) {
                        ctx.fillStyle = '#2a2520';
                        ctx.font = `bold ${size * 0.11}px "Courier New", monospace`;
                        ctx.fillText(`(${state.inventory.length} ITEMS)`, x, y + tableHeight/2 + legHeight + size * 0.12);
                    }
                } else {
                    // Draw retro cart with visible drawers
                    drawCartWithDrawers(cart, x, y, size);
                }

                ctx.shadowBlur = 0;
            });
        }

        function handleCanvasInteraction(e) {
            e.preventDefault();

            let clientX, clientY;
            if (e.type === 'touchstart' || e.type === 'touchend') {
                const touch = e.touches[0] || e.changedTouches[0];
                if (!touch) return;
                clientX = touch.clientX;
                clientY = touch.clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const rect = canvas.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const x = clientX - rect.left - scrollX;
            const y = clientY - rect.top - scrollY;
            const width = rect.width;
            const height = rect.height;

            let hitAnyCart = false;

            DATA.carts.forEach(cart => {
                const cartX = cart.x * width;
                const cartY = cart.y * height;
                const size = Math.min(width, height) * 0.22;

                // Calculate exact cart dimensions to match drawCartWithDrawers
                const drawerCount = DATA.drawers.filter(d => d.cart === cart.id).length;
                const drawerHeight = size / Math.max(3, drawerCount * 0.75);
                const cabinetHeight = drawerCount * drawerHeight + 16;
                const wheelSize = size * 0.12;
                const labelTextHeight = size * 0.13;

                // Calculate actual bounding box (pixel-perfect with rendered cart)
                const cartLeft = cartX - size / 2;
                const cartRight = cartX + size / 2;
                const cartTop = cartY - cabinetHeight / 2 - 14 - labelTextHeight;
                const cartBottom = cartY + cabinetHeight / 2 + 10 + wheelSize / 2;

                // Rectangular hit detection matching actual cart bounds
                if (x >= cartLeft && x <= cartRight && y >= cartTop && y <= cartBottom) {
                    hitAnyCart = true;
                    lastTappedCart = cart.id;
                    drawRoom();

                    clearTimeout(tapFeedbackTimeout);
                    tapFeedbackTimeout = setTimeout(() => {
                        lastTappedCart = null;
                        drawRoom();
                    }, 200);

                    openCart(cart);
                    playSound('click');
                    triggerHaptic('light');
                }
            });
        }

        canvas.addEventListener('click', handleCanvasInteraction);
        canvas.addEventListener('touchstart', handleCanvasInteraction, { passive: false });

        // [CONTINUING WITH THE REST OF THE JAVASCRIPT - THE SCRIPT IS IDENTICAL TO YOUR ORIGINAL]
        // I'll keep the rest of the JavaScript identical since only styling changed

        // ===== SCENARIOS =====
        function openScenariosModal() {
            loadScenarios();
            document.getElementById('scenarios-modal').classList.add('active');
            playSound('click');
        }

        function loadScenarios() {
            const list = document.getElementById('scenarios-list');
            list.innerHTML = '';
            
            DATA.scenarios.forEach((scenario, index) => {
                const div = document.createElement('div');
                div.className = 'scenario-item';
                
                const isCompleted = state.completedScenarios.includes(scenario.id);
                const isUnlocked = index < state.scenariosUnlocked;
                
                if (isCompleted) div.classList.add('completed');
                if (!isUnlocked) div.classList.add('locked');
                if (state.currentScenario?.id === scenario.id) div.classList.add('active');
                
                div.innerHTML = `
                    <h4>${scenario.name}</h4>
                    <p>${scenario.description}</p>
                `;
                
                if (isUnlocked) {
                    div.onclick = () => selectScenario(scenario, index);
                }
                
                list.appendChild(div);
            });
            
            updateProgressBadge();
        }

        function updateProgressBadge() {
            document.getElementById('progress-badge-modal').textContent = 
                `${state.completedScenarios.length}/${DATA.scenarios.length}`;
        }

        function selectScenario(scenario, index) {
            state.currentScenario = scenario;
            state.currentScenarioIndex = index;
            state.inventory = [];
            state.startTime = Date.now();
            state.hasSubmittedOnce = false;

            // Research tracking: Start scenario
            ResearchData.startScenario(scenario);

            document.getElementById('scenario-name').textContent = scenario.name;
            document.getElementById('task-description').textContent = scenario.description;

            // Show floating action bar and info button instead of scenario-description-box
            document.getElementById('floating-action-bar').style.display = 'flex';
            document.getElementById('scenario-info-btn').style.display = 'inline-block';
            document.getElementById('submit-btn-yellow').disabled = true;
            document.getElementById('restart-btn').style.display = 'inline-block';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('scenario-feedback').classList.remove('active', 'success', 'partial', 'error');
            document.getElementById('scenario-feedback').innerHTML = '';

            document.getElementById('room-hint').textContent = 'Tap a cart to open its drawers';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();

            closeModal('scenarios-modal');
            playSound('click');
        }

        function openScenarioDetailsModal() {
            if (!state.currentScenario) return;

            document.getElementById('scenario-details-name').textContent = state.currentScenario.name;
            document.getElementById('scenario-details-description').textContent = state.currentScenario.description;

            // Copy feedback content to modal if present
            const feedbackContent = document.getElementById('scenario-feedback').innerHTML;
            document.getElementById('scenario-details-feedback').innerHTML = feedbackContent;

            document.getElementById('scenario-details-modal').classList.add('active');
            playSound('click');
        }

        // ===== CART & DRAWER NAVIGATION =====
        function getDrawerIds(cart) {
            return DATA.drawers.filter(d => d.cart === cart.id).map(d => d.id);
        }

        function drawerHasEssentialItems(drawerId) {
            if (!state.currentScenario) return false;
            const drawerItems = DATA.items.filter(i => i.drawer === drawerId);
            return drawerItems.some(item => state.currentScenario.essential.includes(item.id));
        }

        function getDrawerItemCount(drawerId) {
            return DATA.items.filter(i => i.drawer === drawerId).length;
        }

        function openCart(cart) {
            if (!state.currentScenario) {
                alert('Please select a scenario first!');
                return;
            }

            if (cart.isInventory) {
                openInventoryModal();
                return;
            }

            state.selectedCart = cart;

            // Research tracking: Cart opened
            ResearchData.recordEvent('cart_opened', {
                cart_id: cart.id
            });
            document.getElementById('cart-modal-title').textContent = `${cart.name}`;

            const modalBody = document.getElementById('cart-modal-body');
            const drawers = DATA.drawers.filter(d => d.cart === cart.id);
            
            const lightColor = lightenColor(cart.color, 20);
            
            let html = '<div class="cart-visual-container">';
            html += `<div class="cart-label">${cart.name}</div>`;
            html += '<div class="cart-visual">';
            
            drawers.forEach(drawer => {
                const itemCount = getDrawerItemCount(drawer.id);
                const hasEssential = drawerHasEssentialItems(drawer.id);
                const essentialClass = hasEssential ? 'drawer-has-essential' : '';
                
                html += `
                    <div class="drawer-visual ${essentialClass}" 
                         data-drawer="${drawer.id}" 
                         onclick="openDrawer('${drawer.id}')"
                         style="--drawer-color: ${cart.color}; --drawer-color-light: ${lightColor}">
                        <div class="drawer-face">
                            <div class="drawer-label">
                                ${drawer.name}
                                <span class="drawer-item-count">${itemCount} items</span>
                            </div>
                            <div class="drawer-handle"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            modalBody.innerHTML = html;

            document.getElementById('cart-modal').classList.add('active');
            document.getElementById('room-hint').classList.add('hidden');
        }

        function openDrawer(drawerId) {
            const drawer = DATA.drawers.find(d => d.id === drawerId);
            if (!drawer) return;

            state.selectedDrawer = drawer;

            // Research tracking: Drawer opened
            ResearchData.recordEvent('drawer_opened', {
                drawer_id: drawerId,
                cart_id: state.selectedCart?.id
            });
            
            const drawerElement = document.querySelector(`[data-drawer="${drawerId}"]`);
            if (drawerElement) {
                drawerElement.style.transform = 'translateX(20px)';
                drawerElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                
                playSound('collect');
                
                setTimeout(() => {
                    drawerElement.style.transform = '';
                }, 300);
            }
            
            setTimeout(() => {
                showDrawerItems(drawer);
            }, 150);
        }

        function showDrawerItems(drawer) {
            document.getElementById('item-modal-title').textContent = `${drawer.name} - Select Items`;

            const itemGrid = document.getElementById('item-grid');
            itemGrid.innerHTML = '';

            const drawerItems = DATA.items.filter(i => i.drawer === drawer.id);
            drawerItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';

                if (state.inventory.find(i => i.id === item.id)) {
                    div.classList.add('in-inventory');
                }

                if (state.selectedItems.find(i => i.id === item.id)) {
                    div.classList.add('selected');
                }

                const iconDiv = document.createElement('div');
                iconDiv.className = 'item-icon';

                if (item.image) {
                    iconDiv.classList.add('loading');
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.name;

                    img.onload = () => {
                        iconDiv.classList.remove('loading');
                        iconDiv.textContent = '';
                        iconDiv.appendChild(img);
                    };

                    img.onerror = () => {
                        iconDiv.classList.remove('loading');
                        iconDiv.textContent = item.name.substring(0, 2).toUpperCase();
                    };
                } else {
                    iconDiv.textContent = item.name.substring(0, 2).toUpperCase();
                }

                const nameEl = document.createElement('h5');
                nameEl.textContent = item.name;

                div.appendChild(iconDiv);
                div.appendChild(nameEl);

                div.onclick = () => toggleItemSelection(item, div);
                itemGrid.appendChild(div);
            });

            closeModal('cart-modal');
            document.getElementById('item-modal').classList.add('active');
        }

        function toggleItemSelection(item, element) {
            const index = state.selectedItems.findIndex(i => i.id === item.id);
            const isSelected = index > -1;

            if (isSelected) {
                state.selectedItems.splice(index, 1);
                element.classList.remove('selected');
            } else {
                state.selectedItems.push(item);
                element.classList.add('selected');
            }

            // Research tracking: Item selection/deselection
            const inInventory = state.inventory.find(i => i.id === item.id) !== undefined;
            ResearchData.recordEvent(isSelected ? 'item_deselected' : 'item_selected', {
                item_id: item.id,
                drawer_id: state.selectedDrawer?.id,
                cart_id: state.selectedCart?.id,
                is_essential: state.currentScenario?.essential.includes(item.id) || false,
                is_optional: state.currentScenario?.optional.includes(item.id) || false,
                is_incorrect: !state.currentScenario?.essential.includes(item.id) &&
                             !state.currentScenario?.optional.includes(item.id),
                in_inventory: inInventory
            });

            playSound('click');
        }

        function collectSelectedItems() {
            if (state.selectedItems.length === 0) {
                alert('Please select at least one item!');
                return;
            }

            let itemsAdded = 0;
            state.selectedItems.forEach(item => {
                if (!state.inventory.find(i => i.id === item.id)) {
                    state.inventory.push({...item});
                    itemsAdded++;
                    playSound('collect');
                    triggerHaptic('light');

                    // Research tracking: Item collected
                    ResearchData.recordEvent('items_collected', {
                        item_id: item.id,
                        drawer_id: state.selectedDrawer?.id,
                        cart_id: state.selectedCart?.id,
                        is_essential: state.currentScenario?.essential.includes(item.id) || false,
                        is_optional: state.currentScenario?.optional.includes(item.id) || false,
                        is_incorrect: !state.currentScenario?.essential.includes(item.id) &&
                                     !state.currentScenario?.optional.includes(item.id)
                    });
                }
            });

            if (itemsAdded > 0) {
                showItemCollectedFeedback(itemsAdded);
            }

            state.selectedItems = [];
            updateInventoryDisplay();
            updateStats();

            if (state.selectedDrawer) {
                openDrawer(state.selectedDrawer.id);
            }
        }

        function showItemCollectedFeedback(count) {
            const toast = document.getElementById('item-collected-toast');
            const itemText = count === 1 ? '1 Item' : `${count} Items`;
            toast.textContent = `‚úì ${itemText} Added to Table!`;
            toast.classList.add('show');

            const statItems = document.getElementById('stat-items').parentElement;
            statItems.classList.add('stat-pulse');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 600);

            setTimeout(() => {
                statItems.classList.remove('stat-pulse');
            }, 400);

            drawRoom();
        }

        function backToCart() {
            closeModal('item-modal');
            if (state.selectedCart) {
                openCart(state.selectedCart);
            }
        }

        function openInventoryModal() {
            updateInventoryModalDisplay();
            document.getElementById('inventory-modal').classList.add('active');
            playSound('click');

            // Research tracking: Inventory opened
            ResearchData.recordEvent('inventory_opened');
        }

        function updateInventoryModalDisplay() {
            const container = document.getElementById('inventory-modal-items');
            document.getElementById('inventory-count').textContent = state.inventory.length;

            if (state.inventory.length === 0) {
                container.innerHTML = '<div class="procedure-table-empty">No items collected yet</div>';
            } else {
                container.innerHTML = '';
                state.inventory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'procedure-table-item';

                    let itemBadge = '';
                    if (state.currentScenario) {
                        if (state.currentScenario.essential.includes(item.id)) {
                            itemBadge = '<span class="item-badge badge-essential">Essential</span>';
                        } else if (state.currentScenario.optional.includes(item.id)) {
                            itemBadge = '<span class="item-badge badge-optional">Optional</span>';
                        }
                    }

                    div.innerHTML = `
                        <div class="procedure-table-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                        <div class="procedure-table-info">
                            <strong>${item.name}${itemBadge}</strong>
                            <small>${item.cart} ‚Üí ${item.drawer}</small>
                        </div>
                        <button class="procedure-table-remove" onclick="removeItemFromModal(${index})">‚úï</button>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function updateInventoryDisplay() {
            const submitBtn = document.getElementById('submit-btn-yellow');
            submitBtn.disabled = state.inventory.length === 0;
            drawRoom();
        }

        function removeItemFromModal(index) {
            const item = state.inventory[index];

            // Research tracking: Item removed
            ResearchData.recordEvent('item_removed', {
                item_id: item?.id,
                is_essential: state.currentScenario?.essential.includes(item?.id) || false,
                is_optional: state.currentScenario?.optional.includes(item?.id) || false
            });

            state.inventory.splice(index, 1);
            updateInventoryModalDisplay();
            updateInventoryDisplay();
            updateStats();
            playSound('click');
        }

        // ===== FEEDBACK & SCORING =====
        function submitInventory() {
            const scenario = state.currentScenario;
            if (!scenario) return;
            
            const collectedIds = state.inventory.map(i => i.id);
            const foundEssential = scenario.essential.filter(id => collectedIds.includes(id));
            const missingEssential = scenario.essential.filter(id => !collectedIds.includes(id));
            const foundOptional = scenario.optional.filter(id => collectedIds.includes(id));
            const missingOptional = scenario.optional.filter(id => !collectedIds.includes(id));
            const extra = collectedIds.filter(id =>
                !scenario.essential.includes(id) && !scenario.optional.includes(id));

            const timeElapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const allEssential = missingEssential.length === 0;
            const allRequired = allEssential && missingOptional.length === 0;
            const noExtras = extra.length === 0;

            const essentialScore = (foundEssential.length / scenario.essential.length) * 60;
            const optionalScore = scenario.optional.length > 0 ? 
                (foundOptional.length / scenario.optional.length) * 20 : 20;
            const penaltyScore = extra.length * 5;
            const totalScore = Math.max(0, Math.round(essentialScore + optionalScore - penaltyScore));

            let stars = 0;
            if (allRequired && noExtras && timeElapsed < 60) stars = 5;
            else if (allRequired && noExtras) stars = 4;
            else if (allRequired) stars = 3;
            else if (allEssential) stars = 2;
            else if (foundEssential.length > 0) stars = 1;

            let feedbackClass, feedbackTitle, feedbackMessage;
            let bonusPoints = 0;

            if (allRequired) {
                feedbackClass = 'success';
                feedbackTitle = '‚úì Perfect!';
                feedbackMessage = 'You collected all required items correctly!';
                bonusPoints = 500;
                playSound('success');
                triggerHaptic('heavy');
            } else if (allEssential) {
                feedbackClass = 'partial';
                feedbackTitle = '‚ö† Good, but incomplete';
                feedbackMessage = 'You got all essential items, but missed some recommended ones.';
                bonusPoints = 200;
                playSound('success');
                triggerHaptic('medium');
            } else {
                feedbackClass = 'error';
                feedbackTitle = '‚úó Missing Critical Items';
                feedbackMessage = 'You are missing essential items for this procedure.';
                playSound('error');
                triggerHaptic('heavy');
            }

            if (timeElapsed < 60 && allEssential) {
                bonusPoints += 300;
                feedbackMessage += ' Amazing speed!';
            }

            if (bonusPoints > 0) {
                setTimeout(() => {
                    awardPoints(bonusPoints, 'Completion Bonus!');
                }, 500);
            }

            if (allEssential && !state.completedScenarios.includes(scenario.id)) {
                state.completedScenarios.push(scenario.id);
                saveUserProgress();
            }

            let starsHTML = '<div class="star-rating">';
            for (let i = 0; i < 5; i++) {
                starsHTML += `<span class="star ${i < stars ? 'filled' : ''}">‚òÖ</span>`;
            }
            starsHTML += '</div>';

            const essentialProgress = (foundEssential.length / scenario.essential.length) * 100;
            const optionalProgress = scenario.optional.length > 0 ? 
                (foundOptional.length / scenario.optional.length) * 100 : 0;

            let detailsHTML = '<div style="margin: 15px 0;">';
            detailsHTML += '<div style="margin-bottom: 10px;">';
            detailsHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
            detailsHTML += '<small><strong>Essential Items</strong></small>';
            detailsHTML += `<small>${foundEssential.length}/${scenario.essential.length}</small>`;
            detailsHTML += '</div>';
            detailsHTML += '<div class="progress-container">';
            detailsHTML += `<div class="progress-bar" style="width: ${essentialProgress}%"></div>`;
            detailsHTML += '</div>';
            detailsHTML += '</div>';

            if (scenario.optional.length > 0) {
                detailsHTML += '<div style="margin-bottom: 10px;">';
                detailsHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
                detailsHTML += '<small><strong>Optional Items</strong></small>';
                detailsHTML += `<small>${foundOptional.length}/${scenario.optional.length}</small>`;
                detailsHTML += '</div>';
                detailsHTML += '<div class="progress-container">';
                detailsHTML += `<div class="progress-bar" style="width: ${optionalProgress}%"></div>`;
                detailsHTML += '</div>';
                detailsHTML += '</div>';
            }
            detailsHTML += '</div>';

            let missedItemsHTML = '';

            if (missingEssential.length > 0) {
                missedItemsHTML += '<div class="missed-items-section">';
                missedItemsHTML += '<h4>‚ùå Missing Essential Items</h4>';
                missedItemsHTML += '<div class="missed-items-list">';
                missingEssential.forEach(itemId => {
                    const item = DATA.items.find(i => i.id === itemId);
                    if (item) {
                        missedItemsHTML += `
                            <div class="missed-item">
                                <div class="missed-item-icon essential">${item.name.substring(0, 2).toUpperCase()}</div>
                                <div class="missed-item-info">
                                    <strong>${item.name}</strong>
                                    <small>Location: ${item.cart} ‚Üí ${item.drawer}</small>
                                </div>
                            </div>
                        `;
                    }
                });
                missedItemsHTML += '</div></div>';
            }

            if (missingOptional.length > 0) {
                missedItemsHTML += '<div class="missed-items-section">';
                missedItemsHTML += '<h4>‚ö†Ô∏è Missing Optional Items</h4>';
                missedItemsHTML += '<div class="missed-items-list">';
                missingOptional.forEach(itemId => {
                    const item = DATA.items.find(i => i.id === itemId);
                    if (item) {
                        missedItemsHTML += `
                            <div class="missed-item">
                                <div class="missed-item-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                                <div class="missed-item-info">
                                    <strong>${item.name}</strong>
                                    <small>Location: ${item.cart} ‚Üí ${item.drawer}</small>
                                </div>
                            </div>
                        `;
                    }
                });
                missedItemsHTML += '</div></div>';
            }

            const feedbackModalTitle = document.getElementById('feedback-modal-title');
            const feedbackModalBody = document.getElementById('feedback-modal-body');

            feedbackModalTitle.textContent = feedbackTitle;
            feedbackModalBody.innerHTML = `
                ${starsHTML}
                <div style="text-align: center; margin: 15px 0;">
                    <p style="font-size: 15px; color: #5a4d38; margin-bottom: 10px;">${feedbackMessage}</p>
                    <p style="font-size: 18px; font-weight: bold; color: #3d3426;">
                        Score: ${totalScore}/100
                    </p>
                    <p style="font-size: 14px; color: #6b5d47; margin-top: 5px;">
                        ‚è±Ô∏è Time: ${formatTime(timeElapsed)}
                    </p>
                </div>
                ${detailsHTML}
                ${missedItemsHTML}
            `;

            const feedbackModalFooter = document.getElementById('feedback-modal-footer');
            let footerButtons = '<button class="btn-secondary" onclick="closeModal(\'feedback-modal\')">Close</button>';
            footerButtons += '<button class="btn-primary restart-btn" onclick="closeModal(\'feedback-modal\'); retryScenario()">üîÑ Try Again</button>';

            if (state.currentScenarioIndex < DATA.scenarios.length - 1) {
                footerButtons += '<button class="btn-primary advance-btn" onclick="closeModal(\'feedback-modal\'); continueToNext()">‚Üí Next Scenario</button>';
            } else {
                footerButtons += '<button class="btn-primary advance-btn" onclick="closeModal(\'feedback-modal\'); continueToNext()">üéâ Complete Training</button>';
            }

            feedbackModalFooter.innerHTML = footerButtons;

            document.getElementById('feedback-modal').classList.add('active');

            state.hasSubmittedOnce = true;

            state.sessionResults.push({
                scenarioName: scenario.name,
                score: totalScore,
                stars: stars,
                timeElapsed: timeElapsed,
                timestamp: new Date().toISOString(),
                feedbackClass: feedbackClass
            });

            // Research tracking: Record outcome
            ResearchData.recordEvent('submit_confirmed');
            ResearchData.recordEvent('feedback_viewed');
            ResearchData.recordOutcome(scenario, {
                totalScore: totalScore,
                stars: stars,
                timeElapsed: timeElapsed,
                foundEssential: foundEssential,
                missingEssential: missingEssential,
                foundOptional: foundOptional,
                missingOptional: missingOptional,
                extra: extra
            });

            setTimeout(() => {
                if (state.completedScenarios.length === 1) {
                    checkAchievement('first-scenario');
                }
                if (allRequired) {
                    checkAchievement('perfect-score');
                }
                if (allRequired && timeElapsed < 30) {
                    checkAchievement('speed-demon');
                }
                if (allRequired && noExtras) {
                    checkAchievement('efficient');
                }
                if (state.completedScenarios.length >= 3) {
                    checkAchievement('three-scenarios');
                }
                if (state.completedScenarios.length === DATA.scenarios.length) {
                    checkAchievement('all-scenarios');
                }
            }, 800);

            saveAnalytics({
                sessionId: state.sessionId,
                scenarioId: scenario.id,
                scenarioName: scenario.name,
                timestamp: new Date().toISOString(),
                timeElapsed: timeElapsed,
                itemsCollected: collectedIds,
                foundEssential: foundEssential,
                missingEssential: missingEssential,
                foundOptional: foundOptional,
                extra: extra,
                correct: allRequired,
                score: totalScore,
                stars: stars,
                pointsEarned: state.points,
                totalPoints: state.totalPoints,
                achievements: state.achievements.length
            });
            
            loadScenarios();
        }

        function retryScenario() {
            state.inventory = [];
            state.startTime = Date.now();
            state.hasSubmittedOnce = false;

            document.getElementById('scenario-feedback').classList.remove('active', 'success', 'partial', 'error');
            document.getElementById('scenario-feedback').innerHTML = '';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('room-hint').textContent = 'Tap a cart to open its drawers';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();
            playSound('click');
        }

        function continueToNext() {
            if (state.currentScenarioIndex === DATA.scenarios.length - 1) {
                completeTraining();
                return;
            }

            state.currentScenarioIndex++;

            if (state.currentScenarioIndex >= state.scenariosUnlocked) {
                state.scenariosUnlocked = state.currentScenarioIndex + 1;
            }

            state.inventory = [];
            state.currentScenario = null;
            state.startTime = null;
            state.hasSubmittedOnce = false;

            // Hide floating action bar and info button
            document.getElementById('floating-action-bar').style.display = 'none';
            document.getElementById('scenario-info-btn').style.display = 'none';
            document.getElementById('scenario-feedback').classList.remove('active', 'success', 'partial', 'error');
            document.getElementById('scenario-feedback').innerHTML = '';
            document.getElementById('restart-btn').style.display = 'none';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('scenario-name').textContent = 'Select the next scenario';
            document.getElementById('room-hint').textContent = 'Open Scenarios menu to begin next scenario';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();
            updateProgressBadge();

            openScenariosModal();
            playSound('click');
        }

        function completeTraining() {
            alert(`üéâ Training Complete!\n\nCongratulations! You've completed all training scenarios.\n\nTotal Points Earned: ${state.totalPoints} pts\nAchievements Unlocked: ${state.achievements.length}/${achievements.length}`);

            state.currentScenarioIndex = 0;
            state.scenariosUnlocked = 1;
            state.inventory = [];
            state.currentScenario = null;
            state.startTime = null;
            state.hasSubmittedOnce = false;
            state.completedScenarios = [];

            // Hide floating action bar and info button
            document.getElementById('floating-action-bar').style.display = 'none';
            document.getElementById('scenario-info-btn').style.display = 'none';
            document.getElementById('scenario-feedback').classList.remove('active');
            document.getElementById('scenario-feedback').innerHTML = '';
            document.getElementById('restart-btn').style.display = 'none';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('scenario-name').textContent = 'Select a scenario to begin';
            document.getElementById('room-hint').textContent = 'Open Scenarios menu to begin training';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();
            updateProgressBadge();
            
            saveUserProgress();
            playSound('success');
        }

        function awardPoints(points, message) {
            state.points += points;
            state.totalPoints += points;
            
            const pointsAward = document.getElementById('points-award');
            pointsAward.textContent = `+${points} ${message}`;
            pointsAward.classList.add('show');
            
            setTimeout(() => {
                pointsAward.classList.remove('show');
            }, 2000);
            
            saveUserProgress();
        }

        function checkAchievement(achievementId) {
            if (state.achievements.includes(achievementId)) return;
            
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement) return;
            
            unlockAchievement(achievement);
        }

        function unlockAchievement(achievement) {
            state.achievements.push(achievement.id);
            
            const toast = document.getElementById('achievement-toast');
            document.getElementById('achievement-title').textContent = `${achievement.icon} ${achievement.title}`;
            document.getElementById('achievement-desc').textContent = achievement.description;
            toast.classList.add('show');
            
            playSound('success');
            triggerHaptic('heavy');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
            
            awardPoints(100, 'Achievement!');
            
            saveUserProgress();
        }

        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('AudioContext not supported');
                    return null;
                }
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            return audioContext;
        }

        const sounds = {
            click: () => playTone(800, 0.1, 0.05),
            collect: () => playTone(1200, 0.15, 0.1),
            success: () => {
                playTone(800, 0.1, 0.1);
                setTimeout(() => playTone(1000, 0.1, 0.1), 100);
                setTimeout(() => playTone(1200, 0.2, 0.15), 200);
            },
            error: () => {
                playTone(400, 0.15, 0.1);
                setTimeout(() => playTone(300, 0.2, 0.1), 150);
            }
        };

        function playSound(soundName) {
            if (!state.soundEnabled) return;
            if (sounds[soundName]) {
                sounds[soundName]();
            }
        }

        function playTone(frequency, duration, volume = 0.1) {
            const ctx = getAudioContext();
            if (!ctx) return;

            try {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(volume, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
                console.warn('Error playing tone:', e);
            }
        }

        function triggerHaptic(intensity) {
            if (!state.hapticEnabled) return;
            if (navigator.vibrate) {
                const patterns = {
                    light: [10],
                    medium: [20],
                    heavy: [30, 10, 30]
                };
                navigator.vibrate(patterns[intensity] || [10]);
            }
        }

        function openSettingsModal() {
            document.getElementById('settings-modal').classList.add('active');
            document.getElementById('sound-toggle').checked = state.soundEnabled;
            document.getElementById('haptic-toggle').checked = state.hapticEnabled;

            updateParticipantDisplay();
            updateResultsList();
        }

        function updateResultsList() {
            const resultsList = document.getElementById('results-list');
            
            if (state.sessionResults.length === 0) {
                resultsList.innerHTML = '<div class="procedure-table-empty">No results yet. Complete a scenario to see your performance!</div>';
            } else {
                resultsList.innerHTML = '';
                state.sessionResults.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    
                    let starsDisplay = '';
                    for (let i = 0; i < 5; i++) {
                        starsDisplay += i < result.stars ? '‚≠ê' : '‚òÜ';
                    }
                    
                    div.innerHTML = `
                        <h4>${result.scenarioName}</h4>
                        <p>Score: <strong>${result.score}/100</strong> | ${starsDisplay}</p>
                        <p>Time: ${formatTime(result.timeElapsed)}</p>
                        <p style="font-size: 10px; color: #8b7d6a;">${new Date(result.timestamp).toLocaleString()}</p>
                    `;
                    resultsList.appendChild(div);
                });
            }
        }

        function toggleSound() {
            state.soundEnabled = document.getElementById('sound-toggle').checked;
            saveUserProgress();
            playSound('click');
        }

        function toggleHaptic() {
            state.hapticEnabled = document.getElementById('haptic-toggle').checked;
            saveUserProgress();
        }

        function resetProgress() {
            if (!confirm('Are you sure you want to reset ALL progress? This cannot be undone!')) {
                return;
            }

            localStorage.removeItem('cabinetQuestProgress');
            localStorage.removeItem('analytics');
            localStorage.removeItem('cabinetQuestResearch');
            localStorage.removeItem('participantId');
            location.reload();
        }

        // ===== RESEARCH DATA FUNCTIONS =====

        function openEnrollmentModal() {
            // Pre-fill if already enrolled
            if (ResearchData.participantId && ResearchData.participants[ResearchData.participantId]) {
                const participant = ResearchData.participants[ResearchData.participantId];
                document.getElementById('participant-id-input').value = participant.participant_id;
                document.getElementById('training-level-input').value = participant.training_level;
                document.getElementById('prior-em-months-input').value = participant.prior_em_months;
                document.getElementById('prior-trauma-input').value = participant.prior_trauma_level;
                document.getElementById('fellowship-type-input').value = participant.fellowship_type;
                document.getElementById('medical-degree-input').value = participant.medical_degree;
                document.getElementById('gender-input').value = participant.gender;
                document.getElementById('age-range-input').value = participant.age_range;
            }

            document.getElementById('enrollment-modal').classList.add('active');
        }

        function submitEnrollment() {
            const participantId = document.getElementById('participant-id-input').value.trim();
            const trainingLevel = document.getElementById('training-level-input').value;

            if (!participantId) {
                alert('Please enter a Participant ID');
                return;
            }

            if (!trainingLevel) {
                alert('Please select a Training Level');
                return;
            }

            const participantData = {
                participant_id: participantId,
                training_level: trainingLevel,
                prior_em_months: parseInt(document.getElementById('prior-em-months-input').value) || 0,
                prior_trauma_level: document.getElementById('prior-trauma-input').value,
                fellowship_type: document.getElementById('fellowship-type-input').value,
                medical_degree: document.getElementById('medical-degree-input').value,
                gender: document.getElementById('gender-input').value,
                age_range: document.getElementById('age-range-input').value
            };

            ResearchData.enrollParticipant(participantData);
            localStorage.setItem('participantId', participantId);

            updateParticipantDisplay();
            closeModal('enrollment-modal');
            playSound('success');

            alert(`Thank you! You are now enrolled as participant ${participantId}`);
        }

        function skipEnrollment() {
            ResearchData.participantId = 'DEMO';
            localStorage.setItem('participantId', 'DEMO');
            updateParticipantDisplay();
            closeModal('enrollment-modal');
            playSound('click');
        }

        function updateParticipantDisplay() {
            const displayElement = document.getElementById('participant-id-display');
            if (ResearchData.participantId) {
                displayElement.textContent = ResearchData.participantId;
                if (ResearchData.participantId === 'DEMO') {
                    displayElement.textContent += ' (Demo Mode)';
                }
            } else {
                displayElement.textContent = 'Not enrolled';
            }
        }

        function exportResearchJSON() {
            ResearchData.exportJSON();
            playSound('success');
            alert('Research data exported as JSON!');
        }

        function exportResearchCSV() {
            ResearchData.exportCSV();
            playSound('success');
            alert('Research data exported as CSV files!');
        }

        function updateStats() {
            if (state.startTime) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                document.getElementById('stat-time').textContent = formatTime(elapsed);
            }
            document.getElementById('stat-items').textContent = state.inventory.length;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        setInterval(() => {
            if (state.startTime) updateStats();
        }, 1000);

        function saveUserProgress() {
            localStorage.setItem('cabinetQuestProgress', JSON.stringify({
                completedScenarios: state.completedScenarios,
                achievements: state.achievements,
                totalPoints: state.totalPoints,
                scenariosUnlocked: state.scenariosUnlocked,
                soundEnabled: state.soundEnabled,
                hapticEnabled: state.hapticEnabled,
                tutorialCompleted: state.tutorialCompleted
            }));
        }

        function loadUserProgress() {
            const saved = localStorage.getItem('cabinetQuestProgress');
            if (saved) {
                const data = JSON.parse(saved);
                state.completedScenarios = data.completedScenarios || [];
                state.achievements = data.achievements || [];
                state.totalPoints = data.totalPoints || 0;
                state.scenariosUnlocked = data.scenariosUnlocked || 1;
                state.soundEnabled = data.soundEnabled !== undefined ? data.soundEnabled : true;
                state.hapticEnabled = data.hapticEnabled !== undefined ? data.hapticEnabled : true;
                state.tutorialCompleted = data.tutorialCompleted || false;
            }
        }

        function saveAnalytics(data) {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            analytics.push(data);
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        function exportAnalytics() {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            const dataStr = JSON.stringify(analytics, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cabinet-quest-analytics-${Date.now()}.json`;
            link.click();
            playSound('click');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');

            // Research tracking: Modal closed events
            if (id === 'cart-modal') {
                ResearchData.recordEvent('cart_closed', {
                    cart_id: state.selectedCart?.id
                });
            } else if (id === 'item-modal') {
                ResearchData.recordEvent('drawer_closed', {
                    drawer_id: state.selectedDrawer?.id,
                    cart_id: state.selectedCart?.id
                });
            } else if (id === 'inventory-modal') {
                ResearchData.recordEvent('inventory_closed');
            }
        }

        let currentTutorialStep = 0;
        const totalTutorialSteps = 6;

        function initTutorial() {
            currentTutorialStep = 0;
            updateTutorialDisplay();
        }

        function updateTutorialDisplay() {
            const progressContainer = document.getElementById('tutorial-progress');
            progressContainer.innerHTML = '';
            for (let i = 0; i < totalTutorialSteps; i++) {
                const dot = document.createElement('div');
                dot.className = `tutorial-dot ${i === currentTutorialStep ? 'active' : ''}`;
                progressContainer.appendChild(dot);
            }

            const steps = document.querySelectorAll('.tutorial-step');
            steps.forEach((step, index) => {
                step.classList.toggle('active', index === currentTutorialStep);
            });

            const prevBtn = document.getElementById('tutorial-prev');
            const nextBtn = document.getElementById('tutorial-next');

            prevBtn.style.display = currentTutorialStep > 0 ? 'inline-block' : 'none';

            if (currentTutorialStep === totalTutorialSteps - 1) {
                nextBtn.textContent = 'üöÄ Start Training!';
                nextBtn.onclick = startTutorial;
            } else {
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = nextTutorialStep;
            }
        }

        function nextTutorialStep() {
            if (currentTutorialStep < totalTutorialSteps - 1) {
                currentTutorialStep++;
                updateTutorialDisplay();
                playSound('click');
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialDisplay();
                playSound('click');
            }
        }

        function startTutorial() {
            closeModal('tutorial-modal');
            openScenariosModal();
            playSound('click');
        }

        function init() {
            resizeCanvas();

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeCanvas, 100);
            });

            setTimeout(() => {
                requestAnimationFrame(resizeCanvas);
            }, 100);

            loadUserProgress();
            updateStats();

            // Initialize research data tracking
            ResearchData.init();
            updateParticipantDisplay();

            // Show enrollment modal if not enrolled
            if (!ResearchData.participantId) {
                setTimeout(() => {
                    openEnrollmentModal();
                }, 500);
            }

            initTutorial();
            document.getElementById('tutorial-modal').classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
