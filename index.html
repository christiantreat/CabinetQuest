<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trauma Room Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }

        /* Main Container - Full Screen */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Compact Header */
        .header {
            background: white;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 16px;
            color: #333;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }

        .scenario-name {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .stats-compact {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .stat-compact {
            color: #007bff;
            font-weight: bold;
        }

        .stat-compact .label {
            color: #999;
            font-weight: normal;
            margin-left: 2px;
        }

        /* Room View - Takes remaining space */
        .room-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }

        #room-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        /* Room Hint Overlay */
        .room-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 243, 205, 0.95);
            color: #856404;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
            z-index: 50;
        }

        .room-hint.hidden {
            display: none;
        }

        /* Bottom Drawer */
        /* ADJUSTMENT: Control drawer heights and animations here */
        .bottom-drawer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.15);
            transition: height 0.3s ease;  /* ADJUST: Change animation speed here */
            z-index: 200;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        /* ADJUSTMENT: Set specific heights for each drawer state */
        .bottom-drawer.peek {
            height: 80px;      /* ADJUST: Collapsed height */
        }

        .bottom-drawer.half {
            height: 50vh;      /* ADJUST: Medium height (50% of viewport) */
        }

        .bottom-drawer.full {
            height: 85vh;      /* ADJUST: Expanded height (85% of viewport) */
        }

        /* Drawer Handle */
        /* ADJUSTMENT: Make handle bigger/more visible here */
        .drawer-handle {
            width: 50px;           /* ADJUST: Increase width for easier grabbing */
            height: 5px;           /* ADJUST: Increase height for easier grabbing */
            background: #999;      /* ADJUST: Make darker to be more visible */
            border-radius: 3px;
            margin: 12px auto;
            cursor: grab;
            flex-shrink: 0;
        }

        .drawer-handle:active {
            cursor: grabbing;
            background: #666;      /* Darker when grabbed */
        }
        
        /* ADJUSTMENT: Make entire handle area tappable, not just the bar */
        .drawer-handle-area {
            padding: 15px 0;       /* ADJUST: Increase padding for larger touch area */
            cursor: grab;
            position: relative;
            touch-action: none;    /* Prevents default touch behaviors */
        }
        
        .drawer-handle-area:active {
            cursor: grabbing;
            background: rgba(0,0,0,0.03);
        }
        
        /* ADJUSTMENT: Optional hint text below handle - comment out to remove */
        .drawer-handle-area::after {
            content: 'Drag or tap';  /* ADJUST: Change hint text here */
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #999;
            pointer-events: none;
        }
        
        /* Hide hint when drawer is expanded */
        .bottom-drawer.full .drawer-handle-area::after,
        .bottom-drawer.half .drawer-handle-area::after {
            opacity: 0;
        }

        /* Drawer Tabs */
        .drawer-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            padding: 0 15px;
        }

        .drawer-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            touch-action: manipulation;
            position: relative;
        }

        .drawer-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .drawer-tab .badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #007bff;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Drawer Content */
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .drawer-pane {
            display: none;
        }

        .drawer-pane.active {
            display: block;
        }

        /* Scenario List */
        .scenario-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .scenario-item {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.2s;
        }

        .scenario-item:active {
            transform: scale(0.98);
        }

        .scenario-item.active {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .scenario-item h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .scenario-item p {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        /* Inventory */
        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .inventory-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-info strong {
            display: block;
            font-size: 13px;
            color: #333;
        }

        .item-info small {
            font-size: 11px;
            color: #666;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 13px;
        }

        .submit-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        .submit-btn:disabled {
            background: #ccc;
        }

        /* Feedback */
        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .feedback.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .feedback.partial {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .feedback.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .feedback h3 {
            margin-bottom: 8px;
            font-size: 15px;
        }

        .feedback ul {
            margin-left: 18px;
            margin-top: 8px;
            line-height: 1.5;
        }

        .feedback-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .feedback-actions button {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .modal-close {
            float: right;
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 16px;
            cursor: pointer;
        }

        .drawer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .drawer-item {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            cursor: pointer;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            touch-action: manipulation;
        }

        .drawer-item:active {
            transform: scale(0.98);
        }

        .drawer-item strong {
            display: block;
            margin-bottom: 4px;
            color: #333;
            font-size: 13px;
        }

        .drawer-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 4px;
        }

        .drawer-badge.empty {
            background: #ddd;
            color: #999;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .item-card {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            cursor: pointer;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            touch-action: manipulation;
        }

        .item-card:active {
            transform: scale(0.98);
        }

        .item-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .item-card .item-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            font-size: 14px;
        }

        .item-card strong {
            font-size: 12px;
            line-height: 1.2;
            color: #333;
        }

        .item-card small {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

        .add-items-btn {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Tutorial Overlay - Progressive Onboarding */
        .tutorial-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-content {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: tutorialSlideIn 0.4s ease-out;
        }

        @keyframes tutorialSlideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .tutorial-content h2 {
            color: #007bff;
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .tutorial-content p {
            color: #555;
            line-height: 1.6;
            margin-bottom: 15px;
            font-size: 14px;
        }

        .tutorial-content ul {
            margin: 15px 0;
            padding-left: 20px;
            color: #555;
            line-height: 1.8;
        }

        .tutorial-steps {
            display: flex;
            gap: 8px;
            justify-content: center;
            margin: 20px 0;
        }

        .tutorial-step-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
        }

        .tutorial-step-indicator.active {
            background: #007bff;
            width: 30px;
            border-radius: 5px;
        }

        .tutorial-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .tutorial-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tutorial-btn.primary {
            background: #007bff;
            color: white;
        }

        .tutorial-btn.primary:active {
            transform: scale(0.98);
            background: #0056b3;
        }

        .tutorial-btn.secondary {
            background: #f0f0f0;
            color: #666;
        }

        .tutorial-highlight {
            position: absolute;
            border: 3px solid #007bff;
            border-radius: 10px;
            box-shadow: 0 0 0 99999px rgba(0, 0, 0, 0.7);
            pointer-events: none;
            z-index: 1999;
            transition: all 0.4s ease;
        }

        /* Tooltip System */
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 500;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 200px;
            text-align: center;
        }

        .tooltip.visible {
            opacity: 1;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 5px solid #333;
        }

        /* Progress Bar for Scenarios */
        .progress-container {
            margin: 10px 0;
            background: #f0f0f0;
            border-radius: 10px;
            height: 20px;
            overflow: hidden;
            position: relative;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #00d4ff);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 11px;
            font-weight: bold;
        }

        /* Animation for item collection */
        @keyframes itemCollected {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.15);
                box-shadow: 0 0 20px rgba(40, 167, 69, 0.6);
            }
            100% {
                transform: scale(1);
            }
        }

        .item-collected-animation {
            animation: itemCollected 0.4s ease-out;
        }

        /* Pulse animation for hints */
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.05);
                opacity: 0.8;
            }
        }

        .pulse-hint {
            animation: pulse 2s infinite;
        }

        /* Points popup */
        .points-popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 40px;
            border-radius: 15px;
            font-size: 24px;
            font-weight: bold;
            z-index: 2500;
            opacity: 0;
            pointer-events: none;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }

        @keyframes popupShow {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -70%) scale(1);
            }
        }

        .points-popup.show {
            animation: popupShow 1.5s ease-out;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Compact Header -->
        <div class="header">
            <h1>Trauma Room Trainer</h1>
            <div class="header-info">
                <div class="scenario-name" id="scenario-name">Select a scenario below ↓</div>
                <div class="stats-compact">
                    <span class="stat-compact"><span id="stat-time">0:00</span> <span class="label">time</span></span>
                    <span class="stat-compact"><span id="stat-items">0</span> <span class="label">items</span></span>
                </div>
            </div>
        </div>

        <!-- Room View - Full Screen Background -->
        <div class="room-container">
            <div class="room-hint" id="room-hint">
                Select a scenario from the drawer below to begin
            </div>
            <canvas id="room-canvas"></canvas>
        </div>

        <!-- Bottom Drawer -->
        <div class="bottom-drawer peek" id="bottom-drawer">
            <!-- ADJUSTMENT: This entire area is draggable, not just the bar -->
            <div class="drawer-handle-area" id="drawer-handle-area">
                <div class="drawer-handle" id="drawer-handle"></div>
            </div>
            
            <div class="drawer-tabs">
                <div class="drawer-tab active" data-tab="scenarios">Scenarios</div>
                <div class="drawer-tab" data-tab="inventory">
                    Inventory
                    <span class="badge" id="inventory-badge">0</span>
                </div>
                <div class="drawer-tab" data-tab="stats">Stats</div>
                <div class="drawer-tab" data-tab="feedback">Results</div>
            </div>

            <div class="drawer-content">
                <!-- Scenarios Tab -->
                <div class="drawer-pane active" id="pane-scenarios">
                    <div class="scenario-list" id="scenario-list"></div>
                </div>

                <!-- Inventory Tab -->
                <div class="drawer-pane" id="pane-inventory">
                    <div class="inventory-list" id="inventory-list">
                        <div class="empty-state">Select a scenario and tap carts to collect items</div>
                    </div>
                    <button class="submit-btn" id="submit-btn" onclick="submitInventory()" disabled>
                        Submit for Feedback
                    </button>
                </div>

                <!-- Stats Tab -->
                <div class="drawer-pane" id="pane-stats">
                    <div id="stats-content">
                        <div class="empty-state">Loading your stats...</div>
                    </div>
                </div>

                <!-- Feedback Tab -->
                <div class="drawer-pane" id="pane-feedback">
                    <div id="feedback-content">
                        <div class="empty-state">Complete a scenario to see your results</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('cart-modal')">✕</button>
            <h2 id="cart-modal-title">Select Drawer</h2>
            <div class="drawer-grid" id="drawer-grid"></div>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="item-modal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('item-modal')">✕</button>
            <h2 id="item-modal-title">Select Items</h2>
            <div class="item-grid" id="item-grid"></div>
            <button class="add-items-btn" onclick="addSelectedItems()">Add to Inventory</button>
        </div>
    </div>

    <!-- Tutorial Overlay -->
    <div id="tutorial-overlay" class="tutorial-overlay">
        <div class="tutorial-content">
            <h2 id="tutorial-title"></h2>
            <div id="tutorial-body"></div>
            <div class="tutorial-steps" id="tutorial-steps"></div>
            <div class="tutorial-actions">
                <button class="tutorial-btn secondary" id="tutorial-skip" onclick="skipTutorial()">Skip</button>
                <button class="tutorial-btn primary" id="tutorial-next" onclick="nextTutorialStep()">Next</button>
            </div>
        </div>
    </div>

    <!-- Points Popup -->
    <div id="points-popup" class="points-popup"></div>

    <!-- Tooltip Container -->
    <div id="tooltip" class="tooltip"></div>

    <script src="data:text/javascript;base64,<?php echo base64_encode(file_get_contents('script.js')); ?>"></script>
    <script>
        // ===== DATA =====
        const DATA = {
            carts: [
                {
                    id: 'cart-1', name: 'Airway Cart', color: '#FF6B6B',
                    drawers: [
                        { id: 'd1', name: 'Drawer 1', items: ['item-1', 'item-2', 'item-3'] },
                        { id: 'd2', name: 'Drawer 2', items: ['item-11', 'item-12'] },
                        { id: 'd3', name: 'Drawer 3', items: [] },
                        { id: 'd4', name: 'Drawer 4', items: [] },
                        { id: 'd5', name: 'Drawer 5', items: [] },
                        { id: 'd6', name: 'Drawer 6', items: [] },
                        { id: 'd7', name: 'Drawer 7', items: [] },
                        { id: 'd8', name: 'Drawer 8', items: [] }
                    ]
                },
                {
                    id: 'cart-2', name: 'IV Line Cart', color: '#4ECDC4',
                    drawers: [
                        { id: 'd1', name: 'Drawer 1', items: ['item-6', 'item-7'] },
                        { id: 'd2', name: 'Drawer 2', items: ['item-8', 'item-9', 'item-10'] },
                        { id: 'd3', name: 'Drawer 3', items: ['item-4', 'item-5'] },
                        { id: 'd4', name: 'Drawer 4', items: [] },
                        { id: 'd5', name: 'Drawer 5', items: [] },
                        { id: 'd6', name: 'Drawer 6', items: [] },
                        { id: 'd7', name: 'Drawer 7', items: [] },
                        { id: 'd8', name: 'Drawer 8', items: [] }
                    ]
                },
                {
                    id: 'cart-3', name: 'Procedure Cart', color: '#95E1D3',
                    drawers: [
                        { id: 'd1', name: 'Drawer 1', items: ['item-13', 'item-14', 'item-15'] },
                        { id: 'd2', name: 'Drawer 2', items: [] },
                        { id: 'd3', name: 'Drawer 3', items: [] },
                        { id: 'd4', name: 'Drawer 4', items: [] },
                        { id: 'd5', name: 'Drawer 5', items: [] },
                        { id: 'd6', name: 'Drawer 6', items: [] },
                        { id: 'd7', name: 'Drawer 7', items: [] },
                        { id: 'd8', name: 'Drawer 8', items: [] }
                    ]
                }
            ],
            items: [
                { id: 'item-1', name: 'Gloves (Small)', category: 'PPE' },
                { id: 'item-2', name: 'Gloves (Medium)', category: 'PPE' },
                { id: 'item-3', name: 'Gloves (Large)', category: 'PPE' },
                { id: 'item-4', name: 'Chlorhexidine', category: 'Antiseptic' },
                { id: 'item-5', name: 'Sterile Drape', category: 'Sterile' },
                { id: 'item-6', name: 'Arterial Line Kit', category: 'Line Supplies' },
                { id: 'item-7', name: 'Pressure Transducer', category: 'Line Supplies' },
                { id: 'item-8', name: 'Lidocaine 1%', category: 'Medications' },
                { id: 'item-9', name: 'Syringes (5mL)', category: 'Supplies' },
                { id: 'item-10', name: 'Needles (25G)', category: 'Supplies' },
                { id: 'item-11', name: 'Gauze 4x4', category: 'Supplies' },
                { id: 'item-12', name: 'Tape (Silk)', category: 'Supplies' },
                { id: 'item-13', name: 'Chest Tube Tray', category: 'Procedure' },
                { id: 'item-14', name: 'Scalpel #10', category: 'Instruments' },
                { id: 'item-15', name: 'Hemostats', category: 'Instruments' }
            ],
            scenarios: [
                {
                    id: 'scenario-1',
                    name: 'Arterial Line Preparation',
                    description: 'Collect all supplies needed for arterial line placement',
                    essential: ['item-6', 'item-7', 'item-4', 'item-2'],
                    optional: ['item-5', 'item-8', 'item-9', 'item-10']
                },
                {
                    id: 'scenario-2',
                    name: 'Find Specific Items',
                    description: 'Locate: Gloves (M), Pressure Transducer, and Syringes',
                    essential: ['item-2', 'item-7', 'item-9'],
                    optional: []
                },
                {
                    id: 'scenario-3',
                    name: 'Chest Tube Setup',
                    description: 'Gather supplies for chest tube insertion',
                    essential: ['item-13', 'item-14', 'item-2', 'item-4'],
                    optional: ['item-11', 'item-8', 'item-15']
                }
            ]
        };

        // ===== STATE =====
        let state = {
            currentScenario: null,
            inventory: [],
            selectedItems: [],
            selectedCart: null,
            selectedDrawer: null,
            startTime: null,
            sessionId: Date.now(),
            drawerState: 'peek', // peek, half, full
            tutorialStep: 0,
            tutorialActive: false,
            points: 0,
            totalPoints: 0,
            achievements: [],
            completedScenarios: [],
            streakDays: 0
        };

        // ===== DRAWER HANDLING =====
        /* ADJUSTMENT: Modify drawer behavior here */
        let touchStartY = 0;
        let currentDrawerHeight = 0;
        const drawer = document.getElementById('bottom-drawer');
        const handleArea = document.getElementById('drawer-handle-area');  // Using larger area, not just handle

        /* ADJUSTMENT: Change these height thresholds for drawer states */
        const DRAWER_HEIGHTS = {
            peek: 80,      // ADJUST: Minimum collapsed height (in pixels)
            half: 0.5,     // ADJUST: Medium height (as fraction of viewport: 0.5 = 50%)
            full: 0.85     // ADJUST: Maximum expanded height (as fraction of viewport: 0.85 = 85%)
        };

        // Make the entire handle area draggable
        handleArea.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            const rect = drawer.getBoundingClientRect();
            currentDrawerHeight = window.innerHeight - rect.top;
            // Prevent any scrolling during drag
            e.preventDefault();
        }, { passive: false });

        handleArea.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Critical: prevents page scrolling
            
            const touchY = e.touches[0].clientY;
            const deltaY = touchStartY - touchY;  // Positive = dragging up
            const newHeight = currentDrawerHeight + deltaY;
            const vh = window.innerHeight;
            
            /* ADJUSTMENT: Modify these thresholds to change when drawer snaps */
            if (newHeight < 150) {                    // ADJUST: Below this = peek
                setDrawerState('peek');
            } else if (newHeight < vh * 0.65) {       // ADJUST: Below this = half  
                setDrawerState('half');
            } else {                                   // ADJUST: Above = full
                setDrawerState('full');
            }
        }, { passive: false });

        handleArea.addEventListener('touchend', () => {
            // Snap to final position
            drawer.style.transition = 'height 0.3s ease';
            setTimeout(() => {
                drawer.style.transition = '';
            }, 300);
        });

        function setDrawerState(newState) {
            drawer.className = `bottom-drawer ${newState}`;
            state.drawerState = newState;
        }

        /* ADJUSTMENT: Add tap-to-toggle functionality - tap handle to cycle through states */
        handleArea.addEventListener('click', () => {
            if (state.drawerState === 'peek') {
                setDrawerState('half');
            } else if (state.drawerState === 'half') {
                setDrawerState('full');
            } else {
                setDrawerState('peek');
            }
        });

        // Tab switching
        document.querySelectorAll('.drawer-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;

                // Update tabs
                document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                // Update panes
                document.querySelectorAll('.drawer-pane').forEach(p => p.classList.remove('active'));
                document.getElementById(`pane-${tabName}`).classList.add('active');

                // Refresh stats when stats tab is opened
                if (tabName === 'stats') {
                    updateStatsDisplay();
                }

                // Expand drawer when switching tabs
                if (state.drawerState === 'peek') {
                    setDrawerState('half');
                }
            });
        });

        // ===== TUTORIAL SYSTEM (Progressive Onboarding) =====
        const tutorialSteps = [
            {
                title: '👋 Welcome to Trauma Room Trainer!',
                body: '<p>This training simulator helps you learn where medical supplies are located in a trauma room.</p><p>You\'ll practice collecting items from different carts to prepare for various medical procedures.</p>'
            },
            {
                title: '🎯 How It Works',
                body: '<p>Your goal is to collect the correct supplies for each medical scenario as quickly as possible.</p><ul><li>Select a scenario from the drawer below</li><li>Tap carts to open them</li><li>Choose items from drawers</li><li>Submit when ready</li></ul>'
            },
            {
                title: '⭐ Scoring & Achievements',
                body: '<p>You earn points for:</p><ul><li>Collecting essential items (+100 pts)</li><li>Speed bonuses (under 60 seconds)</li><li>Perfect completion (all items)</li><li>Completing multiple scenarios</li></ul><p>Track your progress and compete for high scores!</p>'
            },
            {
                title: '🚀 Ready to Start!',
                body: '<p>Let\'s begin your training. Remember:</p><ul><li>Take your time to learn cart locations</li><li>Essential items are required to pass</li><li>Optional items give bonus points</li></ul><p>Good luck!</p>'
            }
        ];

        function startTutorial() {
            const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
            if (hasSeenTutorial) return;

            state.tutorialActive = true;
            state.tutorialStep = 0;
            showTutorialStep(0);
        }

        function showTutorialStep(stepIndex) {
            const overlay = document.getElementById('tutorial-overlay');
            const title = document.getElementById('tutorial-title');
            const body = document.getElementById('tutorial-body');
            const stepsContainer = document.getElementById('tutorial-steps');
            const nextBtn = document.getElementById('tutorial-next');

            if (stepIndex >= tutorialSteps.length) {
                endTutorial();
                return;
            }

            const step = tutorialSteps[stepIndex];
            title.innerHTML = step.title;
            body.innerHTML = step.body;

            // Update step indicators
            stepsContainer.innerHTML = '';
            tutorialSteps.forEach((_, i) => {
                const dot = document.createElement('div');
                dot.className = 'tutorial-step-indicator' + (i === stepIndex ? ' active' : '');
                stepsContainer.appendChild(dot);
            });

            // Update button text
            nextBtn.textContent = stepIndex === tutorialSteps.length - 1 ? 'Start Training!' : 'Next';

            overlay.classList.add('active');
            playSound('tutorial');
        }

        function nextTutorialStep() {
            state.tutorialStep++;
            showTutorialStep(state.tutorialStep);
        }

        function skipTutorial() {
            endTutorial();
        }

        function endTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
            localStorage.setItem('hasSeenTutorial', 'true');
            state.tutorialActive = false;
            loadUserProgress();
        }

        // ===== SOUND EFFECTS & HAPTIC FEEDBACK =====
        const sounds = {
            itemCollect: () => playTone(800, 0.1, 'sine'),
            itemRemove: () => playTone(400, 0.1, 'sine'),
            success: () => playTone(1200, 0.3, 'sine'),
            error: () => playTone(200, 0.3, 'square'),
            tutorial: () => playTone(600, 0.15, 'sine'),
            achievement: () => {
                playTone(800, 0.1, 'sine');
                setTimeout(() => playTone(1000, 0.1, 'sine'), 100);
                setTimeout(() => playTone(1200, 0.2, 'sine'), 200);
            }
        };

        function playSound(type) {
            if (sounds[type]) {
                try {
                    sounds[type]();
                } catch (e) {
                    // Ignore audio errors
                }
            }
        }

        function playTone(frequency, duration, type = 'sine') {
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = type;

                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);

                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + duration);
            } catch (e) {
                // Audio not supported
            }
        }

        function triggerHaptic(intensity = 'medium') {
            if (navigator.vibrate) {
                const patterns = {
                    light: 10,
                    medium: 20,
                    heavy: 50
                };
                navigator.vibrate(patterns[intensity] || 20);
            }
        }

        // ===== POINTS & REWARDS SYSTEM =====
        function awardPoints(amount, reason) {
            state.points += amount;
            state.totalPoints += amount;

            // Show points popup
            showPointsPopup(`+${amount} pts`, reason);
            playSound('itemCollect');
            triggerHaptic('light');

            // Save to localStorage
            saveUserProgress();
        }

        function showPointsPopup(text, reason) {
            const popup = document.getElementById('points-popup');
            popup.innerHTML = text + (reason ? `<div style="font-size: 14px; margin-top: 5px;">${reason}</div>` : '');
            popup.classList.add('show');

            setTimeout(() => {
                popup.classList.remove('show');
            }, 1500);
        }

        // ===== ACHIEVEMENTS SYSTEM =====
        const achievements = [
            {
                id: 'first-scenario',
                title: 'First Steps',
                description: 'Complete your first scenario',
                icon: '🎯',
                check: () => state.completedScenarios.length >= 1
            },
            {
                id: 'perfect-score',
                title: 'Perfectionist',
                description: 'Get 100% on any scenario',
                icon: '⭐',
                check: () => false // checked during submission
            },
            {
                id: 'speed-demon',
                title: 'Speed Demon',
                description: 'Complete a scenario in under 30 seconds',
                icon: '⚡',
                check: () => false // checked during submission
            },
            {
                id: 'all-scenarios',
                title: 'Master Trainer',
                description: 'Complete all scenarios',
                icon: '🏆',
                check: () => state.completedScenarios.length >= DATA.scenarios.length
            },
            {
                id: 'streak-3',
                title: '3-Day Streak',
                description: 'Train for 3 days in a row',
                icon: '🔥',
                check: () => state.streakDays >= 3
            }
        ];

        function checkAchievements() {
            achievements.forEach(achievement => {
                if (!state.achievements.includes(achievement.id) && achievement.check()) {
                    unlockAchievement(achievement);
                }
            });
        }

        function unlockAchievement(achievement) {
            state.achievements.push(achievement.id);
            showAchievementPopup(achievement);
            playSound('achievement');
            triggerHaptic('heavy');
            awardPoints(500, 'Achievement Unlocked!');
            saveUserProgress();
        }

        function showAchievementPopup(achievement) {
            const popup = document.getElementById('points-popup');
            popup.innerHTML = `
                <div style="font-size: 40px; margin-bottom: 10px;">${achievement.icon}</div>
                <div style="font-size: 18px;">Achievement Unlocked!</div>
                <div style="font-size: 16px; margin-top: 5px;">${achievement.title}</div>
            `;
            popup.classList.add('show');

            setTimeout(() => {
                popup.classList.remove('show');
            }, 2500);
        }

        // ===== TOOLTIP SYSTEM =====
        function showTooltip(element, text, duration = 2000) {
            const tooltip = document.getElementById('tooltip');
            const rect = element.getBoundingClientRect();

            tooltip.textContent = text;
            tooltip.style.left = rect.left + rect.width / 2 + 'px';
            tooltip.style.top = rect.top - 40 + 'px';
            tooltip.classList.add('visible');

            setTimeout(() => {
                tooltip.classList.remove('visible');
            }, duration);
        }

        // ===== USER PROGRESS & PERSISTENCE =====
        function loadUserProgress() {
            const saved = localStorage.getItem('userProgress');
            if (saved) {
                const progress = JSON.parse(saved);
                state.totalPoints = progress.totalPoints || 0;
                state.achievements = progress.achievements || [];
                state.completedScenarios = progress.completedScenarios || [];
                state.streakDays = calculateStreak(progress.lastVisit);
            }
        }

        function saveUserProgress() {
            const progress = {
                totalPoints: state.totalPoints,
                achievements: state.achievements,
                completedScenarios: state.completedScenarios,
                lastVisit: new Date().toISOString()
            };
            localStorage.setItem('userProgress', JSON.stringify(progress));
        }

        function calculateStreak(lastVisit) {
            if (!lastVisit) return 0;

            const last = new Date(lastVisit);
            const today = new Date();
            const diffDays = Math.floor((today - last) / (1000 * 60 * 60 * 24));

            if (diffDays === 1) {
                return (state.streakDays || 0) + 1;
            } else if (diffDays === 0) {
                return state.streakDays || 1;
            } else {
                return 0;
            }
        }

        // ===== STATS & LEADERBOARD =====
        function updateStatsDisplay() {
            const statsContent = document.getElementById('stats-content');

            // Get analytics data
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            const totalSessions = analytics.length;
            const completedSessions = analytics.filter(a => a.correct).length;
            const averageScore = analytics.length > 0
                ? analytics.reduce((sum, a) => sum + (a.score || 0), 0) / analytics.length
                : 0;
            const fastestTime = analytics.length > 0
                ? Math.min(...analytics.map(a => a.timeElapsed))
                : 0;

            // Get best scores per scenario
            const scenarioBests = {};
            DATA.scenarios.forEach(scenario => {
                const scenarioSessions = analytics.filter(a => a.scenarioId === scenario.id);
                if (scenarioSessions.length > 0) {
                    const bestScore = Math.max(...scenarioSessions.map(s => s.score || 0));
                    const bestTime = Math.min(...scenarioSessions.filter(s => s.correct).map(s => s.timeElapsed || 999));
                    scenarioBests[scenario.id] = { bestScore, bestTime, attempts: scenarioSessions.length };
                }
            });

            // Create achievements display
            const achievementsHTML = achievements.map(achievement => {
                const unlocked = state.achievements.includes(achievement.id);
                return `
                    <div style="display: flex; align-items: center; gap: 10px; padding: 10px; background: ${unlocked ? '#d4edda' : '#f8f9fa'}; border-radius: 8px; margin-bottom: 8px; opacity: ${unlocked ? '1' : '0.5'};">
                        <div style="font-size: 30px;">${achievement.icon}</div>
                        <div style="flex: 1;">
                            <div style="font-weight: bold; font-size: 13px; color: #333;">${achievement.title}</div>
                            <div style="font-size: 11px; color: #666;">${achievement.description}</div>
                        </div>
                        ${unlocked ? '<div style="color: #28a745; font-weight: bold;">✓</div>' : ''}
                    </div>
                `;
            }).join('');

            statsContent.innerHTML = `
                <div style="padding: 5px 0;">
                    <h3 style="font-size: 16px; color: #333; margin-bottom: 15px;">📊 Your Statistics</h3>

                    <!-- Overall Stats -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px;">
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold;">${state.totalPoints}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Total Points</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold;">${state.achievements.length}/${achievements.length}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Achievements</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold;">${totalSessions}</div>
                            <div style="font-size: 12px; opacity: 0.9;">Total Attempts</div>
                        </div>
                        <div style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 15px; border-radius: 10px;">
                            <div style="font-size: 24px; font-weight: bold;">${averageScore.toFixed(0)}%</div>
                            <div style="font-size: 12px; opacity: 0.9;">Avg. Score</div>
                        </div>
                    </div>

                    <!-- Scenario Best Scores -->
                    <h4 style="font-size: 14px; color: #333; margin-bottom: 10px;">🏆 Best Scores</h4>
                    <div style="margin-bottom: 20px;">
                        ${DATA.scenarios.map(scenario => {
                            const best = scenarioBests[scenario.id];
                            if (!best) {
                                return `
                                    <div style="padding: 10px; background: #f8f9fa; border-radius: 8px; margin-bottom: 8px;">
                                        <div style="font-weight: bold; font-size: 13px; color: #666;">${scenario.name}</div>
                                        <div style="font-size: 11px; color: #999; margin-top: 3px;">Not attempted yet</div>
                                    </div>
                                `;
                            }
                            return `
                                <div style="padding: 10px; background: #e7f3ff; border-left: 4px solid #007bff; border-radius: 8px; margin-bottom: 8px;">
                                    <div style="display: flex; justify-content: space-between; align-items: center;">
                                        <div style="font-weight: bold; font-size: 13px; color: #333;">${scenario.name}</div>
                                        <div style="font-weight: bold; font-size: 14px; color: #007bff;">${best.bestScore.toFixed(0)}%</div>
                                    </div>
                                    <div style="font-size: 11px; color: #666; margin-top: 3px;">
                                        Best time: ${formatTime(best.bestTime)} · ${best.attempts} attempts
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>

                    <!-- Achievements -->
                    <h4 style="font-size: 14px; color: #333; margin-bottom: 10px;">🎖 Achievements</h4>
                    <div style="margin-bottom: 20px;">
                        ${achievementsHTML}
                    </div>

                    <!-- Quick Stats -->
                    ${state.streakDays > 0 ? `
                    <div style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 15px; border-radius: 10px; text-align: center;">
                        <div style="font-size: 30px; margin-bottom: 5px;">🔥</div>
                        <div style="font-size: 18px; font-weight: bold;">${state.streakDays} Day Streak!</div>
                        <div style="font-size: 12px; opacity: 0.9;">Keep training daily to maintain your streak</div>
                    </div>
                    ` : ''}

                    <div style="display: flex; gap: 10px; margin-top: 15px;">
                        <button onclick="replayTutorial()" style="flex: 1; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
                            🎓 Replay Tutorial
                        </button>
                        <button onclick="exportAnalytics()" style="flex: 1; padding: 12px; background: #6c757d; color: white; border: none; border-radius: 8px; font-size: 14px; font-weight: bold; cursor: pointer;">
                            📥 Export Data
                        </button>
                    </div>
                </div>
            `;
        }

        function replayTutorial() {
            state.tutorialActive = true;
            state.tutorialStep = 0;
            showTutorialStep(0);
        }

        // ===== INIT =====
        function init() {
            loadScenarios();
            drawRoom();
            setupCanvas();
            startTutorial();
        }

        function loadScenarios() {
            const list = document.getElementById('scenario-list');
            DATA.scenarios.forEach(scenario => {
                const div = document.createElement('div');
                div.className = 'scenario-item';

                // Check if scenario is completed
                const isCompleted = state.completedScenarios.includes(scenario.id);
                const completionBadge = isCompleted ? '<span style="background: #28a745; color: white; padding: 2px 8px; border-radius: 10px; font-size: 11px; margin-left: 10px;">✓ Completed</span>' : '';

                // Calculate difficulty
                const totalItems = scenario.essential.length + scenario.optional.length;
                const difficulty = totalItems <= 4 ? 'Easy' : totalItems <= 7 ? 'Medium' : 'Hard';
                const difficultyColor = difficulty === 'Easy' ? '#28a745' : difficulty === 'Medium' ? '#ffc107' : '#dc3545';

                div.innerHTML = `
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
                        <h3 style="margin: 0;">${scenario.name}${completionBadge}</h3>
                        <span style="background: ${difficultyColor}; color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: bold;">${difficulty}</span>
                    </div>
                    <p style="margin: 5px 0;">${scenario.description}</p>
                    <p style="font-size: 11px; color: #999; margin-top: 5px;">
                        ${scenario.essential.length} essential · ${scenario.optional.length} optional
                    </p>
                `;
                div.onclick = () => selectScenario(scenario, div);
                list.appendChild(div);
            });
        }

        function selectScenario(scenario, element) {
            state.currentScenario = scenario;
            state.inventory = [];
            state.startTime = Date.now();
            state.points = 0; // Reset session points for new scenario

            // Update UI
            document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('scenario-name').textContent = scenario.name;
            document.getElementById('room-hint').textContent = 'Tap a cart to open';
            document.getElementById('feedback-content').innerHTML = '<div class="empty-state">Complete scenario to see results</div>';

            updateInventoryDisplay();
            updateStats();

            // Play sound and haptic
            playSound('tutorial');
            triggerHaptic('light');

            // Switch to inventory tab and minimize drawer
            setTimeout(() => {
                document.querySelector('[data-tab="inventory"]').click();
                setDrawerState('peek');
            }, 300);
        }

        // ===== ROOM DRAWING =====
        function setupCanvas() {
            const canvas = document.getElementById('room-canvas');
            const container = canvas.parentElement;
            
            function resizeCanvas() {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawRoom();
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function drawRoom() {
            const canvas = document.getElementById('room-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Room outline
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            ctx.strokeRect(15, 15, canvas.width - 30, canvas.height - 30);

            // Calculate cart dimensions
            const cartWidth = canvas.width * 0.22;
            const cartHeight = canvas.height * 0.35;
            const spacing = (canvas.width - (cartWidth * 3)) / 4;

            // Position carts
            DATA.carts.forEach((cart, index) => {
                const x = spacing + (index * (cartWidth + spacing));
                const y = canvas.height * 0.4;

                // Shadow
                ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 4;

                // Cart body
                ctx.fillStyle = cart.color;
                ctx.fillRect(x, y, cartWidth, cartHeight);
                
                ctx.shadowColor = 'transparent';
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, cartWidth, cartHeight);

                // Label
                ctx.fillStyle = '#fff';
                const fontSize = Math.max(11, cartWidth * 0.11);
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const words = cart.name.split(' ');
                const lineHeight = fontSize * 1.3;
                const startY = y + cartHeight / 2 - ((words.length - 1) * lineHeight) / 2;
                
                words.forEach((word, i) => {
                    ctx.fillText(word, x + cartWidth / 2, startY + i * lineHeight);
                });

                // Drawers
                const drawerHeight = cartHeight / 8;
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
                ctx.lineWidth = 1.5;
                for (let i = 1; i < 8; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x, y + drawerHeight * i);
                    ctx.lineTo(x + cartWidth, y + drawerHeight * i);
                    ctx.stroke();
                }

                cart.hitArea = { x, y, width: cartWidth, height: cartHeight };
            });
        }

        // ===== CANVAS INTERACTION =====
        function handleCanvasClick(e) {
            if (!state.currentScenario) {
                setDrawerState('half');
                document.querySelector('[data-tab="scenarios"]').click();
                return;
            }

            const canvas = document.getElementById('room-canvas');
            const rect = canvas.getBoundingClientRect();
            
            let clientX, clientY;
            if (e.type.startsWith('touch')) {
                e.preventDefault();
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * (canvas.width / rect.width);
            const y = (clientY - rect.top) * (canvas.height / rect.height);

            const clickedCart = DATA.carts.find(cart => {
                const hit = cart.hitArea;
                return hit && x >= hit.x && x <= hit.x + hit.width &&
                       y >= hit.y && y <= hit.y + hit.height;
            });

            if (clickedCart) {
                openCart(clickedCart);
            }
        }

        document.getElementById('room-canvas').addEventListener('click', handleCanvasClick);
        document.getElementById('room-canvas').addEventListener('touchstart', handleCanvasClick);

        // ===== CART & DRAWER =====
        function openCart(cart) {
            state.selectedCart = cart;
            document.getElementById('cart-modal-title').textContent = cart.name;

            const grid = document.getElementById('drawer-grid');
            grid.innerHTML = '';

            cart.drawers.forEach(drawer => {
                const itemCount = drawer.items.length;
                const div = document.createElement('div');
                div.className = 'drawer-item';
                
                const badge = itemCount > 0 
                    ? `<span class="drawer-badge">${itemCount}</span>`
                    : `<span class="drawer-badge empty">Empty</span>`;
                
                div.innerHTML = `<strong>${drawer.name}${badge}</strong><small style="margin-top: 4px; display: block; color: #666;">${itemCount > 0 ? 'Tap to view' : 'No items'}</small>`;
                
                if (itemCount > 0) {
                    div.onclick = () => openDrawer(drawer);
                } else {
                    div.style.opacity = '0.5';
                }
                
                grid.appendChild(div);
            });

            document.getElementById('cart-modal').classList.add('active');
        }

        function openDrawer(drawer) {
            state.selectedDrawer = drawer;
            state.selectedItems = [];
            
            document.getElementById('item-modal-title').textContent = 
                `${state.selectedCart.name} - ${drawer.name}`;

            const grid = document.getElementById('item-grid');
            grid.innerHTML = '';

            drawer.items.forEach(itemId => {
                const item = DATA.items.find(i => i.id === itemId);
                if (item) {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `
                        <div class="item-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                        <strong>${item.name}</strong>
                        <small>${item.category}</small>
                    `;
                    div.onclick = () => toggleItemSelection(div, item);
                    grid.appendChild(div);
                }
            });

            closeModal('cart-modal');
            document.getElementById('item-modal').classList.add('active');
        }

        function toggleItemSelection(element, item) {
            const index = state.selectedItems.findIndex(i => i.id === item.id);
            if (index > -1) {
                state.selectedItems.splice(index, 1);
                element.classList.remove('selected');
            } else {
                state.selectedItems.push(item);
                element.classList.add('selected');
            }
        }

        function addSelectedItems() {
            state.selectedItems.forEach(item => {
                if (!state.inventory.find(i => i.id === item.id)) {
                    state.inventory.push({
                        ...item,
                        cart: state.selectedCart.name,
                        drawer: state.selectedDrawer.name
                    });

                    // Award points for collecting items
                    const scenario = state.currentScenario;
                    if (scenario) {
                        if (scenario.essential.includes(item.id)) {
                            awardPoints(100, 'Essential item!');
                        } else if (scenario.optional.includes(item.id)) {
                            awardPoints(50, 'Optional item');
                        } else {
                            awardPoints(10, 'Item collected');
                        }
                    }

                    // Play sound and haptic feedback
                    playSound('itemCollect');
                    triggerHaptic('light');
                }
            });

            state.selectedItems = [];
            updateInventoryDisplay();
            updateStats();
            closeModal('item-modal');
            document.getElementById('room-hint').classList.add('hidden');
        }

        // ===== INVENTORY =====
        function updateInventoryDisplay() {
            const list = document.getElementById('inventory-list');
            const submitBtn = document.getElementById('submit-btn');
            const badge = document.getElementById('inventory-badge');

            badge.textContent = state.inventory.length;

            if (state.inventory.length === 0) {
                const emptyMessage = state.currentScenario
                    ? `<div class="empty-state">
                        <div style="font-size: 40px; margin-bottom: 10px;">📦</div>
                        <p style="font-weight: bold; margin-bottom: 5px;">No items collected yet</p>
                        <p>Tap a cart in the room above to start collecting items for this scenario.</p>
                      </div>`
                    : `<div class="empty-state">
                        <div style="font-size: 40px; margin-bottom: 10px;">🎯</div>
                        <p style="font-weight: bold; margin-bottom: 5px;">Ready to begin?</p>
                        <p>Select a scenario from the Scenarios tab to start your training.</p>
                      </div>`;
                list.innerHTML = emptyMessage;
                submitBtn.disabled = true;
            } else {
                list.innerHTML = '';

                // Add progress bar if scenario is selected
                if (state.currentScenario) {
                    const scenario = state.currentScenario;
                    const collectedIds = state.inventory.map(i => i.id);
                    const foundEssential = scenario.essential.filter(id => collectedIds.includes(id));
                    const progress = (foundEssential.length / scenario.essential.length) * 100;

                    const progressDiv = document.createElement('div');
                    progressDiv.innerHTML = `
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-size: 12px; font-weight: bold; color: #666;">Essential Items Progress</span>
                                <span style="font-size: 12px; font-weight: bold; color: #007bff;">${foundEssential.length}/${scenario.essential.length}</span>
                            </div>
                            <div class="progress-container">
                                <div class="progress-bar" style="width: ${progress}%;">${progress.toFixed(0)}%</div>
                            </div>
                        </div>
                    `;
                    list.appendChild(progressDiv);
                }

                state.inventory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'inventory-item item-collected-animation';

                    // Check if item is essential or optional
                    const scenario = state.currentScenario;
                    let itemBadge = '';
                    if (scenario) {
                        if (scenario.essential.includes(item.id)) {
                            itemBadge = '<span style="background: #28a745; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; margin-left: 5px;">ESSENTIAL</span>';
                        } else if (scenario.optional.includes(item.id)) {
                            itemBadge = '<span style="background: #007bff; color: white; padding: 2px 6px; border-radius: 10px; font-size: 9px; margin-left: 5px;">OPTIONAL</span>';
                        }
                    }

                    div.innerHTML = `
                        <div class="item-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                        <div class="item-info">
                            <strong>${item.name}${itemBadge}</strong>
                            <small>${item.cart} → ${item.drawer}</small>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${index})">✕</button>
                    `;
                    list.appendChild(div);
                });
                submitBtn.disabled = false;
            }
        }

        function removeItem(index) {
            state.inventory.splice(index, 1);
            updateInventoryDisplay();
            updateStats();
        }

        // ===== FEEDBACK =====
        function submitInventory() {
            const scenario = state.currentScenario;
            const collectedIds = state.inventory.map(i => i.id);

            const foundEssential = scenario.essential.filter(id => collectedIds.includes(id));
            const missingEssential = scenario.essential.filter(id => !collectedIds.includes(id));
            const foundOptional = scenario.optional.filter(id => collectedIds.includes(id));
            const missingOptional = scenario.optional.filter(id => !collectedIds.includes(id));
            const extra = collectedIds.filter(id =>
                !scenario.essential.includes(id) && !scenario.optional.includes(id));

            const timeElapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const allEssential = missingEssential.length === 0;
            const allRequired = allEssential && missingOptional.length === 0;

            let feedbackClass, feedbackTitle, feedbackMessage;
            let bonusPoints = 0;

            if (allRequired) {
                feedbackClass = 'success';
                feedbackTitle = '✓ Perfect!';
                feedbackMessage = 'You collected all required items correctly!';
                bonusPoints = 500;
                playSound('success');
                triggerHaptic('heavy');

                // Check for perfect score achievement
                if (!state.achievements.includes('perfect-score')) {
                    const perfectAchievement = achievements.find(a => a.id === 'perfect-score');
                    unlockAchievement(perfectAchievement);
                }
            } else if (allEssential) {
                feedbackClass = 'partial';
                feedbackTitle = '⚠ Good, but incomplete';
                feedbackMessage = 'You got all essential items, but missed some recommended ones.';
                bonusPoints = 200;
                playSound('success');
                triggerHaptic('medium');
            } else {
                feedbackClass = 'error';
                feedbackTitle = '✗ Missing Critical Items';
                feedbackMessage = 'You are missing essential items for this procedure.';
                playSound('error');
                triggerHaptic('heavy');
            }

            // Speed bonus
            if (timeElapsed < 60 && allEssential) {
                bonusPoints += 300;
                feedbackMessage += ' Amazing speed!';
            }

            if (timeElapsed < 30 && allEssential) {
                if (!state.achievements.includes('speed-demon')) {
                    const speedAchievement = achievements.find(a => a.id === 'speed-demon');
                    unlockAchievement(speedAchievement);
                }
            }

            // Award completion bonus
            if (bonusPoints > 0) {
                setTimeout(() => {
                    awardPoints(bonusPoints, 'Completion Bonus!');
                }, 500);
            }

            // Track completed scenario
            if (allEssential && !state.completedScenarios.includes(scenario.id)) {
                state.completedScenarios.push(scenario.id);
                saveUserProgress();
            }

            // Check achievements
            checkAchievements();

            let detailsHTML = '<ul>';
            if (missingEssential.length > 0) {
                detailsHTML += '<li><strong>Missing Essential:</strong> ' +
                    missingEssential.map(id => DATA.items.find(i => i.id === id)?.name).join(', ') + '</li>';
            }
            if (missingOptional.length > 0) {
                detailsHTML += '<li><strong>Missing Recommended:</strong> ' +
                    missingOptional.map(id => DATA.items.find(i => i.id === id)?.name).join(', ') + '</li>';
            }
            if (extra.length > 0) {
                detailsHTML += '<li><strong>Extra Items:</strong> ' +
                    extra.map(id => DATA.items.find(i => i.id === id)?.name).join(', ') + '</li>';
            }
            detailsHTML += '</ul>';

            const score = (foundEssential.length / scenario.essential.length) * 100;
            const feedbackHTML = `
                <div class="feedback ${feedbackClass}">
                    <h3>${feedbackTitle}</h3>
                    <p>${feedbackMessage}</p>
                    ${detailsHTML}
                    <div style="margin-top: 15px; padding: 10px; background: rgba(0,0,0,0.05); border-radius: 5px;">
                        <p style="margin: 5px 0;"><strong>Time:</strong> ${formatTime(timeElapsed)}</p>
                        <p style="margin: 5px 0;"><strong>Score:</strong> ${score.toFixed(0)}%</p>
                        <p style="margin: 5px 0;"><strong>Session Points:</strong> +${state.points} pts</p>
                        <p style="margin: 5px 0;"><strong>Total Points:</strong> ${state.totalPoints} pts</p>
                    </div>
                    <div class="feedback-actions">
                        <button onclick="tryAgain()">Try Another Scenario</button>
                    </div>
                </div>
            `;

            document.getElementById('feedback-content').innerHTML = feedbackHTML;

            // Switch to feedback tab
            document.querySelector('[data-tab="feedback"]').click();
            setDrawerState('full');

            // Save analytics with enhanced data
            saveAnalytics({
                sessionId: state.sessionId,
                scenarioId: scenario.id,
                scenarioName: scenario.name,
                timestamp: new Date().toISOString(),
                timeElapsed: timeElapsed,
                itemsCollected: collectedIds,
                correct: allRequired,
                score: score,
                pointsEarned: state.points,
                totalPoints: state.totalPoints,
                achievements: state.achievements.length
            });
        }

        function tryAgain() {
            state.inventory = [];
            state.currentScenario = null;
            state.startTime = null;
            
            document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('active'));
            document.getElementById('scenario-name').textContent = 'Select a scenario below ↓';
            document.getElementById('room-hint').textContent = 'Select a scenario from the drawer below to begin';
            document.getElementById('room-hint').classList.remove('hidden');
            
            updateInventoryDisplay();
            updateStats();
            
            document.querySelector('[data-tab="scenarios"]').click();
            setDrawerState('half');
        }

        // ===== STATS =====
        function updateStats() {
            if (state.startTime) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                document.getElementById('stat-time').textContent = formatTime(elapsed);
            }
            document.getElementById('stat-items').textContent = state.inventory.length;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        setInterval(() => {
            if (state.startTime) updateStats();
        }, 1000);

        // ===== ANALYTICS =====
        function saveAnalytics(data) {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            analytics.push(data);
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        window.exportAnalytics = function() {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            const dataStr = JSON.stringify(analytics, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trauma-room-analytics-${Date.now()}.json`;
            link.click();
        };

        // ===== MODALS =====
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ===== INIT =====
        window.onload = init;
    </script>
</body>
</html>
