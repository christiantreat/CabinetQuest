<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Cabinet Quest</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }

        /* Main Container */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Ultra-Compact Header - Single Row */
        .header {
            background: white;
            padding: 6px 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 100;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .header h1 {
            font-size: 13px;
            color: #333;
            margin: 0;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-shrink: 0;
        }

        .scenario-name {
            font-size: 15px;
            color: #007bff;
            font-weight: 700;
            display: block;
            margin-bottom: 3px;
        }

        /* Compact icon-only buttons */
        .settings-btn {
            background: transparent;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px;
            color: #666;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .settings-btn:hover {
            color: #007bff;
            transform: rotate(30deg);
        }

        .scenarios-menu-btn {
            background: #007bff;
            border: none;
            font-size: 18px;
            cursor: pointer;
            padding: 4px 6px;
            color: white;
            border-radius: 4px;
            transition: all 0.2s;
            flex-shrink: 0;
            line-height: 1;
        }

        .scenarios-menu-btn:hover {
            background: #0056b3;
        }

        /* Ultra-Compact Task Bar */
        .scenario-description-box {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 8px 10px;
            margin: 0;
            font-size: 11px;
            color: #856404;
            display: none;
            line-height: 1.3;
        }

        .scenario-description-box.active {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .scenario-task-row {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }

        .scenario-task-text {
            flex: 1;
            min-width: 0;
        }

        .scenario-task-text strong {
            font-weight: 600;
            display: none;
        }

        /* Compact Action Buttons */
        .scenario-actions {
            display: flex;
            gap: 6px;
            flex-wrap: nowrap;
        }

        .scenario-action-btn {
            flex: 1;
            min-width: 70px;
            padding: 8px 10px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.2s ease;
            min-height: 36px;
            white-space: nowrap;
        }

        .scenario-action-btn:active {
            transform: scale(0.98);
        }

        /* Restart button - yellow/warning */
        .restart-btn {
            background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);
            color: #333;
            box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
        }

        .restart-btn:hover {
            box-shadow: 0 4px 12px rgba(255, 193, 7, 0.4);
        }

        /* Submit button - green with pulse animation */
        .submit-btn-yellow {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }

        .submit-btn-yellow:not(:disabled) {
            animation: pulse-glow 2s ease-in-out infinite;
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3); }
            50% { box-shadow: 0 4px 16px rgba(40, 167, 69, 0.6); }
        }

        .submit-btn-yellow:disabled {
            background: #ccc;
            box-shadow: none;
            animation: none;
            cursor: not-allowed;
            opacity: 0.6;
        }

        /* Advance button - blue */
        .advance-btn {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 123, 255, 0.3);
        }

        .advance-btn:hover {
            box-shadow: 0 4px 12px rgba(0, 123, 255, 0.4);
        }

        /* Feedback area in scenario box */
        .scenario-feedback {
            padding: 10px;
            border-radius: 6px;
            font-size: 12px;
            line-height: 1.4;
            display: none;
        }

        .scenario-feedback.active {
            display: block;
        }

        .scenario-feedback.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .scenario-feedback.partial {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .scenario-feedback.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .scenario-feedback strong {
            font-weight: 700;
            display: block;
            margin-bottom: 4px;
        }

        .stats-compact {
            display: flex;
            gap: 8px;
            font-size: 11px;
            flex-shrink: 0;
        }

        .stat-compact {
            color: #007bff;
            font-weight: bold;
            white-space: nowrap;
        }

        .stat-compact .label {
            color: #999;
            font-weight: normal;
        }

        /* Room View */
        .room-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }

        #room-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        /* Room Hint Overlay */
        .room-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 243, 205, 0.95);
            color: #856404;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
            z-index: 50;
        }

        .room-hint.hidden {
            display: none;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .modal-header h2 {
            font-size: 20px;
            color: #333;
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .modal-footer button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: bold;
            cursor: pointer;
            min-width: 100px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        /* Scenarios List in Modal */
        .scenarios-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }

        .scenario-item {
            background: white;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .scenario-item:active {
            transform: scale(0.98);
        }

        .scenario-item.active {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .scenario-item.locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .scenario-item.completed {
            border-color: #28a745;
        }

        .scenario-item.completed::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #28a745;
            font-size: 20px;
            font-weight: bold;
        }

        .scenario-item h4 {
            font-size: 14px;
            margin-bottom: 5px;
            color: #333;
        }

        .scenario-item p {
            font-size: 12px;
            color: #666;
            line-height: 1.4;
        }

        /* NEW: Visual Cart with Drawers */
        .cart-visual-container {
            perspective: 1200px;
            padding: 20px;
        }

        .cart-label {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
        }

        .cart-visual {
            display: flex;
            flex-direction: column;
            gap: 12px;
            max-width: 400px;
            margin: 0 auto;
            background: linear-gradient(to bottom, #666, #555);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        }

        .drawer-visual {
            position: relative;
            height: 85px;
            cursor: pointer;
            transform-style: preserve-3d;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .drawer-visual:hover {
            transform: translateZ(15px);
        }

        .drawer-visual:active {
            transform: translateZ(5px) translateX(20px);
            transition: transform 0.2s ease-out;
        }

        .drawer-face {
            width: 100%;
            height: 100%;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 
                inset 0 3px 6px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.2),
                0 4px 12px rgba(0,0,0,0.3),
                -3px 0 10px rgba(0,0,0,0.15);
            position: relative;
            border: 2px solid rgba(0,0,0,0.25);
            background: linear-gradient(to right, 
                var(--drawer-color) 0%, 
                var(--drawer-color-light) 50%, 
                var(--drawer-color) 100%);
        }

        .drawer-visual:active .drawer-face {
            box-shadow: 
                inset 0 3px 6px rgba(255,255,255,0.3),
                inset 0 -2px 4px rgba(0,0,0,0.2),
                0 2px 6px rgba(0,0,0,0.3),
                -8px 0 20px rgba(0,0,0,0.2);
        }

        /* Drawer handle with screws */
        .drawer-handle {
            width: 70px;
            height: 10px;
            background: linear-gradient(to bottom, #777, #444);
            border-radius: 5px;
            box-shadow: 
                0 3px 6px rgba(0,0,0,0.4),
                inset 0 1px 2px rgba(255,255,255,0.3);
            position: relative;
        }

        .drawer-handle::before,
        .drawer-handle::after {
            content: '';
            position: absolute;
            width: 8px;
            height: 8px;
            background: radial-gradient(circle, #333 30%, #555 70%, #333 100%);
            border-radius: 50%;
            top: 1px;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.5);
        }

        .drawer-handle::before {
            left: 5px;
        }

        .drawer-handle::after {
            right: 5px;
        }

        .drawer-label {
            font-size: 14px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Item count indicator */
        .drawer-item-count {
            background: rgba(255,255,255,0.9);
            color: #333;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        /* Essential items indicator */
        .drawer-has-essential::after {
            content: '‚òÖ';
            position: absolute;
            top: 10px;
            right: 10px;
            color: #ffc107;
            font-size: 24px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            animation: twinkle 2s ease-in-out infinite;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        /* Item Grid */
        .item-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .item-card {
            background: white;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .item-card:active {
            transform: scale(0.95);
        }

        .item-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .item-card.in-inventory {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .item-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background: #f0f0f0;
            font-size: 16px;
            font-weight: bold;
            color: #666;
            overflow: hidden;
        }

        .item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 8px;
        }

        .item-icon.loading {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .item-card h5 {
            font-size: 13px;
            color: #333;
            margin: 0;
        }

        /* Procedure Table in Room */
        .procedure-table {
            display: none !important;
        }

        /* Inventory Modal Items */
        .procedure-table-items {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .procedure-table-item {
            display: flex;
            align-items: center;
            gap: 8px;
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            font-size: 11px;
        }

        .procedure-table-icon {
            width: 30px;
            height: 30px;
            background: #007bff;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            flex-shrink: 0;
        }

        .procedure-table-info {
            flex: 1;
            min-width: 0;
        }

        .procedure-table-info strong {
            display: block;
            font-size: 11px;
            color: #333;
            margin-bottom: 2px;
        }

        .procedure-table-info small {
            display: block;
            font-size: 9px;
            color: #999;
        }

        .procedure-table-remove {
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .procedure-table-empty {
            text-align: center;
            padding: 20px;
            color: #999;
            font-size: 11px;
        }

        .item-badge {
            font-size: 8px;
            padding: 2px 4px;
            border-radius: 3px;
            margin-left: 3px;
            font-weight: bold;
        }

        .badge-essential {
            background: #dc3545;
            color: white;
        }

        .badge-optional {
            background: #ffc107;
            color: #333;
        }

        /* Missed items list in feedback */
        .missed-items-section {
            margin: 15px 0;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .missed-items-section h4 {
            font-size: 14px;
            margin-bottom: 10px;
            color: #333;
        }

        .missed-items-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .missed-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 12px;
        }

        .missed-item-icon {
            width: 30px;
            height: 30px;
            background: #6c757d;
            color: white;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 10px;
            flex-shrink: 0;
        }

        .missed-item-icon.essential {
            background: #dc3545;
        }

        .missed-item-info {
            flex: 1;
        }

        .missed-item-info strong {
            display: block;
            color: #333;
        }

        .missed-item-info small {
            color: #666;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 5px;
            justify-content: center;
            margin: 15px 0;
            font-size: 32px;
        }

        .star {
            color: #ddd;
            transition: color 0.3s;
        }

        .star.filled {
            color: #ffc107;
            animation: starPop 0.5s ease;
        }

        @keyframes starPop {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }

        /* Progress Bars */
        .progress-container {
            width: 100%;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.5s ease;
        }

        /* Achievement Toast */
        .achievement-toast {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: #333;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 2000;
            display: none;
            animation: slideIn 0.5s ease;
            min-width: 250px;
        }

        .achievement-toast.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .achievement-toast h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }

        .achievement-toast p {
            font-size: 13px;
            opacity: 0.9;
        }

        /* Points Award Animation */
        .points-award {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
            animation: pointsPop 0.8s ease;
            font-size: 24px;
            font-weight: bold;
        }

        .points-award.show {
            display: block;
        }

        @keyframes pointsPop {
            0% {
                transform: translate(-50%, -50%) scale(0);
                opacity: 0;
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }

        /* Item Collected Toast */
        .item-collected-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            box-shadow: 0 4px 20px rgba(0,123,255,0.4);
            z-index: 2000;
            display: none;
            animation: itemToastSlide 0.6s ease;
            font-size: 14px;
            font-weight: bold;
            text-align: center;
            min-width: 200px;
        }

        .item-collected-toast.show {
            display: block;
        }

        @keyframes itemToastSlide {
            0% {
                transform: translateX(-50%) translateY(100px);
                opacity: 0;
            }
            20% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            80% {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
            100% {
                transform: translateX(-50%) translateY(-20px);
                opacity: 0;
            }
        }

        /* Pulse animation for inventory count */
        @keyframes inventoryPulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
                color: #28a745;
            }
        }

        .stat-pulse {
            animation: inventoryPulse 0.4s ease;
        }

        /* Tutorial specific styles */
        .tutorial-step {
            display: none;
        }

        .tutorial-step.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .tutorial-step h3 {
            font-size: 18px;
            color: #007bff;
            margin-bottom: 15px;
            text-align: center;
        }

        .tutorial-step p {
            font-size: 15px;
            line-height: 1.6;
            color: #666;
            text-align: center;
        }

        .tutorial-icon {
            font-size: 64px;
            text-align: center;
            margin: 20px 0;
        }

        .tutorial-progress {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
        }

        .tutorial-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            transition: all 0.3s;
        }

        .tutorial-dot.active {
            background: #007bff;
            transform: scale(1.3);
        }

        /* Results in settings modal */
        .results-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 400px;
            overflow-y: auto;
        }

        .result-item {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 12px;
        }

        .result-item h4 {
            font-size: 14px;
            color: #333;
            margin-bottom: 5px;
        }

        .result-item p {
            font-size: 12px;
            color: #666;
            margin: 3px 0;
        }

        /* Extra compact on very small screens */
        @media (max-width: 380px) {
            .header h1 {
                font-size: 12px;
            }

            .stats-compact {
                font-size: 10px;
                gap: 6px;
            }

            .scenario-description-box {
                font-size: 10px;
                padding: 5px 8px;
            }

            .scenario-action-btn {
                font-size: 11px;
                padding: 6px 8px;
                min-height: 32px;
                min-width: 60px;
            }
            
            .scenario-name {
                font-size: 13px;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Ultra-Compact Header - Single Row -->
        <div class="header">
            <button class="scenarios-menu-btn" onclick="openScenariosModal()" title="Scenarios">üìã</button>
            <h1>üóÑÔ∏è CABINET QUEST</h1>
            <div class="header-info">
                <div class="stats-compact">
                    <div class="stat-compact">
                        ‚è±<span id="stat-time">0:00</span>
                    </div>
                    <div class="stat-compact">
                        üì¶<span id="stat-items">0</span>
                    </div>
                </div>
            </div>
            <button class="settings-btn" onclick="openSettingsModal()" title="Settings">‚öôÔ∏è</button>
        </div>

        <!-- Compact Task Bar -->
        <div class="scenario-description-box" id="scenario-description">
            <div class="scenario-task-row">
                <div class="scenario-task-text" id="scenario-task">
                    <span class="scenario-name" id="scenario-name">Select a scenario</span>
                    <span id="task-description"></span>
                </div>
            </div>
            
            <!-- Feedback area within scenario box -->
            <div class="scenario-feedback" id="scenario-feedback"></div>
            
            <!-- Compact Action Buttons -->
            <div class="scenario-actions">
                <button class="scenario-action-btn restart-btn" id="restart-btn" onclick="retryScenario()" style="display: none;">
                    üîÑ Retry
                </button>
                <button class="scenario-action-btn submit-btn-yellow" id="submit-btn-yellow" onclick="submitInventory()" disabled>
                    ‚úì Submit
                </button>
                <button class="scenario-action-btn advance-btn" id="advance-btn" onclick="continueToNext()" style="display: none;">
                    ‚Üí Next
                </button>
            </div>
        </div>

        <!-- Room Container -->
        <div class="room-container">
            <canvas id="room-canvas"></canvas>
            <div class="room-hint" id="room-hint">Open Scenarios menu to begin</div>
        </div>
    </div>

    <!-- Tutorial Modal -->
    <div class="modal" id="tutorial-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="tutorial-header">üéì Welcome to Cabinet Quest!</h2>
                <div class="tutorial-progress" id="tutorial-progress"></div>
            </div>
            <div class="modal-body">
                <div class="tutorial-step active" data-step="0">
                    <div class="tutorial-icon">üóÑÔ∏è</div>
                    <h3>Welcome!</h3>
                    <p>Learn how to use Cabinet Quest to master emergency medical equipment locations and procedures.</p>
                </div>

                <div class="tutorial-step" data-step="1">
                    <div class="tutorial-icon">üìã</div>
                    <h3>Choose a Scenario</h3>
                    <p>Click "Scenarios" to select a medical emergency. You'll work through them one at a time, learning what equipment you need for each situation.</p>
                </div>

                <div class="tutorial-step" data-step="2">
                    <div class="tutorial-icon">üö™</div>
                    <h3>Explore the Room</h3>
                    <p>Tap on carts in the trauma room to open them. Each cart has 3 drawers you can see and interact with.</p>
                </div>

                <div class="tutorial-step" data-step="3">
                    <div class="tutorial-icon">üéí</div>
                    <h3>Collect Items</h3>
                    <p>Tap drawers to open them and select items. Selected items will be highlighted. Tap "Add to Table" to collect them. View your collected items by tapping the Procedure Table cart in the center.</p>
                </div>

                <div class="tutorial-step" data-step="4">
                    <div class="tutorial-icon">‚úì</div>
                    <h3>Submit & Learn</h3>
                    <p>When ready, submit your inventory to see how you did. You'll see what you got right and what you missed. You can retry or continue to the next scenario.</p>
                </div>

                <div class="tutorial-step" data-step="5">
                    <div class="tutorial-icon">‚≠ê</div>
                    <h3>Earn Rewards</h3>
                    <p>Complete scenarios to earn stars, points, and unlock achievements. Improve your knowledge of trauma room equipment locations!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" id="tutorial-prev" onclick="prevTutorialStep()" style="display: none;">‚Üê Back</button>
                <button class="btn-primary" id="tutorial-next" onclick="nextTutorialStep()">Next ‚Üí</button>
            </div>
        </div>
    </div>

    <!-- Scenarios Modal -->
    <div class="modal" id="scenarios-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìã Select Scenario</h2>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    Progress: <strong id="progress-badge-modal">0/0</strong>
                </p>
            </div>
            <div class="modal-body">
                <div class="scenarios-grid" id="scenarios-list"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('scenarios-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>‚öôÔ∏è Settings</h2>
            </div>
            <div class="modal-body">
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="sound-toggle" onchange="toggleSound()" checked>
                        <span>üîä Sound Effects</span>
                    </label>
                </div>
                <div style="margin: 15px 0;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                        <input type="checkbox" id="haptic-toggle" onchange="toggleHaptic()" checked>
                        <span>üì≥ Haptic Feedback</span>
                    </label>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                
                <h3 style="font-size: 16px; margin-bottom: 10px;">üìä Your Results</h3>
                <div class="results-list" id="results-list">
                    <div class="procedure-table-empty">No results yet. Complete a scenario to see your performance!</div>
                </div>
                
                <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                
                <div style="margin: 15px 0;">
                    <button onclick="exportAnalytics()" style="width: 100%; padding: 12px; background: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        üìä Export Analytics Data
                    </button>
                </div>
                <div style="margin: 15px 0;">
                    <button onclick="resetProgress()" style="width: 100%; padding: 12px; background: #dc3545; color: white; border: none; border-radius: 8px; cursor: pointer;">
                        üîÑ Reset All Progress
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('settings-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Cart Modal - Now with Visual Drawers -->
    <div class="modal" id="cart-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="cart-modal-title">Select Drawer</h2>
            </div>
            <div class="modal-body" id="cart-modal-body">
                <!-- Will be populated with visual cart -->
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('cart-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Item Modal -->
    <div class="modal" id="item-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="item-modal-title">Select Items</h2>
            </div>
            <div class="modal-body">
                <div class="item-grid" id="item-grid"></div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="backToCart()">‚Üê Back to Drawers</button>
                <button class="btn-primary" onclick="collectSelectedItems()">Add to Table</button>
            </div>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div class="modal" id="inventory-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üì¶ Procedure Table</h2>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    Items collected: <strong id="inventory-count">0</strong>
                </p>
            </div>
            <div class="modal-body">
                <div class="procedure-table-items" id="inventory-modal-items">
                    <div class="procedure-table-empty">No items collected yet</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" onclick="closeModal('inventory-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Feedback Modal -->
    <div class="modal" id="feedback-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="feedback-modal-title">Results</h2>
            </div>
            <div class="modal-body" id="feedback-modal-body">
                <!-- Dynamic feedback content goes here -->
            </div>
            <div class="modal-footer" id="feedback-modal-footer">
                <button class="btn-secondary" onclick="closeModal('feedback-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Achievement Toast -->
    <div class="achievement-toast" id="achievement-toast">
        <h4 id="achievement-title">üèÜ Achievement Unlocked!</h4>
        <p id="achievement-desc">Description</p>
    </div>

    <!-- Points Award -->
    <div class="points-award" id="points-award">
        +500 Points!
    </div>

    <!-- Item Collected Toast -->
    <div class="item-collected-toast" id="item-collected-toast">
        ‚úì Items Added to Table!
    </div>

    <script>
        // ===== DATA =====
        const DATA = {
            carts: [
                { id: 'airway', name: 'Airway Cart', x: 0.2, y: 0.3, color: '#4CAF50' },
                { id: 'med', name: 'Medication Cart', x: 0.8, y: 0.3, color: '#2196F3' },
                { id: 'code', name: 'Code Cart', x: 0.2, y: 0.7, color: '#F44336' },
                { id: 'trauma', name: 'Trauma Cart', x: 0.8, y: 0.7, color: '#FF9800' },
                { id: 'inventory', name: 'Procedure Table', x: 0.5, y: 0.5, color: '#17a2b8', isInventory: true }
            ],
            drawers: [
                { id: 'd1', cart: 'airway', name: 'Top Drawer', number: 1 },
                { id: 'd2', cart: 'airway', name: 'Middle Drawer', number: 2 },
                { id: 'd3', cart: 'airway', name: 'Bottom Drawer', number: 3 },
                { id: 'd4', cart: 'med', name: 'Top Drawer', number: 1 },
                { id: 'd5', cart: 'med', name: 'Middle Drawer', number: 2 },
                { id: 'd6', cart: 'med', name: 'Bottom Drawer', number: 3 },
                { id: 'd7', cart: 'code', name: 'Top Drawer', number: 1 },
                { id: 'd8', cart: 'code', name: 'Middle Drawer', number: 2 },
                { id: 'd9', cart: 'code', name: 'Bottom Drawer', number: 3 },
                { id: 'd10', cart: 'trauma', name: 'Top Drawer', number: 1 },
                { id: 'd11', cart: 'trauma', name: 'Middle Drawer', number: 2 },
                { id: 'd12', cart: 'trauma', name: 'Bottom Drawer', number: 3 }
            ],
            items: [
                { id: 'ett', name: 'Endotracheal Tube', cart: 'airway', drawer: 'd1', image: 'images/ett.jpg' },
                { id: 'laryngoscope', name: 'Laryngoscope', cart: 'airway', drawer: 'd1', image: 'images/laryngoscope.jpg' },
                { id: 'bvm', name: 'Bag-Valve-Mask', cart: 'airway', drawer: 'd2', image: 'images/bvm.jpg' },
                { id: 'oropharyngeal', name: 'Oropharyngeal Airway', cart: 'airway', drawer: 'd2', image: 'images/oropharyngeal.jpg' },
                { id: 'suction', name: 'Suction Catheter', cart: 'airway', drawer: 'd3', image: 'images/suction.jpg' },
                { id: 'oxygen', name: 'Oxygen Mask', cart: 'airway', drawer: 'd3', image: 'images/oxygen.jpg' },
                { id: 'epinephrine', name: 'Epinephrine', cart: 'med', drawer: 'd4', image: 'images/epinephrine.jpg' },
                { id: 'atropine', name: 'Atropine', cart: 'med', drawer: 'd4', image: 'images/atropine.jpg' },
                { id: 'amiodarone', name: 'Amiodarone', cart: 'med', drawer: 'd5', image: 'images/amiodarone.jpg' },
                { id: 'lidocaine', name: 'Lidocaine', cart: 'med', drawer: 'd5', image: 'images/lidocaine.jpg' },
                { id: 'morphine', name: 'Morphine', cart: 'med', drawer: 'd6', image: 'images/morphine.jpg' },
                { id: 'naloxone', name: 'Naloxone', cart: 'med', drawer: 'd6', image: 'images/naloxone.jpg' },
                { id: 'defibrillator', name: 'Defibrillator Pads', cart: 'code', drawer: 'd7', image: 'images/defibrillator.jpg' },
                { id: 'ecg', name: 'ECG Leads', cart: 'code', drawer: 'd7', image: 'images/ecg.jpg' },
                { id: 'iv-start', name: 'IV Start Kit', cart: 'code', drawer: 'd8', image: 'images/iv-start.jpg' },
                { id: 'saline', name: 'Saline Flush', cart: 'code', drawer: 'd8', image: 'images/saline.jpg' },
                { id: 'cpr-board', name: 'CPR Board', cart: 'code', drawer: 'd9', image: 'images/cpr-board.jpg' },
                { id: 'aed', name: 'AED', cart: 'code', drawer: 'd9', image: 'images/aed.jpg' },
                { id: 'chest-tube', name: 'Chest Tube Kit', cart: 'trauma', drawer: 'd10', image: 'images/chest-tube.jpg' },
                { id: 'scalpel', name: 'Scalpel', cart: 'trauma', drawer: 'd10', image: 'images/scalpel.jpg' },
                { id: 'gauze', name: 'Gauze Pads', cart: 'trauma', drawer: 'd11', image: 'images/gauze.jpg' },
                { id: 'tourniquet', name: 'Tourniquet', cart: 'trauma', drawer: 'd11', image: 'images/tourniquet.jpg' },
                { id: 'splint', name: 'Splint', cart: 'trauma', drawer: 'd12', image: 'images/splint.jpg' },
                { id: 'cervical-collar', name: 'Cervical Collar', cart: 'trauma', drawer: 'd12', image: 'images/cervical-collar.jpg' }
            ],
            scenarios: [
                {
                    id: 's1',
                    name: 'Cardiac Arrest',
                    description: 'Patient in cardiac arrest. Prepare for immediate resuscitation.',
                    essential: ['defibrillator', 'ecg', 'epinephrine', 'amiodarone'],
                    optional: ['cpr-board', 'iv-start', 'saline']
                },
                {
                    id: 's2',
                    name: 'Airway Obstruction',
                    description: 'Patient with complete airway obstruction requiring immediate intervention.',
                    essential: ['laryngoscope', 'ett', 'bvm', 'suction'],
                    optional: ['oropharyngeal', 'oxygen']
                },
                {
                    id: 's3',
                    name: 'Severe Trauma',
                    description: 'Multiple trauma patient with suspected internal bleeding.',
                    essential: ['gauze', 'tourniquet', 'chest-tube', 'iv-start'],
                    optional: ['cervical-collar', 'splint', 'scalpel']
                },
                {
                    id: 's4',
                    name: 'Anaphylaxis',
                    description: 'Severe allergic reaction with respiratory compromise.',
                    essential: ['epinephrine', 'oxygen', 'bvm', 'iv-start'],
                    optional: ['saline', 'ecg']
                },
                {
                    id: 's5',
                    name: 'Overdose',
                    description: 'Suspected opioid overdose with decreased respirations.',
                    essential: ['naloxone', 'bvm', 'oxygen', 'iv-start'],
                    optional: ['suction', 'ecg', 'saline']
                }
            ]
        };

        // Achievements definition
        const achievements = [
            { id: 'first-scenario', title: 'First Steps', description: 'Complete your first scenario', icon: 'üéØ' },
            { id: 'perfect-score', title: 'Perfectionist', description: 'Get a perfect score on any scenario', icon: 'üíØ' },
            { id: 'speed-demon', title: 'Speed Demon', description: 'Complete a scenario in under 30 seconds', icon: '‚ö°' },
            { id: 'efficient', title: 'Efficiency Expert', description: 'Perfect score with no extra items', icon: 'üéØ' },
            { id: 'three-scenarios', title: 'Getting the Hang of It', description: 'Complete 3 scenarios', icon: 'üî•' },
            { id: 'all-scenarios', title: 'Master Trainer', description: 'Complete all scenarios', icon: 'üèÜ' }
        ];

        // ===== STATE =====
        const state = {
            currentScenario: null,
            currentScenarioIndex: 0,
            scenariosUnlocked: 1,
            inventory: [],
            startTime: null,
            sessionId: Date.now(),
            selectedCart: null,
            selectedDrawer: null,
            selectedItems: [],
            hasSubmittedOnce: false,
            tutorialCompleted: false,
            completedScenarios: [],
            achievements: [],
            points: 0,
            totalPoints: 0,
            soundEnabled: true,
            hapticEnabled: true,
            sessionResults: []
        };

        // ===== CANVAS SETUP =====
        const canvas = document.getElementById('room-canvas');
        const ctx = canvas.getContext('2d');

        let canvasDPR = 1;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let lastTappedCart = null;
        let tapFeedbackTimeout = null;

        // Helper function to lighten colors
        function lightenColor(color, percent) {
            const num = parseInt(color.replace("#",""), 16);
            const amt = Math.round(2.55 * percent);
            const R = (num >> 16) + amt;
            const G = (num >> 8 & 0x00FF) + amt;
            const B = (num & 0x0000FF) + amt;
            return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 +
                (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255))
                .toString(16).slice(1);
        }

        function resizeCanvas() {
            canvasDPR = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();
            canvasWidth = rect.width;
            canvasHeight = rect.height;
            canvas.width = canvasWidth * canvasDPR;
            canvas.height = canvasHeight * canvasDPR;
            ctx.setTransform(1, 0, 0, 1, 0, 0);
            ctx.scale(canvasDPR, canvasDPR);
            drawRoom();
        }

        // NEW: Draw cart with visible drawers
        function drawCartWithDrawers(cart, x, y, size) {
            const drawerHeight = size / 4;
            const drawerCount = 3;
            
            // Cart frame/body - darker background
            ctx.fillStyle = '#444';
            ctx.fillRect(x - size/2, y - size/2 - 10, size, size + 20);
            
            // Draw 3 visible drawer fronts
            for (let i = 0; i < drawerCount; i++) {
                const drawerY = y - size/2 + (i * drawerHeight) + 8;
                
                // Drawer face with gradient for depth
                const gradient = ctx.createLinearGradient(x - size/2, drawerY, x + size/2, drawerY);
                const lightColor = lightenColor(cart.color, 15);
                gradient.addColorStop(0, cart.color);
                gradient.addColorStop(0.5, lightColor);
                gradient.addColorStop(1, cart.color);
                
                ctx.fillStyle = gradient;
                ctx.fillRect(x - size/2 + 8, drawerY, size - 16, drawerHeight - 8);
                
                // Drawer border for definition
                ctx.strokeStyle = 'rgba(0,0,0,0.4)';
                ctx.lineWidth = 2;
                ctx.strokeRect(x - size/2 + 8, drawerY, size - 16, drawerHeight - 8);
                
                // Inner shadow for depth
                ctx.strokeStyle = 'rgba(255,255,255,0.2)';
                ctx.lineWidth = 1;
                ctx.strokeRect(x - size/2 + 9, drawerY + 1, size - 18, drawerHeight - 10);
                
                // Drawer handle (horizontal bar)
                ctx.fillStyle = '#333';
                ctx.fillRect(x - size/4, drawerY + drawerHeight/2 - 3, size/2, 6);
                
                // Handle highlights
                ctx.fillStyle = 'rgba(255,255,255,0.3)';
                ctx.fillRect(x - size/4, drawerY + drawerHeight/2 - 3, size/2, 2);
                
                // Drawer number
                ctx.fillStyle = 'white';
                ctx.font = `bold ${size * 0.10}px Arial`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText(`${i + 1}`, x, drawerY + drawerHeight/2);
            }
            
            // Cart wheels
            ctx.fillStyle = '#222';
            const wheelSize = size * 0.10;
            ctx.beginPath();
            ctx.arc(x - size/3, y + size/2 + 10, wheelSize, 0, Math.PI * 2);
            ctx.arc(x + size/3, y + size/2 + 10, wheelSize, 0, Math.PI * 2);
            ctx.fill();
            
            // Wheel highlights
            ctx.fillStyle = 'rgba(255,255,255,0.3)';
            ctx.beginPath();
            ctx.arc(x - size/3 - wheelSize/3, y + size/2 + 10 - wheelSize/3, wheelSize/3, 0, Math.PI * 2);
            ctx.arc(x + size/3 - wheelSize/3, y + size/2 + 10 - wheelSize/3, wheelSize/3, 0, Math.PI * 2);
            ctx.fill();
            
            // Cart label at top
            ctx.fillStyle = 'white';
            ctx.font = `bold ${size * 0.12}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'bottom';
            ctx.shadowColor = 'rgba(0,0,0,0.5)';
            ctx.shadowBlur = 4;
            ctx.fillText(cart.name.split(' ')[0], x, y - size/2 - 12);
            ctx.shadowBlur = 0;
        }

        function drawRoom() {
            const rect = canvas.getBoundingClientRect();
            const width = rect.width;
            const height = rect.height;

            if (width === 0 || height === 0) {
                console.warn('Canvas dimensions not initialized, skipping draw');
                return;
            }

            canvasWidth = width;
            canvasHeight = height;
            ctx.clearRect(0, 0, width, height);

            // Draw carts and procedure table
            DATA.carts.forEach(cart => {
                const x = cart.x * width;
                const y = cart.y * height;
                const size = Math.min(width, height) * 0.22;

                const isTapped = lastTappedCart === cart.id;

                if (isTapped) {
                    ctx.shadowColor = 'rgba(255, 255, 255, 0.8)';
                    ctx.shadowBlur = 20;
                }

                if (cart.isInventory) {
                    // Special rendering for Procedure Table - make it look like a table
                    const tableWidth = size * 1.2;
                    const tableHeight = size * 0.6;
                    
                    // Table legs
                    ctx.fillStyle = '#666';
                    const legWidth = size * 0.08;
                    const legHeight = size * 0.3;
                    // Front left leg
                    ctx.fillRect(x - tableWidth/2 + legWidth, y + tableHeight/2 - 5, legWidth, legHeight);
                    // Front right leg
                    ctx.fillRect(x + tableWidth/2 - legWidth * 2, y + tableHeight/2 - 5, legWidth, legHeight);
                    // Back left leg (slightly visible)
                    ctx.fillRect(x - tableWidth/2 + legWidth * 1.5, y - tableHeight/2 + 5, legWidth * 0.7, legHeight * 0.8);
                    // Back right leg (slightly visible)
                    ctx.fillRect(x + tableWidth/2 - legWidth * 2.2, y - tableHeight/2 + 5, legWidth * 0.7, legHeight * 0.8);
                    
                    // Table top - with 3D effect
                    const gradient = ctx.createLinearGradient(x - tableWidth/2, y - tableHeight/2, x + tableWidth/2, y + tableHeight/2);
                    gradient.addColorStop(0, lightenColor(cart.color, 20));
                    gradient.addColorStop(0.5, cart.color);
                    gradient.addColorStop(1, lightenColor(cart.color, 10));
                    
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x - tableWidth/2, y - tableHeight/2, tableWidth, tableHeight);
                    
                    // Table top edge/border for depth
                    ctx.strokeStyle = 'rgba(0,0,0,0.4)';
                    ctx.lineWidth = 3;
                    ctx.strokeRect(x - tableWidth/2, y - tableHeight/2, tableWidth, tableHeight);
                    
                    // Highlight on top edge
                    ctx.strokeStyle = 'rgba(255,255,255,0.3)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.moveTo(x - tableWidth/2 + 2, y - tableHeight/2 + 2);
                    ctx.lineTo(x + tableWidth/2 - 2, y - tableHeight/2 + 2);
                    ctx.stroke();
                    
                    // Table label
                    ctx.fillStyle = 'white';
                    ctx.font = `bold ${size * 0.14}px Arial`;
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.shadowColor = 'rgba(0,0,0,0.6)';
                    ctx.shadowBlur = 4;
                    ctx.fillText('Procedure', x, y - size * 0.08);
                    ctx.fillText('Table', x, y + size * 0.08);
                    ctx.shadowBlur = 0;
                    
                    // Item count badge if items collected
                    if (state.inventory.length > 0) {
                        ctx.fillStyle = 'white';
                        ctx.font = `bold ${size * 0.12}px Arial`;
                        ctx.fillText(`(${state.inventory.length} items)`, x, y + tableHeight/2 + legHeight + size * 0.12);
                    }
                } else {
                    // Draw cart with visible drawers
                    drawCartWithDrawers(cart, x, y, size);
                }

                ctx.shadowBlur = 0;
            });
        }

        function handleCanvasInteraction(e) {
            e.preventDefault();

            let clientX, clientY;
            if (e.type === 'touchstart' || e.type === 'touchend') {
                const touch = e.touches[0] || e.changedTouches[0];
                if (!touch) return;
                clientX = touch.clientX;
                clientY = touch.clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const rect = canvas.getBoundingClientRect();
            const scrollX = window.pageXOffset || document.documentElement.scrollLeft;
            const scrollY = window.pageYOffset || document.documentElement.scrollTop;
            const x = clientX - rect.left - scrollX;
            const y = clientY - rect.top - scrollY;
            const width = rect.width;
            const height = rect.height;

            let hitAnyCart = false;

            DATA.carts.forEach(cart => {
                const cartX = cart.x * width;
                const cartY = cart.y * height;
                const size = Math.min(width, height) * 0.22;
                const dx = Math.abs(x - cartX);
                const dy = Math.abs(y - cartY);
                const hitRadius = size / 2;

                if (dx < hitRadius && dy < hitRadius) {
                    hitAnyCart = true;
                    lastTappedCart = cart.id;
                    drawRoom();

                    clearTimeout(tapFeedbackTimeout);
                    tapFeedbackTimeout = setTimeout(() => {
                        lastTappedCart = null;
                        drawRoom();
                    }, 200);

                    openCart(cart);
                    playSound('click');
                    triggerHaptic('light');
                }
            });
        }

        canvas.addEventListener('click', handleCanvasInteraction);
        canvas.addEventListener('touchstart', handleCanvasInteraction, { passive: false });

        // ===== SCENARIOS =====
        function openScenariosModal() {
            loadScenarios();
            document.getElementById('scenarios-modal').classList.add('active');
            playSound('click');
        }

        function loadScenarios() {
            const list = document.getElementById('scenarios-list');
            list.innerHTML = '';
            
            DATA.scenarios.forEach((scenario, index) => {
                const div = document.createElement('div');
                div.className = 'scenario-item';
                
                const isCompleted = state.completedScenarios.includes(scenario.id);
                const isUnlocked = index < state.scenariosUnlocked;
                
                if (isCompleted) div.classList.add('completed');
                if (!isUnlocked) div.classList.add('locked');
                if (state.currentScenario?.id === scenario.id) div.classList.add('active');
                
                div.innerHTML = `
                    <h4>${scenario.name}</h4>
                    <p>${scenario.description}</p>
                `;
                
                if (isUnlocked) {
                    div.onclick = () => selectScenario(scenario, index);
                }
                
                list.appendChild(div);
            });
            
            updateProgressBadge();
        }

        function updateProgressBadge() {
            document.getElementById('progress-badge-modal').textContent = 
                `${state.completedScenarios.length}/${DATA.scenarios.length}`;
        }

        function selectScenario(scenario, index) {
            state.currentScenario = scenario;
            state.currentScenarioIndex = index;
            state.inventory = [];
            state.startTime = Date.now();
            state.hasSubmittedOnce = false;
            
            document.getElementById('scenario-name').textContent = scenario.name;
            document.getElementById('task-description').textContent = scenario.description;
            document.getElementById('scenario-description').classList.add('active');
            document.getElementById('submit-btn-yellow').disabled = true;
            document.getElementById('restart-btn').style.display = 'inline-block';
            document.getElementById('advance-btn').style.display = 'none';
            
            document.getElementById('scenario-feedback').classList.remove('active', 'success', 'partial', 'error');
            document.getElementById('scenario-feedback').innerHTML = '';
            
            document.getElementById('room-hint').textContent = 'Tap a cart to open its drawers';
            document.getElementById('room-hint').classList.remove('hidden');
            
            updateInventoryDisplay();
            updateStats();
            
            closeModal('scenarios-modal');
            playSound('click');
        }

        // ===== CART & DRAWER NAVIGATION =====
        // Helper to get drawer IDs for a cart
        function getDrawerIds(cart) {
            return DATA.drawers.filter(d => d.cart === cart.id).map(d => d.id);
        }

        // Helper to check if drawer has essential items for current scenario
        function drawerHasEssentialItems(drawerId) {
            if (!state.currentScenario) return false;
            const drawerItems = DATA.items.filter(i => i.drawer === drawerId);
            return drawerItems.some(item => state.currentScenario.essential.includes(item.id));
        }

        // Helper to get item count in drawer
        function getDrawerItemCount(drawerId) {
            return DATA.items.filter(i => i.drawer === drawerId).length;
        }

        function openCart(cart) {
            if (!state.currentScenario) {
                alert('Please select a scenario first!');
                return;
            }

            if (cart.isInventory) {
                openInventoryModal();
                return;
            }

            state.selectedCart = cart;
            document.getElementById('cart-modal-title').textContent = `${cart.name}`;

            const modalBody = document.getElementById('cart-modal-body');
            const drawers = DATA.drawers.filter(d => d.cart === cart.id);
            
            // Calculate lighter color for gradient
            const lightColor = lightenColor(cart.color, 20);
            
            let html = '<div class="cart-visual-container">';
            html += `<div class="cart-label">${cart.name}</div>`;
            html += '<div class="cart-visual">';
            
            drawers.forEach(drawer => {
                const itemCount = getDrawerItemCount(drawer.id);
                const hasEssential = drawerHasEssentialItems(drawer.id);
                const essentialClass = hasEssential ? 'drawer-has-essential' : '';
                
                html += `
                    <div class="drawer-visual ${essentialClass}" 
                         data-drawer="${drawer.id}" 
                         onclick="openDrawer('${drawer.id}')"
                         style="--drawer-color: ${cart.color}; --drawer-color-light: ${lightColor}">
                        <div class="drawer-face">
                            <div class="drawer-label">
                                ${drawer.name}
                                <span class="drawer-item-count">${itemCount} items</span>
                            </div>
                            <div class="drawer-handle"></div>
                        </div>
                    </div>
                `;
            });
            
            html += '</div></div>';
            modalBody.innerHTML = html;

            document.getElementById('cart-modal').classList.add('active');
            document.getElementById('room-hint').classList.add('hidden');
        }

        function openDrawer(drawerId) {
            const drawer = DATA.drawers.find(d => d.id === drawerId);
            if (!drawer) return;
            
            state.selectedDrawer = drawer;
            
            // Animate drawer sliding out
            const drawerElement = document.querySelector(`[data-drawer="${drawerId}"]`);
            if (drawerElement) {
                drawerElement.style.transform = 'translateX(20px)';
                drawerElement.style.transition = 'transform 0.3s cubic-bezier(0.4, 0, 0.2, 1)';
                
                // Play drawer open sound
                playSound('collect');
                
                setTimeout(() => {
                    drawerElement.style.transform = '';
                }, 300);
            }
            
            // Show items after brief delay for animation
            setTimeout(() => {
                showDrawerItems(drawer);
            }, 150);
        }

        function showDrawerItems(drawer) {
            document.getElementById('item-modal-title').textContent = `${drawer.name} - Select Items`;

            const itemGrid = document.getElementById('item-grid');
            itemGrid.innerHTML = '';

            const drawerItems = DATA.items.filter(i => i.drawer === drawer.id);
            drawerItems.forEach(item => {
                const div = document.createElement('div');
                div.className = 'item-card';

                if (state.inventory.find(i => i.id === item.id)) {
                    div.classList.add('in-inventory');
                }

                if (state.selectedItems.find(i => i.id === item.id)) {
                    div.classList.add('selected');
                }

                const iconDiv = document.createElement('div');
                iconDiv.className = 'item-icon';

                if (item.image) {
                    iconDiv.classList.add('loading');
                    const img = document.createElement('img');
                    img.src = item.image;
                    img.alt = item.name;

                    img.onload = () => {
                        iconDiv.classList.remove('loading');
                        iconDiv.textContent = '';
                        iconDiv.appendChild(img);
                    };

                    img.onerror = () => {
                        iconDiv.classList.remove('loading');
                        iconDiv.textContent = item.name.substring(0, 2).toUpperCase();
                    };
                } else {
                    iconDiv.textContent = item.name.substring(0, 2).toUpperCase();
                }

                const nameEl = document.createElement('h5');
                nameEl.textContent = item.name;

                div.appendChild(iconDiv);
                div.appendChild(nameEl);

                div.onclick = () => toggleItemSelection(item, div);
                itemGrid.appendChild(div);
            });

            closeModal('cart-modal');
            document.getElementById('item-modal').classList.add('active');
        }

        function toggleItemSelection(item, element) {
            const index = state.selectedItems.findIndex(i => i.id === item.id);
            
            if (index > -1) {
                state.selectedItems.splice(index, 1);
                element.classList.remove('selected');
            } else {
                state.selectedItems.push(item);
                element.classList.add('selected');
            }
            
            playSound('click');
        }

        function collectSelectedItems() {
            if (state.selectedItems.length === 0) {
                alert('Please select at least one item!');
                return;
            }

            let itemsAdded = 0;
            state.selectedItems.forEach(item => {
                if (!state.inventory.find(i => i.id === item.id)) {
                    state.inventory.push({...item});
                    itemsAdded++;
                    playSound('collect');
                    triggerHaptic('light');
                }
            });

            if (itemsAdded > 0) {
                showItemCollectedFeedback(itemsAdded);
            }

            state.selectedItems = [];
            updateInventoryDisplay();
            updateStats();

            if (state.selectedDrawer) {
                openDrawer(state.selectedDrawer.id);
            }
        }

        function showItemCollectedFeedback(count) {
            const toast = document.getElementById('item-collected-toast');
            const itemText = count === 1 ? '1 Item' : `${count} Items`;
            toast.textContent = `‚úì ${itemText} Added to Table!`;
            toast.classList.add('show');

            const statItems = document.getElementById('stat-items').parentElement;
            statItems.classList.add('stat-pulse');

            setTimeout(() => {
                toast.classList.remove('show');
            }, 600);

            setTimeout(() => {
                statItems.classList.remove('stat-pulse');
            }, 400);

            drawRoom();
        }

        function backToCart() {
            closeModal('item-modal');
            if (state.selectedCart) {
                openCart(state.selectedCart);
            }
        }

        // ===== INVENTORY - PROCEDURE TABLE =====
        function openInventoryModal() {
            updateInventoryModalDisplay();
            document.getElementById('inventory-modal').classList.add('active');
            playSound('click');
        }

        function updateInventoryModalDisplay() {
            const container = document.getElementById('inventory-modal-items');
            document.getElementById('inventory-count').textContent = state.inventory.length;

            if (state.inventory.length === 0) {
                container.innerHTML = '<div class="procedure-table-empty">No items collected yet</div>';
            } else {
                container.innerHTML = '';
                state.inventory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'procedure-table-item';

                    let itemBadge = '';
                    if (state.currentScenario) {
                        if (state.currentScenario.essential.includes(item.id)) {
                            itemBadge = '<span class="item-badge badge-essential">Essential</span>';
                        } else if (state.currentScenario.optional.includes(item.id)) {
                            itemBadge = '<span class="item-badge badge-optional">Optional</span>';
                        }
                    }

                    div.innerHTML = `
                        <div class="procedure-table-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                        <div class="procedure-table-info">
                            <strong>${item.name}${itemBadge}</strong>
                            <small>${item.cart} ‚Üí ${item.drawer}</small>
                        </div>
                        <button class="procedure-table-remove" onclick="removeItemFromModal(${index})">‚úï</button>
                    `;
                    container.appendChild(div);
                });
            }
        }

        function updateInventoryDisplay() {
            const submitBtn = document.getElementById('submit-btn-yellow');
            submitBtn.disabled = state.inventory.length === 0;
            drawRoom();
        }

        function removeItemFromModal(index) {
            state.inventory.splice(index, 1);
            updateInventoryModalDisplay();
            updateInventoryDisplay();
            updateStats();
            playSound('click');
        }

        // ===== FEEDBACK & SCORING =====
        function submitInventory() {
            const scenario = state.currentScenario;
            if (!scenario) return;
            
            const collectedIds = state.inventory.map(i => i.id);
            const foundEssential = scenario.essential.filter(id => collectedIds.includes(id));
            const missingEssential = scenario.essential.filter(id => !collectedIds.includes(id));
            const foundOptional = scenario.optional.filter(id => collectedIds.includes(id));
            const missingOptional = scenario.optional.filter(id => !collectedIds.includes(id));
            const extra = collectedIds.filter(id =>
                !scenario.essential.includes(id) && !scenario.optional.includes(id));

            const timeElapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const allEssential = missingEssential.length === 0;
            const allRequired = allEssential && missingOptional.length === 0;
            const noExtras = extra.length === 0;

            const essentialScore = (foundEssential.length / scenario.essential.length) * 60;
            const optionalScore = scenario.optional.length > 0 ? 
                (foundOptional.length / scenario.optional.length) * 20 : 20;
            const penaltyScore = extra.length * 5;
            const totalScore = Math.max(0, Math.round(essentialScore + optionalScore - penaltyScore));

            let stars = 0;
            if (allRequired && noExtras && timeElapsed < 60) stars = 5;
            else if (allRequired && noExtras) stars = 4;
            else if (allRequired) stars = 3;
            else if (allEssential) stars = 2;
            else if (foundEssential.length > 0) stars = 1;

            let feedbackClass, feedbackTitle, feedbackMessage;
            let bonusPoints = 0;

            if (allRequired) {
                feedbackClass = 'success';
                feedbackTitle = '‚úì Perfect!';
                feedbackMessage = 'You collected all required items correctly!';
                bonusPoints = 500;
                playSound('success');
                triggerHaptic('heavy');
            } else if (allEssential) {
                feedbackClass = 'partial';
                feedbackTitle = '‚ö† Good, but incomplete';
                feedbackMessage = 'You got all essential items, but missed some recommended ones.';
                bonusPoints = 200;
                playSound('success');
                triggerHaptic('medium');
            } else {
                feedbackClass = 'error';
                feedbackTitle = '‚úó Missing Critical Items';
                feedbackMessage = 'You are missing essential items for this procedure.';
                playSound('error');
                triggerHaptic('heavy');
            }

            if (timeElapsed < 60 && allEssential) {
                bonusPoints += 300;
                feedbackMessage += ' Amazing speed!';
            }

            if (bonusPoints > 0) {
                setTimeout(() => {
                    awardPoints(bonusPoints, 'Completion Bonus!');
                }, 500);
            }

            if (allEssential && !state.completedScenarios.includes(scenario.id)) {
                state.completedScenarios.push(scenario.id);
                saveUserProgress();
            }

            let starsHTML = '<div class="star-rating">';
            for (let i = 0; i < 5; i++) {
                starsHTML += `<span class="star ${i < stars ? 'filled' : ''}">‚òÖ</span>`;
            }
            starsHTML += '</div>';

            const essentialProgress = (foundEssential.length / scenario.essential.length) * 100;
            const optionalProgress = scenario.optional.length > 0 ? 
                (foundOptional.length / scenario.optional.length) * 100 : 0;

            let detailsHTML = '<div style="margin: 15px 0;">';
            detailsHTML += '<div style="margin-bottom: 10px;">';
            detailsHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
            detailsHTML += '<small><strong>Essential Items</strong></small>';
            detailsHTML += `<small>${foundEssential.length}/${scenario.essential.length}</small>`;
            detailsHTML += '</div>';
            detailsHTML += '<div class="progress-container">';
            detailsHTML += `<div class="progress-bar" style="width: ${essentialProgress}%"></div>`;
            detailsHTML += '</div>';
            detailsHTML += '</div>';

            if (scenario.optional.length > 0) {
                detailsHTML += '<div style="margin-bottom: 10px;">';
                detailsHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
                detailsHTML += '<small><strong>Optional Items</strong></small>';
                detailsHTML += `<small>${foundOptional.length}/${scenario.optional.length}</small>`;
                detailsHTML += '</div>';
                detailsHTML += '<div class="progress-container">';
                detailsHTML += `<div class="progress-bar" style="width: ${optionalProgress}%"></div>`;
                detailsHTML += '</div>';
                detailsHTML += '</div>';
            }
            detailsHTML += '</div>';

            let missedItemsHTML = '';

            if (missingEssential.length > 0) {
                missedItemsHTML += '<div class="missed-items-section">';
                missedItemsHTML += '<h4>‚ùå Missing Essential Items</h4>';
                missedItemsHTML += '<div class="missed-items-list">';
                missingEssential.forEach(itemId => {
                    const item = DATA.items.find(i => i.id === itemId);
                    if (item) {
                        missedItemsHTML += `
                            <div class="missed-item">
                                <div class="missed-item-icon essential">${item.name.substring(0, 2).toUpperCase()}</div>
                                <div class="missed-item-info">
                                    <strong>${item.name}</strong>
                                    <small>Location: ${item.cart} ‚Üí ${item.drawer}</small>
                                </div>
                            </div>
                        `;
                    }
                });
                missedItemsHTML += '</div></div>';
            }

            if (missingOptional.length > 0) {
                missedItemsHTML += '<div class="missed-items-section">';
                missedItemsHTML += '<h4>‚ö†Ô∏è Missing Optional Items</h4>';
                missedItemsHTML += '<div class="missed-items-list">';
                missingOptional.forEach(itemId => {
                    const item = DATA.items.find(i => i.id === itemId);
                    if (item) {
                        missedItemsHTML += `
                            <div class="missed-item">
                                <div class="missed-item-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                                <div class="missed-item-info">
                                    <strong>${item.name}</strong>
                                    <small>Location: ${item.cart} ‚Üí ${item.drawer}</small>
                                </div>
                            </div>
                        `;
                    }
                });
                missedItemsHTML += '</div></div>';
            }

            const feedbackModalTitle = document.getElementById('feedback-modal-title');
            const feedbackModalBody = document.getElementById('feedback-modal-body');

            feedbackModalTitle.textContent = feedbackTitle;
            feedbackModalBody.innerHTML = `
                ${starsHTML}
                <div style="text-align: center; margin: 15px 0;">
                    <p style="font-size: 15px; color: #666; margin-bottom: 10px;">${feedbackMessage}</p>
                    <p style="font-size: 18px; font-weight: bold; color: #007bff;">
                        Score: ${totalScore}/100
                    </p>
                    <p style="font-size: 14px; color: #666; margin-top: 5px;">
                        ‚è±Ô∏è Time: ${formatTime(timeElapsed)}
                    </p>
                </div>
                ${detailsHTML}
                ${missedItemsHTML}
            `;

            const feedbackModalFooter = document.getElementById('feedback-modal-footer');
            let footerButtons = '<button class="btn-secondary" onclick="closeModal(\'feedback-modal\')">Close</button>';
            footerButtons += '<button class="btn-primary restart-btn" onclick="closeModal(\'feedback-modal\'); retryScenario()">üîÑ Try Again</button>';

            if (state.currentScenarioIndex < DATA.scenarios.length - 1) {
                footerButtons += '<button class="btn-primary advance-btn" onclick="closeModal(\'feedback-modal\'); continueToNext()">‚Üí Next Scenario</button>';
            } else {
                footerButtons += '<button class="btn-primary advance-btn" onclick="closeModal(\'feedback-modal\'); continueToNext()">üéâ Complete Training</button>';
            }

            feedbackModalFooter.innerHTML = footerButtons;

            document.getElementById('feedback-modal').classList.add('active');

            state.hasSubmittedOnce = true;

            state.sessionResults.push({
                scenarioName: scenario.name,
                score: totalScore,
                stars: stars,
                timeElapsed: timeElapsed,
                timestamp: new Date().toISOString(),
                feedbackClass: feedbackClass
            });

            setTimeout(() => {
                if (state.completedScenarios.length === 1) {
                    checkAchievement('first-scenario');
                }
                if (allRequired) {
                    checkAchievement('perfect-score');
                }
                if (allRequired && timeElapsed < 30) {
                    checkAchievement('speed-demon');
                }
                if (allRequired && noExtras) {
                    checkAchievement('efficient');
                }
                if (state.completedScenarios.length >= 3) {
                    checkAchievement('three-scenarios');
                }
                if (state.completedScenarios.length === DATA.scenarios.length) {
                    checkAchievement('all-scenarios');
                }
            }, 800);

            saveAnalytics({
                sessionId: state.sessionId,
                scenarioId: scenario.id,
                scenarioName: scenario.name,
                timestamp: new Date().toISOString(),
                timeElapsed: timeElapsed,
                itemsCollected: collectedIds,
                foundEssential: foundEssential,
                missingEssential: missingEssential,
                foundOptional: foundOptional,
                extra: extra,
                correct: allRequired,
                score: totalScore,
                stars: stars,
                pointsEarned: state.points,
                totalPoints: state.totalPoints,
                achievements: state.achievements.length
            });
            
            loadScenarios();
        }

        function retryScenario() {
            state.inventory = [];
            state.startTime = Date.now();
            state.hasSubmittedOnce = false;

            document.getElementById('scenario-feedback').classList.remove('active', 'success', 'partial', 'error');
            document.getElementById('scenario-feedback').innerHTML = '';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('room-hint').textContent = 'Tap a cart to open its drawers';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();
            playSound('click');
        }

        function continueToNext() {
            if (state.currentScenarioIndex === DATA.scenarios.length - 1) {
                completeTraining();
                return;
            }

            state.currentScenarioIndex++;

            if (state.currentScenarioIndex >= state.scenariosUnlocked) {
                state.scenariosUnlocked = state.currentScenarioIndex + 1;
            }

            state.inventory = [];
            state.currentScenario = null;
            state.startTime = null;
            state.hasSubmittedOnce = false;

            document.getElementById('scenario-description').classList.remove('active');
            document.getElementById('scenario-feedback').classList.remove('active', 'success', 'partial', 'error');
            document.getElementById('scenario-feedback').innerHTML = '';
            document.getElementById('restart-btn').style.display = 'none';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('scenario-name').textContent = 'Select the next scenario';
            document.getElementById('room-hint').textContent = 'Open Scenarios menu to begin next scenario';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();
            updateProgressBadge();

            openScenariosModal();
            playSound('click');
        }

        function completeTraining() {
            alert(`üéâ Training Complete!\n\nCongratulations! You've completed all training scenarios.\n\nTotal Points Earned: ${state.totalPoints} pts\nAchievements Unlocked: ${state.achievements.length}/${achievements.length}`);
            
            state.currentScenarioIndex = 0;
            state.scenariosUnlocked = 1;
            state.inventory = [];
            state.currentScenario = null;
            state.startTime = null;
            state.hasSubmittedOnce = false;
            state.completedScenarios = [];

            document.getElementById('scenario-description').classList.remove('active');
            document.getElementById('scenario-feedback').classList.remove('active');
            document.getElementById('scenario-feedback').innerHTML = '';
            document.getElementById('restart-btn').style.display = 'none';
            document.getElementById('advance-btn').style.display = 'none';

            document.getElementById('scenario-name').textContent = 'Select a scenario to begin';
            document.getElementById('room-hint').textContent = 'Open Scenarios menu to begin training';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();
            updateProgressBadge();
            
            saveUserProgress();
            playSound('success');
        }

        // ===== GAMIFICATION =====
        function awardPoints(points, message) {
            state.points += points;
            state.totalPoints += points;
            
            const pointsAward = document.getElementById('points-award');
            pointsAward.textContent = `+${points} ${message}`;
            pointsAward.classList.add('show');
            
            setTimeout(() => {
                pointsAward.classList.remove('show');
            }, 2000);
            
            saveUserProgress();
        }

        function checkAchievement(achievementId) {
            if (state.achievements.includes(achievementId)) return;
            
            const achievement = achievements.find(a => a.id === achievementId);
            if (!achievement) return;
            
            unlockAchievement(achievement);
        }

        function unlockAchievement(achievement) {
            state.achievements.push(achievement.id);
            
            const toast = document.getElementById('achievement-toast');
            document.getElementById('achievement-title').textContent = `${achievement.icon} ${achievement.title}`;
            document.getElementById('achievement-desc').textContent = achievement.description;
            toast.classList.add('show');
            
            playSound('success');
            triggerHaptic('heavy');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 4000);
            
            awardPoints(100, 'Achievement!');
            
            saveUserProgress();
        }

        // ===== AUDIO & HAPTICS =====
        let audioContext = null;

        function getAudioContext() {
            if (!audioContext) {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                } catch (e) {
                    console.warn('AudioContext not supported');
                    return null;
                }
            }

            if (audioContext.state === 'suspended') {
                audioContext.resume();
            }

            return audioContext;
        }

        const sounds = {
            click: () => playTone(800, 0.1, 0.05),
            collect: () => playTone(1200, 0.15, 0.1),
            success: () => {
                playTone(800, 0.1, 0.1);
                setTimeout(() => playTone(1000, 0.1, 0.1), 100);
                setTimeout(() => playTone(1200, 0.2, 0.15), 200);
            },
            error: () => {
                playTone(400, 0.15, 0.1);
                setTimeout(() => playTone(300, 0.2, 0.1), 150);
            }
        };

        function playSound(soundName) {
            if (!state.soundEnabled) return;
            if (sounds[soundName]) {
                sounds[soundName]();
            }
        }

        function playTone(frequency, duration, volume = 0.1) {
            const ctx = getAudioContext();
            if (!ctx) return;

            try {
                const oscillator = ctx.createOscillator();
                const gainNode = ctx.createGain();

                oscillator.connect(gainNode);
                gainNode.connect(ctx.destination);

                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';

                gainNode.gain.setValueAtTime(volume, ctx.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + duration);

                oscillator.start(ctx.currentTime);
                oscillator.stop(ctx.currentTime + duration);
            } catch (e) {
                console.warn('Error playing tone:', e);
            }
        }

        function triggerHaptic(intensity) {
            if (!state.hapticEnabled) return;
            if (navigator.vibrate) {
                const patterns = {
                    light: [10],
                    medium: [20],
                    heavy: [30, 10, 30]
                };
                navigator.vibrate(patterns[intensity] || [10]);
            }
        }

        // ===== SETTINGS =====
        function openSettingsModal() {
            document.getElementById('settings-modal').classList.add('active');
            document.getElementById('sound-toggle').checked = state.soundEnabled;
            document.getElementById('haptic-toggle').checked = state.hapticEnabled;
            
            updateResultsList();
        }

        function updateResultsList() {
            const resultsList = document.getElementById('results-list');
            
            if (state.sessionResults.length === 0) {
                resultsList.innerHTML = '<div class="procedure-table-empty">No results yet. Complete a scenario to see your performance!</div>';
            } else {
                resultsList.innerHTML = '';
                state.sessionResults.forEach(result => {
                    const div = document.createElement('div');
                    div.className = 'result-item';
                    
                    let starsDisplay = '';
                    for (let i = 0; i < 5; i++) {
                        starsDisplay += i < result.stars ? '‚≠ê' : '‚òÜ';
                    }
                    
                    div.innerHTML = `
                        <h4>${result.scenarioName}</h4>
                        <p>Score: <strong>${result.score}/100</strong> | ${starsDisplay}</p>
                        <p>Time: ${formatTime(result.timeElapsed)}</p>
                        <p style="font-size: 10px; color: #999;">${new Date(result.timestamp).toLocaleString()}</p>
                    `;
                    resultsList.appendChild(div);
                });
            }
        }

        function toggleSound() {
            state.soundEnabled = document.getElementById('sound-toggle').checked;
            saveUserProgress();
            playSound('click');
        }

        function toggleHaptic() {
            state.hapticEnabled = document.getElementById('haptic-toggle').checked;
            saveUserProgress();
        }

        function resetProgress() {
            if (!confirm('Are you sure you want to reset ALL progress? This cannot be undone!')) {
                return;
            }
            
            localStorage.removeItem('cabinetQuestProgress');
            localStorage.removeItem('analytics');
            location.reload();
        }

        // ===== STATS =====
        function updateStats() {
            if (state.startTime) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                document.getElementById('stat-time').textContent = formatTime(elapsed);
            }
            document.getElementById('stat-items').textContent = state.inventory.length;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        setInterval(() => {
            if (state.startTime) updateStats();
        }, 1000);

        // ===== PERSISTENCE =====
        function saveUserProgress() {
            localStorage.setItem('cabinetQuestProgress', JSON.stringify({
                completedScenarios: state.completedScenarios,
                achievements: state.achievements,
                totalPoints: state.totalPoints,
                scenariosUnlocked: state.scenariosUnlocked,
                soundEnabled: state.soundEnabled,
                hapticEnabled: state.hapticEnabled,
                tutorialCompleted: state.tutorialCompleted
            }));
        }

        function loadUserProgress() {
            const saved = localStorage.getItem('cabinetQuestProgress');
            if (saved) {
                const data = JSON.parse(saved);
                state.completedScenarios = data.completedScenarios || [];
                state.achievements = data.achievements || [];
                state.totalPoints = data.totalPoints || 0;
                state.scenariosUnlocked = data.scenariosUnlocked || 1;
                state.soundEnabled = data.soundEnabled !== undefined ? data.soundEnabled : true;
                state.hapticEnabled = data.hapticEnabled !== undefined ? data.hapticEnabled : true;
                state.tutorialCompleted = data.tutorialCompleted || false;
            }
        }

        // ===== ANALYTICS =====
        function saveAnalytics(data) {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            analytics.push(data);
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        function exportAnalytics() {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            const dataStr = JSON.stringify(analytics, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `cabinet-quest-analytics-${Date.now()}.json`;
            link.click();
            playSound('click');
        }

        // ===== MODALS =====
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ===== TUTORIAL =====
        let currentTutorialStep = 0;
        const totalTutorialSteps = 6;

        function initTutorial() {
            currentTutorialStep = 0;
            updateTutorialDisplay();
        }

        function updateTutorialDisplay() {
            const progressContainer = document.getElementById('tutorial-progress');
            progressContainer.innerHTML = '';
            for (let i = 0; i < totalTutorialSteps; i++) {
                const dot = document.createElement('div');
                dot.className = `tutorial-dot ${i === currentTutorialStep ? 'active' : ''}`;
                progressContainer.appendChild(dot);
            }

            const steps = document.querySelectorAll('.tutorial-step');
            steps.forEach((step, index) => {
                step.classList.toggle('active', index === currentTutorialStep);
            });

            const prevBtn = document.getElementById('tutorial-prev');
            const nextBtn = document.getElementById('tutorial-next');

            prevBtn.style.display = currentTutorialStep > 0 ? 'inline-block' : 'none';

            if (currentTutorialStep === totalTutorialSteps - 1) {
                nextBtn.textContent = 'üöÄ Start Training!';
                nextBtn.onclick = startTutorial;
            } else {
                nextBtn.textContent = 'Next ‚Üí';
                nextBtn.onclick = nextTutorialStep;
            }
        }

        function nextTutorialStep() {
            if (currentTutorialStep < totalTutorialSteps - 1) {
                currentTutorialStep++;
                updateTutorialDisplay();
                playSound('click');
            }
        }

        function prevTutorialStep() {
            if (currentTutorialStep > 0) {
                currentTutorialStep--;
                updateTutorialDisplay();
                playSound('click');
            }
        }

        function startTutorial() {
            closeModal('tutorial-modal');
            openScenariosModal();
            playSound('click');
        }

        // ===== INIT =====
        function init() {
            resizeCanvas();

            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(resizeCanvas, 100);
            });

            setTimeout(() => {
                requestAnimationFrame(resizeCanvas);
            }, 100);

            loadUserProgress();
            updateStats();

            initTutorial();
            document.getElementById('tutorial-modal').classList.add('active');
        }

        window.onload = init;
    </script>
</body>
</html>
