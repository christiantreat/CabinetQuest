<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trauma Room Trainer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            overflow: hidden;
            height: 100vh;
            position: fixed;
            width: 100%;
        }

        /* Main Container - Full Screen */
        .app-container {
            height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Compact Header */
        .header {
            background: white;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
            flex-shrink: 0;
        }

        .header h1 {
            font-size: 16px;
            color: #333;
        }

        .header-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 5px;
        }

        .scenario-name {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        .stats-compact {
            display: flex;
            gap: 15px;
            font-size: 12px;
        }

        .stat-compact {
            color: #007bff;
            font-weight: bold;
        }

        .stat-compact .label {
            color: #999;
            font-weight: normal;
            margin-left: 2px;
        }

        /* Room View - Takes remaining space */
        .room-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fafafa;
        }

        #room-canvas {
            width: 100%;
            height: 100%;
            display: block;
            touch-action: none;
        }

        /* Room Hint Overlay */
        .room-hint {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 243, 205, 0.95);
            color: #856404;
            padding: 15px 20px;
            border-radius: 8px;
            font-size: 14px;
            text-align: center;
            max-width: 80%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            pointer-events: none;
            z-index: 50;
        }

        .room-hint.hidden {
            display: none;
        }

        /* Bottom Drawer */
        /* ADJUSTMENT: Control drawer heights and animations here */
        .bottom-drawer {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 -2px 20px rgba(0,0,0,0.15);
            transition: height 0.3s ease;  /* ADJUST: Change animation speed here */
            z-index: 200;
            display: flex;
            flex-direction: column;
            max-height: 85vh;
        }

        /* ADJUSTMENT: Set specific heights for each drawer state */
        .bottom-drawer.peek {
            height: 80px;      /* ADJUST: Collapsed height */
        }

        .bottom-drawer.half {
            height: 50vh;      /* ADJUST: Medium height (50% of viewport) */
        }

        .bottom-drawer.full {
            height: 85vh;      /* ADJUST: Expanded height (85% of viewport) */
        }

        /* Drawer Handle */
        /* ADJUSTMENT: Make handle bigger/more visible here */
        .drawer-handle {
            width: 50px;           /* ADJUST: Increase width for easier grabbing */
            height: 5px;           /* ADJUST: Increase height for easier grabbing */
            background: #999;      /* ADJUST: Make darker to be more visible */
            border-radius: 3px;
            margin: 12px auto;
            cursor: grab;
            flex-shrink: 0;
        }

        .drawer-handle:active {
            cursor: grabbing;
            background: #666;      /* Darker when grabbed */
        }
        
        /* ADJUSTMENT: Make entire handle area tappable, not just the bar */
        .drawer-handle-area {
            padding: 15px 0;       /* ADJUST: Increase padding for larger touch area */
            cursor: grab;
            position: relative;
            touch-action: none;    /* Prevents default touch behaviors */
        }
        
        .drawer-handle-area:active {
            cursor: grabbing;
            background: rgba(0,0,0,0.03);
        }
        
        /* ADJUSTMENT: Optional hint text below handle - comment out to remove */
        .drawer-handle-area::after {
            content: 'Drag or tap';  /* ADJUST: Change hint text here */
            position: absolute;
            bottom: 2px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            color: #999;
            pointer-events: none;
        }
        
        /* Hide hint when drawer is expanded */
        .bottom-drawer.full .drawer-handle-area::after,
        .bottom-drawer.half .drawer-handle-area::after {
            opacity: 0;
        }

        /* Drawer Tabs */
        .drawer-tabs {
            display: flex;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
            padding: 0 15px;
        }

        .drawer-tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            touch-action: manipulation;
            position: relative;
        }

        .drawer-tab.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .drawer-tab .badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #007bff;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: bold;
        }

        /* Drawer Content */
        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }

        .drawer-pane {
            display: none;
        }

        .drawer-pane.active {
            display: block;
        }

        /* Scenario List */
        .scenario-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .scenario-item {
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            touch-action: manipulation;
            transition: all 0.2s;
        }

        .scenario-item:active {
            transform: scale(0.98);
        }

        .scenario-item.active {
            border-color: #007bff;
            background: #e7f3ff;
        }

        .scenario-item h3 {
            font-size: 14px;
            color: #333;
            margin-bottom: 4px;
        }

        .scenario-item p {
            font-size: 12px;
            color: #666;
            line-height: 1.3;
        }

        /* Inventory */
        .inventory-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 15px;
        }

        .inventory-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background: #f8f9fa;
        }

        .item-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 12px;
            flex-shrink: 0;
        }

        .item-info {
            flex: 1;
            min-width: 0;
        }

        .item-info strong {
            display: block;
            font-size: 13px;
            color: #333;
        }

        .item-info small {
            font-size: 11px;
            color: #666;
        }

        .remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 3px;
            font-size: 12px;
            cursor: pointer;
            flex-shrink: 0;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 13px;
        }

        .submit-btn {
            width: 100%;
            background: #28a745;
            color: white;
            border: none;
            padding: 14px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            touch-action: manipulation;
        }

        .submit-btn:disabled {
            background: #ccc;
        }

        /* Feedback */
        .feedback {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .feedback.success {
            background: #d4edda;
            border: 2px solid #28a745;
            color: #155724;
        }

        .feedback.partial {
            background: #fff3cd;
            border: 2px solid #ffc107;
            color: #856404;
        }

        .feedback.error {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
        }

        .feedback h3 {
            margin-bottom: 8px;
            font-size: 15px;
        }

        .feedback ul {
            margin-left: 18px;
            margin-top: 8px;
            line-height: 1.5;
        }

        .feedback-actions {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .feedback-actions button {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Modals */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: white;
            padding: 20px;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
            max-height: 70vh;
            overflow-y: auto;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
        }

        .modal h2 {
            margin-bottom: 15px;
            color: #333;
            font-size: 16px;
        }

        .modal-close {
            float: right;
            background: #6c757d;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 3px;
            font-size: 16px;
            cursor: pointer;
        }

        .drawer-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        .drawer-item {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            cursor: pointer;
            text-align: center;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            touch-action: manipulation;
        }

        .drawer-item:active {
            transform: scale(0.98);
        }

        .drawer-item strong {
            display: block;
            margin-bottom: 4px;
            color: #333;
            font-size: 13px;
        }

        .drawer-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            border-radius: 10px;
            padding: 2px 6px;
            font-size: 10px;
            margin-left: 4px;
        }

        .drawer-badge.empty {
            background: #ddd;
            color: #999;
        }

        .item-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .item-card {
            border: 2px solid #ddd;
            border-radius: 5px;
            padding: 12px;
            cursor: pointer;
            text-align: center;
            min-height: 100px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            touch-action: manipulation;
        }

        .item-card:active {
            transform: scale(0.98);
        }

        .item-card.selected {
            border-color: #28a745;
            background: #d4edda;
        }

        .item-card .item-icon {
            width: 50px;
            height: 50px;
            margin: 0 auto 8px;
            font-size: 14px;
        }

        .item-card strong {
            font-size: 12px;
            line-height: 1.2;
            color: #333;
        }

        .item-card small {
            font-size: 10px;
            color: #666;
            margin-top: 4px;
        }

        .add-items-btn {
            width: 100%;
            background: #007bff;
            color: white;
            border: none;
            padding: 12px;
            border-radius: 5px;
            font-size: 14px;
            font-weight: bold;
        }

        /* Tutorial Overlay */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .tutorial-overlay.active {
            display: flex;
        }

        .tutorial-box {
            background: white;
            padding: 25px;
            border-radius: 15px;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
        }

        .tutorial-box h2 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 20px;
        }

        .tutorial-box p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .tutorial-step {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #007bff;
            text-align: left;
        }

        .tutorial-step strong {
            color: #333;
            display: block;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .tutorial-step small {
            color: #666;
            font-size: 12px;
        }

        .tutorial-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 15px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
        }

        .tutorial-skip {
            background: transparent;
            color: #999;
            border: none;
            padding: 10px;
            font-size: 13px;
            cursor: pointer;
            margin-top: 10px;
        }

        /* Gamification Elements */
        .achievement-popup {
            position: fixed;
            top: 80px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            z-index: 1500;
            transform: translateX(400px);
            transition: transform 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            max-width: 280px;
        }

        .achievement-popup.show {
            transform: translateX(0);
        }

        .achievement-popup .achievement-icon {
            font-size: 30px;
            margin-bottom: 5px;
        }

        .achievement-popup h4 {
            margin: 0 0 5px 0;
            font-size: 14px;
        }

        .achievement-popup p {
            margin: 0;
            font-size: 12px;
            opacity: 0.9;
        }

        .score-display {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 12px 18px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            z-index: 150;
            display: none;
        }

        .score-display.show {
            display: block;
            animation: slideDown 0.4s ease;
        }

        .score-display .score-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .score-display .score-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
            margin-left: 5px;
        }

        .badge-container {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .badge {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 3px 10px rgba(255, 215, 0, 0.4);
            position: relative;
        }

        .badge.locked {
            background: #ddd;
            filter: grayscale(100%);
            opacity: 0.5;
        }

        .badge-tooltip {
            position: absolute;
            bottom: -30px;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 10px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .badge:hover .badge-tooltip {
            opacity: 1;
        }

        /* Progress Bar */
        .progress-container {
            width: 100%;
            background: #e0e0e0;
            border-radius: 10px;
            height: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #28a745 0%, #20c997 100%);
            border-radius: 10px;
            transition: width 0.5s ease;
            position: relative;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer 2s infinite;
        }

        /* Visual Feedback Animations */
        .particle {
            position: absolute;
            pointer-events: none;
            font-size: 20px;
            animation: particleRise 1s ease-out forwards;
            z-index: 3000;
        }

        @keyframes particleRise {
            0% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
            100% {
                opacity: 0;
                transform: translateY(-100px) scale(1.5);
            }
        }

        .success-checkmark {
            position: absolute;
            font-size: 60px;
            color: #28a745;
            animation: checkmarkPop 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            pointer-events: none;
            z-index: 3000;
        }

        @keyframes checkmarkPop {
            0% {
                transform: scale(0) rotate(-180deg);
                opacity: 0;
            }
            50% {
                transform: scale(1.2) rotate(0deg);
            }
            100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
        }

        .pulse-effect {
            animation: pulse 0.3s ease;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }

        @keyframes slideUp {
            from {
                transform: translateY(50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        /* Settings Panel */
        .settings-icon {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            cursor: pointer;
            z-index: 150;
            font-size: 20px;
        }

        .settings-icon:active {
            transform: scale(0.95);
        }

        .settings-panel {
            position: fixed;
            top: 70px;
            left: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
            padding: 15px;
            z-index: 200;
            display: none;
            min-width: 200px;
        }

        .settings-panel.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .settings-option {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }

        .settings-option:last-child {
            border-bottom: none;
        }

        .settings-option label {
            font-size: 13px;
            color: #333;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            background: #ccc;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .toggle-switch.active {
            background: #28a745;
        }

        .toggle-switch::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            background: white;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: left 0.3s;
        }

        .toggle-switch.active::after {
            left: 22px;
        }

        /* Star Rating */
        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 30px;
            margin: 15px 0;
            justify-content: center;
        }

        .star {
            color: #ddd;
        }

        .star.filled {
            color: #ffd700;
            animation: starPop 0.3s ease;
        }

        @keyframes starPop {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.3);
            }
        }

        /* Improved Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 13px;
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .empty-state-title {
            font-size: 16px;
            font-weight: bold;
            color: #666;
            margin-bottom: 8px;
        }

        .empty-state-hint {
            font-size: 13px;
            color: #999;
            line-height: 1.5;
        }

        /* Contextual Tooltip */
        .contextual-hint {
            position: absolute;
            background: #007bff;
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 12px;
            z-index: 500;
            box-shadow: 0 3px 10px rgba(0, 123, 255, 0.3);
            animation: bounce 2s infinite;
            pointer-events: none;
        }

        .contextual-hint::after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border-style: solid;
        }

        .contextual-hint.top::after {
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            border-width: 8px 8px 0 8px;
            border-color: #007bff transparent transparent transparent;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }
    </style>
</head>
<body>
    <!-- Settings Icon -->
    <div class="settings-icon" id="settings-icon" onclick="toggleSettings()">
        ‚öôÔ∏è
    </div>

    <!-- Settings Panel -->
    <div class="settings-panel" id="settings-panel">
        <div class="settings-option">
            <label>Sound Effects</label>
            <div class="toggle-switch" id="sound-toggle" onclick="toggleSound()"></div>
        </div>
        <div class="settings-option">
            <label>Haptic Feedback</label>
            <div class="toggle-switch" id="haptic-toggle" onclick="toggleHaptic()"></div>
        </div>
        <div class="settings-option">
            <label>Show Tutorial</label>
            <div class="toggle-switch" id="tutorial-toggle" onclick="showTutorial()"></div>
        </div>
    </div>

    <!-- Score Display -->
    <div class="score-display" id="score-display">
        <span class="score-label">SCORE</span>
        <span class="score-value" id="score-value">0</span>
    </div>

    <!-- Achievement Popup -->
    <div class="achievement-popup" id="achievement-popup">
        <div class="achievement-icon" id="achievement-icon">üèÜ</div>
        <h4 id="achievement-title">Achievement Unlocked!</h4>
        <p id="achievement-desc">First Cart Opened</p>
    </div>

    <!-- Tutorial Overlay -->
    <div class="tutorial-overlay" id="tutorial-overlay">
        <div class="tutorial-box">
            <h2>üëã Welcome to Trauma Room Trainer!</h2>
            <p>Learn how to efficiently collect medical supplies in emergency scenarios.</p>

            <div class="tutorial-step">
                <strong>üìã Step 1: Choose a Scenario</strong>
                <small>Select a training scenario from the bottom drawer</small>
            </div>

            <div class="tutorial-step">
                <strong>üöë Step 2: Explore Carts</strong>
                <small>Tap on colored carts to view their drawers</small>
            </div>

            <div class="tutorial-step">
                <strong>üì¶ Step 3: Collect Items</strong>
                <small>Select items from drawers and add them to your inventory</small>
            </div>

            <div class="tutorial-step">
                <strong>‚úÖ Step 4: Submit & Learn</strong>
                <small>Review your performance and earn badges!</small>
            </div>

            <button class="tutorial-btn" onclick="closeTutorial()">Let's Start!</button>
            <button class="tutorial-skip" onclick="closeTutorial()">Skip Tutorial</button>
        </div>
    </div>

    <div class="app-container">
        <!-- Compact Header -->
        <div class="header">
            <h1>Trauma Room Trainer</h1>
            <div class="header-info">
                <div class="scenario-name" id="scenario-name">Select a scenario below ‚Üì</div>
                <div class="stats-compact">
                    <span class="stat-compact"><span id="stat-time">0:00</span> <span class="label">time</span></span>
                    <span class="stat-compact"><span id="stat-items">0</span> <span class="label">items</span></span>
                </div>
            </div>
        </div>

        <!-- Room View - Full Screen Background -->
        <div class="room-container">
            <div class="room-hint" id="room-hint">
                Select a scenario from the drawer below to begin
            </div>
            <canvas id="room-canvas"></canvas>
        </div>

        <!-- Bottom Drawer -->
        <div class="bottom-drawer peek" id="bottom-drawer">
            <!-- ADJUSTMENT: This entire area is draggable, not just the bar -->
            <div class="drawer-handle-area" id="drawer-handle-area">
                <div class="drawer-handle" id="drawer-handle"></div>
            </div>
            
            <div class="drawer-tabs">
                <div class="drawer-tab active" data-tab="scenarios">Scenarios</div>
                <div class="drawer-tab" data-tab="inventory">
                    Inventory
                    <span class="badge" id="inventory-badge">0</span>
                </div>
                <div class="drawer-tab" data-tab="feedback">Results</div>
            </div>

            <div class="drawer-content">
                <!-- Scenarios Tab -->
                <div class="drawer-pane active" id="pane-scenarios">
                    <div class="scenario-list" id="scenario-list"></div>
                </div>

                <!-- Inventory Tab -->
                <div class="drawer-pane" id="pane-inventory">
                    <div class="inventory-list" id="inventory-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">üì¶</div>
                            <div class="empty-state-title">No Items Collected Yet</div>
                            <div class="empty-state-hint">
                                Choose a scenario and tap on carts to collect medical supplies
                            </div>
                        </div>
                    </div>
                    <button class="submit-btn" id="submit-btn" onclick="submitInventory()" disabled>
                        ‚úÖ Submit for Feedback
                    </button>
                </div>

                <!-- Feedback Tab -->
                <div class="drawer-pane" id="pane-feedback">
                    <div id="feedback-content">
                        <div class="empty-state">
                            <div class="empty-state-icon">üìä</div>
                            <div class="empty-state-title">No Results Yet</div>
                            <div class="empty-state-hint">
                                Complete a scenario and submit your inventory to see performance feedback
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cart Modal -->
    <div id="cart-modal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('cart-modal')">‚úï</button>
            <h2 id="cart-modal-title">Select Drawer</h2>
            <div class="drawer-grid" id="drawer-grid"></div>
        </div>
    </div>

    <!-- Item Modal -->
    <div id="item-modal" class="modal-overlay">
        <div class="modal">
            <button class="modal-close" onclick="closeModal('item-modal')">‚úï</button>
            <h2 id="item-modal-title">Select Items</h2>
            <div class="item-grid" id="item-grid"></div>
            <button class="add-items-btn" onclick="addSelectedItems()">Add to Inventory</button>
        </div>
    </div>

    <script src="data:text/javascript;base64,<?php echo base64_encode(file_get_contents('script.js')); ?>"></script>
    <script>
        // ===== DATA =====
        const DATA = {
            carts: [
                {
                    id: 'cart-1', name: 'Airway Cart', color: '#FF6B6B',
                    drawers: [
                        { id: 'd1', name: 'Drawer 1', items: ['item-1', 'item-2', 'item-3'] },
                        { id: 'd2', name: 'Drawer 2', items: ['item-11', 'item-12'] },
                        { id: 'd3', name: 'Drawer 3', items: [] },
                        { id: 'd4', name: 'Drawer 4', items: [] },
                        { id: 'd5', name: 'Drawer 5', items: [] },
                        { id: 'd6', name: 'Drawer 6', items: [] },
                        { id: 'd7', name: 'Drawer 7', items: [] },
                        { id: 'd8', name: 'Drawer 8', items: [] }
                    ]
                },
                {
                    id: 'cart-2', name: 'IV Line Cart', color: '#4ECDC4',
                    drawers: [
                        { id: 'd1', name: 'Drawer 1', items: ['item-6', 'item-7'] },
                        { id: 'd2', name: 'Drawer 2', items: ['item-8', 'item-9', 'item-10'] },
                        { id: 'd3', name: 'Drawer 3', items: ['item-4', 'item-5'] },
                        { id: 'd4', name: 'Drawer 4', items: [] },
                        { id: 'd5', name: 'Drawer 5', items: [] },
                        { id: 'd6', name: 'Drawer 6', items: [] },
                        { id: 'd7', name: 'Drawer 7', items: [] },
                        { id: 'd8', name: 'Drawer 8', items: [] }
                    ]
                },
                {
                    id: 'cart-3', name: 'Procedure Cart', color: '#95E1D3',
                    drawers: [
                        { id: 'd1', name: 'Drawer 1', items: ['item-13', 'item-14', 'item-15'] },
                        { id: 'd2', name: 'Drawer 2', items: [] },
                        { id: 'd3', name: 'Drawer 3', items: [] },
                        { id: 'd4', name: 'Drawer 4', items: [] },
                        { id: 'd5', name: 'Drawer 5', items: [] },
                        { id: 'd6', name: 'Drawer 6', items: [] },
                        { id: 'd7', name: 'Drawer 7', items: [] },
                        { id: 'd8', name: 'Drawer 8', items: [] }
                    ]
                }
            ],
            items: [
                { id: 'item-1', name: 'Gloves (Small)', category: 'PPE' },
                { id: 'item-2', name: 'Gloves (Medium)', category: 'PPE' },
                { id: 'item-3', name: 'Gloves (Large)', category: 'PPE' },
                { id: 'item-4', name: 'Chlorhexidine', category: 'Antiseptic' },
                { id: 'item-5', name: 'Sterile Drape', category: 'Sterile' },
                { id: 'item-6', name: 'Arterial Line Kit', category: 'Line Supplies' },
                { id: 'item-7', name: 'Pressure Transducer', category: 'Line Supplies' },
                { id: 'item-8', name: 'Lidocaine 1%', category: 'Medications' },
                { id: 'item-9', name: 'Syringes (5mL)', category: 'Supplies' },
                { id: 'item-10', name: 'Needles (25G)', category: 'Supplies' },
                { id: 'item-11', name: 'Gauze 4x4', category: 'Supplies' },
                { id: 'item-12', name: 'Tape (Silk)', category: 'Supplies' },
                { id: 'item-13', name: 'Chest Tube Tray', category: 'Procedure' },
                { id: 'item-14', name: 'Scalpel #10', category: 'Instruments' },
                { id: 'item-15', name: 'Hemostats', category: 'Instruments' }
            ],
            scenarios: [
                {
                    id: 'scenario-1',
                    name: 'Arterial Line Preparation',
                    description: 'Collect all supplies needed for arterial line placement',
                    essential: ['item-6', 'item-7', 'item-4', 'item-2'],
                    optional: ['item-5', 'item-8', 'item-9', 'item-10']
                },
                {
                    id: 'scenario-2',
                    name: 'Find Specific Items',
                    description: 'Locate: Gloves (M), Pressure Transducer, and Syringes',
                    essential: ['item-2', 'item-7', 'item-9'],
                    optional: []
                },
                {
                    id: 'scenario-3',
                    name: 'Chest Tube Setup',
                    description: 'Gather supplies for chest tube insertion',
                    essential: ['item-13', 'item-14', 'item-2', 'item-4'],
                    optional: ['item-11', 'item-8', 'item-15']
                }
            ]
        };

        // ===== STATE =====
        let state = {
            currentScenario: null,
            inventory: [],
            selectedItems: [],
            selectedCart: null,
            selectedDrawer: null,
            startTime: null,
            sessionId: Date.now(),
            drawerState: 'peek', // peek, half, full
            score: 0,
            achievements: [],
            soundEnabled: true,
            hapticEnabled: true,
            tutorialCompleted: false,
            cartsOpened: 0,
            drawersOpened: 0,
            itemsCollected: 0,
            scenariosCompleted: 0,
            perfectScores: 0
        };

        // ===== GAMIFICATION & ACHIEVEMENTS =====
        const ACHIEVEMENTS = [
            { id: 'first-cart', name: 'Curious Explorer', desc: 'Open your first cart', icon: 'üö™', points: 10 },
            { id: 'first-item', name: 'Item Collector', desc: 'Collect your first item', icon: 'üì¶', points: 10 },
            { id: 'first-scenario', name: 'Getting Started', desc: 'Complete your first scenario', icon: 'üéØ', points: 25 },
            { id: 'perfect-score', name: 'Perfectionist', desc: 'Get a perfect score', icon: '‚≠ê', points: 50 },
            { id: 'speed-demon', name: 'Speed Demon', desc: 'Complete scenario in under 60 seconds', icon: '‚ö°', points: 75 },
            { id: 'three-scenarios', name: 'Dedicated Learner', desc: 'Complete all 3 scenarios', icon: 'üèÜ', points: 100 },
            { id: 'efficient', name: 'Efficient Collector', desc: 'Complete scenario with no extra items', icon: 'üíé', points: 50 }
        ];

        // Load saved state
        function loadSavedState() {
            const saved = localStorage.getItem('userState');
            if (saved) {
                const savedState = JSON.parse(saved);
                state.achievements = savedState.achievements || [];
                state.score = savedState.score || 0;
                state.tutorialCompleted = savedState.tutorialCompleted || false;
                state.scenariosCompleted = savedState.scenariosCompleted || 0;
                state.perfectScores = savedState.perfectScores || 0;
                state.soundEnabled = savedState.soundEnabled !== undefined ? savedState.soundEnabled : true;
                state.hapticEnabled = savedState.hapticEnabled !== undefined ? savedState.hapticEnabled : true;
            }
        }

        // Save state
        function saveState() {
            localStorage.setItem('userState', JSON.stringify({
                achievements: state.achievements,
                score: state.score,
                tutorialCompleted: state.tutorialCompleted,
                scenariosCompleted: state.scenariosCompleted,
                perfectScores: state.perfectScores,
                soundEnabled: state.soundEnabled,
                hapticEnabled: state.hapticEnabled
            }));
        }

        // Check and award achievement
        function checkAchievement(achievementId) {
            if (state.achievements.includes(achievementId)) return;

            const achievement = ACHIEVEMENTS.find(a => a.id === achievementId);
            if (achievement) {
                state.achievements.push(achievementId);
                state.score += achievement.points;
                showAchievement(achievement);
                updateScoreDisplay();
                saveState();
                playSound('achievement');
                triggerHaptic('medium');
            }
        }

        // Show achievement popup
        function showAchievement(achievement) {
            const popup = document.getElementById('achievement-popup');
            document.getElementById('achievement-icon').textContent = achievement.icon;
            document.getElementById('achievement-title').textContent = achievement.name;
            document.getElementById('achievement-desc').textContent = `${achievement.desc} (+${achievement.points} pts)`;

            popup.classList.add('show');
            setTimeout(() => {
                popup.classList.remove('show');
            }, 3000);
        }

        // Update score display
        function updateScoreDisplay() {
            document.getElementById('score-value').textContent = state.score;
            if (state.score > 0) {
                document.getElementById('score-display').classList.add('show');
            }
        }

        // ===== SOUND EFFECTS =====
        function playSound(type) {
            if (!state.soundEnabled) return;

            // Using Web Audio API for simple beeps
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();

            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);

            switch(type) {
                case 'click':
                    oscillator.frequency.value = 800;
                    gainNode.gain.value = 0.1;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.05);
                    break;
                case 'collect':
                    oscillator.frequency.value = 1000;
                    gainNode.gain.value = 0.15;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.1);
                    break;
                case 'achievement':
                    oscillator.frequency.value = 1200;
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
                case 'success':
                    oscillator.frequency.value = 1400;
                    gainNode.gain.value = 0.2;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.3);
                    break;
                case 'error':
                    oscillator.frequency.value = 300;
                    gainNode.gain.value = 0.15;
                    oscillator.start();
                    oscillator.stop(audioContext.currentTime + 0.2);
                    break;
            }
        }

        // ===== HAPTIC FEEDBACK =====
        function triggerHaptic(intensity = 'light') {
            if (!state.hapticEnabled) return;
            if ('vibrate' in navigator) {
                switch(intensity) {
                    case 'light':
                        navigator.vibrate(10);
                        break;
                    case 'medium':
                        navigator.vibrate(25);
                        break;
                    case 'strong':
                        navigator.vibrate(50);
                        break;
                }
            }
        }

        // ===== VISUAL FEEDBACK =====
        function createParticle(x, y, emoji) {
            const particle = document.createElement('div');
            particle.className = 'particle';
            particle.textContent = emoji;
            particle.style.left = x + 'px';
            particle.style.top = y + 'px';
            document.body.appendChild(particle);

            setTimeout(() => {
                particle.remove();
            }, 1000);
        }

        function showSuccessCheckmark(x, y) {
            const checkmark = document.createElement('div');
            checkmark.className = 'success-checkmark';
            checkmark.textContent = '‚úì';
            checkmark.style.left = x + 'px';
            checkmark.style.top = y + 'px';
            document.body.appendChild(checkmark);

            setTimeout(() => {
                checkmark.remove();
            }, 600);
        }

        function pulseElement(element) {
            element.classList.add('pulse-effect');
            setTimeout(() => {
                element.classList.remove('pulse-effect');
            }, 300);
        }

        // ===== SETTINGS =====
        function toggleSettings() {
            const panel = document.getElementById('settings-panel');
            panel.classList.toggle('show');
            playSound('click');
        }

        function toggleSound() {
            state.soundEnabled = !state.soundEnabled;
            const toggle = document.getElementById('sound-toggle');
            toggle.classList.toggle('active');
            playSound('click');
            saveState();
        }

        function toggleHaptic() {
            state.hapticEnabled = !state.hapticEnabled;
            const toggle = document.getElementById('haptic-toggle');
            toggle.classList.toggle('active');
            triggerHaptic('light');
            saveState();
        }

        // ===== TUTORIAL =====
        function showTutorial() {
            document.getElementById('tutorial-overlay').classList.add('active');
        }

        function closeTutorial() {
            document.getElementById('tutorial-overlay').classList.remove('active');
            state.tutorialCompleted = true;
            saveState();
        }

        // ===== DRAWER HANDLING =====
        /* ADJUSTMENT: Modify drawer behavior here */
        let touchStartY = 0;
        let currentDrawerHeight = 0;
        const drawer = document.getElementById('bottom-drawer');
        const handleArea = document.getElementById('drawer-handle-area');  // Using larger area, not just handle

        /* ADJUSTMENT: Change these height thresholds for drawer states */
        const DRAWER_HEIGHTS = {
            peek: 80,      // ADJUST: Minimum collapsed height (in pixels)
            half: 0.5,     // ADJUST: Medium height (as fraction of viewport: 0.5 = 50%)
            full: 0.85     // ADJUST: Maximum expanded height (as fraction of viewport: 0.85 = 85%)
        };

        // Make the entire handle area draggable
        handleArea.addEventListener('touchstart', (e) => {
            touchStartY = e.touches[0].clientY;
            const rect = drawer.getBoundingClientRect();
            currentDrawerHeight = window.innerHeight - rect.top;
            // Prevent any scrolling during drag
            e.preventDefault();
        }, { passive: false });

        handleArea.addEventListener('touchmove', (e) => {
            e.preventDefault(); // Critical: prevents page scrolling
            
            const touchY = e.touches[0].clientY;
            const deltaY = touchStartY - touchY;  // Positive = dragging up
            const newHeight = currentDrawerHeight + deltaY;
            const vh = window.innerHeight;
            
            /* ADJUSTMENT: Modify these thresholds to change when drawer snaps */
            if (newHeight < 150) {                    // ADJUST: Below this = peek
                setDrawerState('peek');
            } else if (newHeight < vh * 0.65) {       // ADJUST: Below this = half  
                setDrawerState('half');
            } else {                                   // ADJUST: Above = full
                setDrawerState('full');
            }
        }, { passive: false });

        handleArea.addEventListener('touchend', () => {
            // Snap to final position
            drawer.style.transition = 'height 0.3s ease';
            setTimeout(() => {
                drawer.style.transition = '';
            }, 300);
        });

        function setDrawerState(newState) {
            drawer.className = `bottom-drawer ${newState}`;
            state.drawerState = newState;
        }

        /* ADJUSTMENT: Add tap-to-toggle functionality - tap handle to cycle through states */
        handleArea.addEventListener('click', () => {
            if (state.drawerState === 'peek') {
                setDrawerState('half');
            } else if (state.drawerState === 'half') {
                setDrawerState('full');
            } else {
                setDrawerState('peek');
            }
        });

        // Tab switching
        document.querySelectorAll('.drawer-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const tabName = tab.dataset.tab;
                
                // Update tabs
                document.querySelectorAll('.drawer-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                // Update panes
                document.querySelectorAll('.drawer-pane').forEach(p => p.classList.remove('active'));
                document.getElementById(`pane-${tabName}`).classList.add('active');
                
                // Expand drawer when switching tabs
                if (state.drawerState === 'peek') {
                    setDrawerState('half');
                }
            });
        });

        // ===== INIT =====
        function init() {
            loadSavedState();
            loadScenarios();
            drawRoom();
            setupCanvas();
            updateScoreDisplay();

            // Initialize settings toggles
            if (state.soundEnabled) {
                document.getElementById('sound-toggle').classList.add('active');
            }
            if (state.hapticEnabled) {
                document.getElementById('haptic-toggle').classList.add('active');
            }

            // Show tutorial for first-time users
            if (!state.tutorialCompleted) {
                setTimeout(() => {
                    showTutorial();
                }, 500);
            }
        }

        function loadScenarios() {
            const list = document.getElementById('scenario-list');
            DATA.scenarios.forEach(scenario => {
                const div = document.createElement('div');
                div.className = 'scenario-item';
                div.innerHTML = `
                    <h3>${scenario.name}</h3>
                    <p>${scenario.description}</p>
                `;
                div.onclick = () => selectScenario(scenario, div);
                list.appendChild(div);
            });
        }

        function selectScenario(scenario, element) {
            state.currentScenario = scenario;
            state.inventory = [];
            state.startTime = Date.now();

            // Update UI
            document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('scenario-name').textContent = scenario.name;
            document.getElementById('room-hint').textContent = 'Tap a cart to open';
            document.getElementById('feedback-content').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">üìä</div>
                    <div class="empty-state-title">No Results Yet</div>
                    <div class="empty-state-hint">
                        Complete the scenario and submit your inventory to see performance feedback
                    </div>
                </div>
            `;

            updateInventoryDisplay();
            updateStats();

            // UX Enhancements
            playSound('click');
            triggerHaptic('light');
            pulseElement(element);

            // Switch to inventory tab and minimize drawer
            setTimeout(() => {
                document.querySelector('[data-tab="inventory"]').click();
                setDrawerState('peek');
            }, 300);
        }

        // ===== ROOM DRAWING =====
        function setupCanvas() {
            const canvas = document.getElementById('room-canvas');
            const container = canvas.parentElement;
            
            function resizeCanvas() {
                canvas.width = container.clientWidth;
                canvas.height = container.clientHeight;
                drawRoom();
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
        }

        function drawRoom() {
            const canvas = document.getElementById('room-canvas');
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Room outline
            ctx.strokeStyle = '#ddd';
            ctx.lineWidth = 2;
            ctx.strokeRect(15, 15, canvas.width - 30, canvas.height - 30);

            // Calculate cart dimensions
            const cartWidth = canvas.width * 0.22;
            const cartHeight = canvas.height * 0.35;
            const spacing = (canvas.width - (cartWidth * 3)) / 4;

            // Position carts
            DATA.carts.forEach((cart, index) => {
                const x = spacing + (index * (cartWidth + spacing));
                const y = canvas.height * 0.4;

                // Shadow
                ctx.shadowColor = 'rgba(0, 0, 0, 0.15)';
                ctx.shadowBlur = 10;
                ctx.shadowOffsetX = 0;
                ctx.shadowOffsetY = 4;

                // Cart body
                ctx.fillStyle = cart.color;
                ctx.fillRect(x, y, cartWidth, cartHeight);
                
                ctx.shadowColor = 'transparent';
                
                ctx.strokeStyle = '#333';
                ctx.lineWidth = 2;
                ctx.strokeRect(x, y, cartWidth, cartHeight);

                // Label
                ctx.fillStyle = '#fff';
                const fontSize = Math.max(11, cartWidth * 0.11);
                ctx.font = `bold ${fontSize}px sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                const words = cart.name.split(' ');
                const lineHeight = fontSize * 1.3;
                const startY = y + cartHeight / 2 - ((words.length - 1) * lineHeight) / 2;
                
                words.forEach((word, i) => {
                    ctx.fillText(word, x + cartWidth / 2, startY + i * lineHeight);
                });

                // Drawers
                const drawerHeight = cartHeight / 8;
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.25)';
                ctx.lineWidth = 1.5;
                for (let i = 1; i < 8; i++) {
                    ctx.beginPath();
                    ctx.moveTo(x, y + drawerHeight * i);
                    ctx.lineTo(x + cartWidth, y + drawerHeight * i);
                    ctx.stroke();
                }

                cart.hitArea = { x, y, width: cartWidth, height: cartHeight };
            });
        }

        // ===== CANVAS INTERACTION =====
        function handleCanvasClick(e) {
            if (!state.currentScenario) {
                setDrawerState('half');
                document.querySelector('[data-tab="scenarios"]').click();
                return;
            }

            const canvas = document.getElementById('room-canvas');
            const rect = canvas.getBoundingClientRect();
            
            let clientX, clientY;
            if (e.type.startsWith('touch')) {
                e.preventDefault();
                clientX = e.touches[0].clientX;
                clientY = e.touches[0].clientY;
            } else {
                clientX = e.clientX;
                clientY = e.clientY;
            }

            const x = (clientX - rect.left) * (canvas.width / rect.width);
            const y = (clientY - rect.top) * (canvas.height / rect.height);

            const clickedCart = DATA.carts.find(cart => {
                const hit = cart.hitArea;
                return hit && x >= hit.x && x <= hit.x + hit.width &&
                       y >= hit.y && y <= hit.y + hit.height;
            });

            if (clickedCart) {
                openCart(clickedCart);
            }
        }

        document.getElementById('room-canvas').addEventListener('click', handleCanvasClick);
        document.getElementById('room-canvas').addEventListener('touchstart', handleCanvasClick);

        // ===== CART & DRAWER =====
        function openCart(cart) {
            state.selectedCart = cart;
            state.cartsOpened++;
            document.getElementById('cart-modal-title').textContent = cart.name;

            const grid = document.getElementById('drawer-grid');
            grid.innerHTML = '';

            cart.drawers.forEach(drawer => {
                const itemCount = drawer.items.length;
                const div = document.createElement('div');
                div.className = 'drawer-item';

                const badge = itemCount > 0
                    ? `<span class="drawer-badge">${itemCount}</span>`
                    : `<span class="drawer-badge empty">Empty</span>`;

                div.innerHTML = `<strong>${drawer.name}${badge}</strong><small style="margin-top: 4px; display: block; color: #666;">${itemCount > 0 ? 'Tap to view' : 'No items'}</small>`;

                if (itemCount > 0) {
                    div.onclick = () => openDrawer(drawer);
                } else {
                    div.style.opacity = '0.5';
                }

                grid.appendChild(div);
            });

            document.getElementById('cart-modal').classList.add('active');

            // UX Enhancements
            playSound('click');
            triggerHaptic('light');

            // Check achievement
            if (state.cartsOpened === 1) {
                checkAchievement('first-cart');
            }
        }

        function openDrawer(drawer) {
            state.selectedDrawer = drawer;
            state.selectedItems = [];
            
            document.getElementById('item-modal-title').textContent = 
                `${state.selectedCart.name} - ${drawer.name}`;

            const grid = document.getElementById('item-grid');
            grid.innerHTML = '';

            drawer.items.forEach(itemId => {
                const item = DATA.items.find(i => i.id === itemId);
                if (item) {
                    const div = document.createElement('div');
                    div.className = 'item-card';
                    div.innerHTML = `
                        <div class="item-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                        <strong>${item.name}</strong>
                        <small>${item.category}</small>
                    `;
                    div.onclick = () => toggleItemSelection(div, item);
                    grid.appendChild(div);
                }
            });

            closeModal('cart-modal');
            document.getElementById('item-modal').classList.add('active');
        }

        function toggleItemSelection(element, item) {
            const index = state.selectedItems.findIndex(i => i.id === item.id);
            if (index > -1) {
                state.selectedItems.splice(index, 1);
                element.classList.remove('selected');
            } else {
                state.selectedItems.push(item);
                element.classList.add('selected');
            }
        }

        function addSelectedItems() {
            const newItemsCount = state.selectedItems.length;

            state.selectedItems.forEach(item => {
                if (!state.inventory.find(i => i.id === item.id)) {
                    state.inventory.push({
                        ...item,
                        cart: state.selectedCart.name,
                        drawer: state.selectedDrawer.name
                    });
                    state.itemsCollected++;
                }
            });

            // UX Enhancements - Visual Feedback
            if (newItemsCount > 0) {
                // Play collect sound
                playSound('collect');
                triggerHaptic('medium');

                // Create particles at modal center
                const modal = document.getElementById('item-modal');
                const rect = modal.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                for (let i = 0; i < newItemsCount; i++) {
                    setTimeout(() => {
                        createParticle(
                            centerX + (Math.random() - 0.5) * 100,
                            centerY + (Math.random() - 0.5) * 100,
                            '‚ú®'
                        );
                    }, i * 100);
                }

                // Check achievement
                if (state.itemsCollected === 1) {
                    setTimeout(() => {
                        checkAchievement('first-item');
                    }, 500);
                }
            }

            state.selectedItems = [];
            updateInventoryDisplay();
            updateStats();
            closeModal('item-modal');
            document.getElementById('room-hint').classList.add('hidden');
        }

        // ===== INVENTORY =====
        function updateInventoryDisplay() {
            const list = document.getElementById('inventory-list');
            const submitBtn = document.getElementById('submit-btn');
            const badge = document.getElementById('inventory-badge');

            badge.textContent = state.inventory.length;

            if (state.inventory.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üì¶</div>
                        <div class="empty-state-title">No Items Collected Yet</div>
                        <div class="empty-state-hint">
                            ${state.currentScenario ? 'Tap on carts to collect medical supplies' : 'Choose a scenario to begin'}
                        </div>
                    </div>
                `;
                submitBtn.disabled = true;
            } else {
                list.innerHTML = '';
                state.inventory.forEach((item, index) => {
                    const div = document.createElement('div');
                    div.className = 'inventory-item';
                    div.innerHTML = `
                        <div class="item-icon">${item.name.substring(0, 2).toUpperCase()}</div>
                        <div class="item-info">
                            <strong>${item.name}</strong>
                            <small>${item.cart} ‚Üí ${item.drawer}</small>
                        </div>
                        <button class="remove-btn" onclick="removeItem(${index})">‚úï</button>
                    `;
                    list.appendChild(div);
                });
                submitBtn.disabled = false;
            }
        }

        function removeItem(index) {
            state.inventory.splice(index, 1);
            updateInventoryDisplay();
            updateStats();
        }

        // ===== FEEDBACK =====
        function submitInventory() {
            const scenario = state.currentScenario;
            const collectedIds = state.inventory.map(i => i.id);

            const foundEssential = scenario.essential.filter(id => collectedIds.includes(id));
            const missingEssential = scenario.essential.filter(id => !collectedIds.includes(id));
            const foundOptional = scenario.optional.filter(id => collectedIds.includes(id));
            const missingOptional = scenario.optional.filter(id => !collectedIds.includes(id));
            const extra = collectedIds.filter(id =>
                !scenario.essential.includes(id) && !scenario.optional.includes(id));

            const timeElapsed = Math.floor((Date.now() - state.startTime) / 1000);
            const allEssential = missingEssential.length === 0;
            const allRequired = allEssential && missingOptional.length === 0;
            const noExtras = extra.length === 0;

            // Calculate score and stars
            const essentialScore = (foundEssential.length / scenario.essential.length) * 100;
            const optionalScore = scenario.optional.length > 0 ? (foundOptional.length / scenario.optional.length) * 50 : 0;
            const penaltyScore = extra.length * 5;
            const totalScore = Math.max(0, Math.round(essentialScore + optionalScore - penaltyScore));

            let stars = 0;
            if (allRequired && noExtras && timeElapsed < 60) stars = 5;
            else if (allRequired && noExtras) stars = 4;
            else if (allRequired) stars = 3;
            else if (allEssential) stars = 2;
            else if (foundEssential.length > 0) stars = 1;

            let feedbackClass, feedbackTitle, feedbackMessage;

            if (allRequired) {
                feedbackClass = 'success';
                feedbackTitle = '‚úì Perfect!';
                feedbackMessage = 'You collected all required items correctly!';
                playSound('success');
                triggerHaptic('strong');
            } else if (allEssential) {
                feedbackClass = 'partial';
                feedbackTitle = '‚ö† Good, but incomplete';
                feedbackMessage = 'You got all essential items, but missed some recommended ones.';
                playSound('collect');
                triggerHaptic('medium');
            } else {
                feedbackClass = 'error';
                feedbackTitle = '‚úó Missing Critical Items';
                feedbackMessage = 'You are missing essential items for this procedure.';
                playSound('error');
                triggerHaptic('light');
            }

            // Star rating HTML
            let starsHTML = '<div class="star-rating">';
            for (let i = 0; i < 5; i++) {
                starsHTML += `<span class="star ${i < stars ? 'filled' : ''}">‚òÖ</span>`;
            }
            starsHTML += '</div>';

            // Progress bars
            const essentialProgress = (foundEssential.length / scenario.essential.length) * 100;
            const optionalProgress = scenario.optional.length > 0 ? (foundOptional.length / scenario.optional.length) * 100 : 0;

            let detailsHTML = '<div style="margin: 15px 0;">';
            detailsHTML += '<div style="margin-bottom: 10px;">';
            detailsHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
            detailsHTML += '<small><strong>Essential Items</strong></small>';
            detailsHTML += `<small>${foundEssential.length}/${scenario.essential.length}</small>`;
            detailsHTML += '</div>';
            detailsHTML += '<div class="progress-container">';
            detailsHTML += `<div class="progress-bar" style="width: ${essentialProgress}%"></div>`;
            detailsHTML += '</div>';
            detailsHTML += '</div>';

            if (scenario.optional.length > 0) {
                detailsHTML += '<div style="margin-bottom: 10px;">';
                detailsHTML += '<div style="display: flex; justify-content: space-between; margin-bottom: 5px;">';
                detailsHTML += '<small><strong>Optional Items</strong></small>';
                detailsHTML += `<small>${foundOptional.length}/${scenario.optional.length}</small>`;
                detailsHTML += '</div>';
                detailsHTML += '<div class="progress-container">';
                detailsHTML += `<div class="progress-bar" style="width: ${optionalProgress}%"></div>`;
                detailsHTML += '</div>';
                detailsHTML += '</div>';
            }
            detailsHTML += '</div>';

            // Detailed feedback
            detailsHTML += '<ul style="margin: 10px 0;">';
            if (missingEssential.length > 0) {
                detailsHTML += '<li style="color: #dc3545;"><strong>Missing Essential:</strong> ' +
                    missingEssential.map(id => DATA.items.find(i => i.id === id)?.name).join(', ') + '</li>';
            }
            if (missingOptional.length > 0) {
                detailsHTML += '<li style="color: #ffc107;"><strong>Missing Recommended:</strong> ' +
                    missingOptional.map(id => DATA.items.find(i => i.id === id)?.name).join(', ') + '</li>';
            }
            if (extra.length > 0) {
                detailsHTML += '<li style="color: #666;"><strong>Extra Items:</strong> ' +
                    extra.map(id => DATA.items.find(i => i.id === id)?.name).join(', ') + '</li>';
            }
            detailsHTML += '</ul>';

            const feedbackHTML = `
                <div class="feedback ${feedbackClass}">
                    ${starsHTML}
                    <h3>${feedbackTitle}</h3>
                    <p>${feedbackMessage}</p>
                    <p style="font-size: 24px; font-weight: bold; color: #007bff; margin: 10px 0;">
                        Score: ${totalScore}/100
                    </p>
                    ${detailsHTML}
                    <p style="margin-top: 10px; font-size: 13px;"><strong>‚è±Ô∏è Time:</strong> ${formatTime(timeElapsed)}</p>
                    <div class="feedback-actions">
                        <button onclick="tryAgain()">üîÑ Try Another Scenario</button>
                    </div>
                </div>
            `;

            document.getElementById('feedback-content').innerHTML = feedbackHTML;

            // Switch to feedback tab
            document.querySelector('[data-tab="feedback"]').click();
            setDrawerState('full');

            // Update gamification state
            state.scenariosCompleted++;
            if (allRequired) {
                state.perfectScores++;
            }

            // Check achievements
            setTimeout(() => {
                if (state.scenariosCompleted === 1) {
                    checkAchievement('first-scenario');
                }
                if (allRequired && timeElapsed < 60) {
                    checkAchievement('speed-demon');
                }
                if (allRequired) {
                    checkAchievement('perfect-score');
                }
                if (allRequired && noExtras) {
                    checkAchievement('efficient');
                }
                if (state.scenariosCompleted >= 3) {
                    checkAchievement('three-scenarios');
                }
            }, 800);

            // Save analytics with enhanced data
            saveAnalytics({
                sessionId: state.sessionId,
                scenarioId: scenario.id,
                scenarioName: scenario.name,
                timestamp: new Date().toISOString(),
                timeElapsed: timeElapsed,
                itemsCollected: collectedIds,
                foundEssential: foundEssential,
                missingEssential: missingEssential,
                foundOptional: foundOptional,
                extra: extra,
                correct: allRequired,
                score: totalScore,
                stars: stars,
                cartsOpened: state.cartsOpened,
                achievements: state.achievements
            });

            saveState();
        }

        function tryAgain() {
            state.inventory = [];
            state.currentScenario = null;
            state.startTime = null;
            state.cartsOpened = 0;
            state.drawersOpened = 0;

            document.querySelectorAll('.scenario-item').forEach(el => el.classList.remove('active'));
            document.getElementById('scenario-name').textContent = 'Select a scenario below ‚Üì';
            document.getElementById('room-hint').textContent = 'Select a scenario from the drawer below to begin';
            document.getElementById('room-hint').classList.remove('hidden');

            updateInventoryDisplay();
            updateStats();

            document.querySelector('[data-tab="scenarios"]').click();
            setDrawerState('half');

            playSound('click');
        }

        // ===== STATS =====
        function updateStats() {
            if (state.startTime) {
                const elapsed = Math.floor((Date.now() - state.startTime) / 1000);
                document.getElementById('stat-time').textContent = formatTime(elapsed);
            }
            document.getElementById('stat-items').textContent = state.inventory.length;
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        setInterval(() => {
            if (state.startTime) updateStats();
        }, 1000);

        // ===== ANALYTICS =====
        function saveAnalytics(data) {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            analytics.push(data);
            localStorage.setItem('analytics', JSON.stringify(analytics));
        }

        window.exportAnalytics = function() {
            const analytics = JSON.parse(localStorage.getItem('analytics') || '[]');
            const dataStr = JSON.stringify(analytics, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `trauma-room-analytics-${Date.now()}.json`;
            link.click();
        };

        // ===== MODALS =====
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        // ===== INIT =====
        window.onload = init;
    </script>
</body>
</html>
