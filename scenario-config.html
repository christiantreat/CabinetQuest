<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Cabinet Inventory System</title>
        <style>
                                                            /* Base styles */
                                                             * {
                                                                //box-sizing: border-box;
                                                                margin: 0;
                                                                padding: 0;
                                                                -webkit-tap-highlight-color: transparent;
                                                                -webkit-touch-callout: none;
                                                                -webkit-user-select: none;
                                                                user-select: none;
                                                            }

                                                            body {
                                                                font-family: Arial, sans-serif;
                                                                background: rgba(0, 0, 0, 1);
                                                                padding: 10px;
                                                                display: flex;
                                                                flex-direction: column;
                                                                min-height: 100vh;
                                                                gap: 10px;
                                                                touch-action: manipulation;
                                                            }

                /* Touch device active states */
            .drawer:active,
            .item:active,
            .inventory-item:active,
            .submit-button:active,
            .reset-button:active,
            .survey-button:active,
            .restart-button:active,
            .start-button:active {
                transform: translate(3px, 3px);
                box-shadow: none !important;
                -webkit-tap-highlight-color: transparent;
                transition: none;  /* Ensures immediate response */
            }

            /* Common properties for touch interactions */
            .drawer,
            .item,
            .inventory-item,
            .submit-button,
            .reset-button,
            .survey-button,
            .restart-button,
            .start-button {
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
                user-select: none;
                -webkit-user-select: none;
            }


                                                            /* Mission Container */
                                    .mission-container {
                                       padding: 15px;
                                       border-radius: 0;
                                       text-align: center;
                                       margin-bottom: 15px;
                                       background: #2C2C2C;
                                       box-shadow: 3px 3px 0 #000;
                                    }

                                    .mission-title {
                                       font-family: "Courier New", monospace;
                                       font-size: clamp(18px, 5vw, 24px);
                                       font-weight: bold;
                                       margin-bottom: 8px;
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                       color: #4CAF50;
                                       text-transform: uppercase;
                                       text-shadow: 1px 1px #000;
                                       letter-spacing: 2px;
                                       padding-bottom: 4px;
                                       border-bottom: 2px solid #ffd700;
                                    }

                                    .mission-description {
                                       font-family: "Courier New", monospace;
                                       margin-bottom: 12px;
                                       font-size: clamp(14px, 4vw, 16px);
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                       color: #f0f0f0;
                                       text-shadow: 1px 1px #000;
                                       letter-spacing: 1px;
                                       line-height: 1.6;
                                    }


                                    /* Submit and Reset buttons */
                                    .submit-button,
                                    .reset-button {
                                        font-family: "Courier New", monospace;
                                        color: white;
                                        padding: 12px 25px;
                                        border: 2px solid #fff;
                                        box-shadow: 3px 3px 0 #000;
                                        border-radius: 0 !important;
                                        font-weight: bold;
                                        letter-spacing: 2px;
                                        text-transform: uppercase;
                                        -webkit-font-smoothing: none;
                                        -moz-osx-font-smoothing: none;
                                    }

                                    .submit-button {
                                        background: #4CAF50;
                                    }

                                    .reset-button {
                                        background: #8b0000;
                                    }

                                    .submit-button:active{
                                        background: #45a049;
                                        transform: translate(3px, 3px);
                                        box-shadow: none;
                                    }

                                    .reset-button:active {
                                        background: #700000;
                                        transform: translate(3px, 3px);
                                        box-shadow: none;
                                    }


                                                            #missionProgressText {
                                                                margin-top: 8px;
                                                                font-size: 14px;
                                                                color: #666;
                                                            }

                                                            .mission-controls {
                                                                display: flex;
                                                                flex-wrap: wrap;
                                                                justify-content: center;
                                                                gap: 10px;
                                                                margin-top: 12px;
                                                            }

                                                            .mission-button {
                                                                padding: 12px 20px;
                                                                border: none;
                                                                border-radius: 8px;
                                                                cursor: pointer;
                                                                font-weight: bold;
                                                                transition: background-color 0.2s;
                                                                font-size: 16px;
                                                                min-width: 120px;
                                                                touch-action: manipulation;
                                                            }

                                    /* Inventory Layout */
                                    .inventory-container {
                                       display: flex;
                                       flex-direction: column;
                                       gap: 15px;
                                       background: #2C2C2C;
                                       border: 3px solid #2C2C2C;
                                       padding: 15px;
                                       box-shadow: 3px 3px 0 #000;
                                    }

                                    @media (min-width: 768px) {
                                       .inventory-container {
                                           flex-direction: row;
                                       }

                                       .main-content {
                                           flex: 1;
                                           border-right: 0px solid #4169e1;
                                           padding-right: 15px;
                                       }

                                       .user-inventory {
                                           width: 300px;
                                           background: #2C2C2C;
                                           border: 2px solid #ffd700;
                                       }
                                    }

                                    /* Cabinet Grid */
                                    .inventory-grid {
                                        display: grid;
                                        grid-template-columns: repeat(auto-fill, minmax(min(100%, 200px), 1fr));
                                        gap: 15px;
                                        padding: 10px;
                                    }

                                    .cabinet {
                                        background: #2C2C2C;
                                        border: 3px solid #4CAF50;
                                        border-radius: 0;
                                        box-shadow: 3px 3px 0 #000;
                                        padding: 12px;
                                    }

                                    .cabinet-title {
                                        font-family: "Courier New", monospace;
                                        font-weight: bold;
                                        margin-bottom: 8px;
                                        color: #ffd700;
                                        font-size: clamp(14px, 4vw, 16px);
                                        text-transform: uppercase;
                                        letter-spacing: 2px;
                                        text-shadow: 1px 1px #000;
                                        -webkit-font-smoothing: none;
                                        -moz-osx-font-smoothing: none;
                                        border-bottom: 2px solid #4CAF50;
                                        padding-bottom: 4px;
                                    }

                                    .drawer {
                                        background: #1a1a1a;
                                        margin: 5px 0;
                                        padding: 15px;
                                        border: 2px solid #45a049;
                                        border-radius: 0;
                                        cursor: pointer;
                                        font-size: clamp(14px, 4vw, 16px);
                                        touch-action: manipulation;
                                        font-family: "Courier New", monospace;
                                        -webkit-font-smoothing: none;
                                        -moz-osx-font-smoothing: none;
                                        color: #1a1a1a;
                                        transition: all 0.2s;
                                    }

                                    .drawer:active {
                                        transform: translate(2px, 2px);
                                        box-shadow: none;
                                    }

                                    /* Modal Styles */
                                    .modal-overlay {
                                        display: none;
                                        position: fixed;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        background: rgba(0,0,0,0.8);
                                        z-index: 1000;
                                        touch-action: none;
                                    }

                                    .modal {
                                        position: fixed;
                                        top: 50%;
                                        left: 50%;
                                        transform: translate(-50%, -50%);
                                        width: 95%;
                                        max-width: 600px;
                                        max-height: 90vh;
                                        background: #2C2C2C;
                                        padding: 20px;
                                        border: 3px solid #2C2C2C;
                                        border-radius: 0;
                                        box-shadow: 5px 5px 0 #000;
                                        overflow-y: visible;
                                        z-index: 1001;
                                    }

                                    .breadcrumb {
                                       font-family: "Courier New", monospace;
                                       color: #2C2C2C;
                                       font-size: clamp(14px, 4vw, 16px);
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                       letter-spacing: 2px;
                                       padding: 10px 0;
                                       border-bottom: 2px solid #45a049;
                                    }

                                    .close-button {
                                        position: absolute;
                                        right: 15px;
                                        top: 15px;
                                        background: none;
                                        border: 2px solid #ffd700;
                                        font-family: "Courier New", monospace;
                                        font-size: 28px;
                                        cursor: pointer;
                                        color: #ffd700;
                                        padding: 0 10px;
                                        touch-action: manipulation;
                                    }

                                    /* Item Grid Container */
            .item-grid {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 15px;
                padding: 15px;
                width: 100%;
            }

            /* Item Container */
            .item {
                position: relative;
                background: #1a1a1a;
                border: 2px solid #45a049;
                box-shadow: 2px 2px 0 #000;
                cursor: pointer;
                aspect-ratio: 1/1;
                display: flex;
                align-items: center;
                justify-content: center;
                padding: 10px;
                font-size: 0;

                /* Remove transition for abrupt changes */
                touch-action: manipulation;
                -webkit-tap-highlight-color: transparent;
            }

            /* Image Styling */
            .item img {
                max-width: 100%;
                max-height: 100%;
                object-fit: contain;
            }

            /* Desktop hover */
            @media (hover: hover) and (pointer: fine) {
                .item:hover {
                    transform: scale(3);
                    z-index: 10; /* Bring hovered item to front */
                }
            }

            /* Touch device behavior */
            @media (hover: none) and (pointer: coarse) {
                .item:active {
                    transform: scale(3);  /* Same scale as hover */
                    z-index: 10;
                    background: #4169e1;
                    box-shadow: none;
                }
            }

            /*Responsive adjustments */
            @media (max-width: 768px) {
                .item-grid {
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                    gap: 10px;
                }

                .item:active {
                    transform: scale(1.6); /* Slightly smaller scale on mobile */
                }
            }

            /* For larger screens */
            @media (min-width: 1024px) {
                .item-grid {
                    grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
                }
            }

                                    /* User Inventory */
                                    .user-inventory {
                                       background: #2C2C2C;
                                       border: 3px solid #ffd700;
                                       border-radius: 0;
                                       box-shadow: 3px 3px 0 #000;
                                       padding: 15px;
                                       height: auto;
                                       max-height: 50vh;
                                    }

                                    @media (min-width: 768px) {
                                       .user-inventory {
                                           height: calc(100vh - 40px);
                                           position: sticky;
                                           top: 20px;
                                       }
                                    }

                                    .inventory-title {
                                       font-family: "Courier New", monospace;
                                       font-size: clamp(16px, 5vw, 20px);
                                       font-weight: bold;
                                       color: #4CAF50; // #ffd700 #4CAF50
                                       margin-bottom: 12px;
                                       padding-bottom: 8px;
                                       border-bottom: 2px solid #ffd700 !important;
                                       text-transform: uppercase;
                                       letter-spacing: 2px;
                                       text-shadow: 1px 1px #000;
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                    }

                                    .inventory-items {
                                       display: grid;
                                       grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                                       gap: 10px;
                                       overflow-y: auto;
                                       max-height: calc(100% - 50px);
                                       padding: 5px;
                                       font-size: 0;


                                    }

                                    .inventory-item {
                                       background: #1a1a1a;
                                       padding: 8px;
                                       border: 2px solid #ffd700;
                                       border-radius: 0;
                                       text-align: center;
                                       cursor: pointer;
                                       touch-action: manipulation;
                                       box-shadow: 2px 2px 0 #000;
                                       color: #f0f0f0;
                                       font-family: "Courier New", monospace;
                                    }

                                    .inventory-item:active {
                                       transform: translate(2px, 2px);
                                       box-shadow: none;
                                       background: #4169e1;
                                    }

                                    .inventory-item img {
                                       width: 100%;
                                       height: auto;
                                       aspect-ratio: 4/3;
                                       margin-bottom: 6px;
                                       border-radius: 0;
                                       border: 0px solid #ffd700;
                                       object-fit: cover;
                                    }

                                                            /* Scenario Setup Screen */
                                    .scenario-setup {
                                        position: fixed;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        background: rgba(0, 0, 0, 1);
                                        z-index: 2100;
                                        color: white;
                                        padding: 20px;
                                        overflow-y: auto;
                                        display: flex;
                                        flex-direction: column;
                                    }

                                    .scenario-setup-content {
                                        max-width: 900px;
                                        margin: 0 auto;
                                        width: 100%;
                                    }

                                    .scenario-setup h1 {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(24px, 6vw, 36px);
                                        color: #ffd700;
                                        text-transform: uppercase;
                                        text-shadow: 2px 2px #000;
                                        letter-spacing: 4px;
                                        margin-bottom: 10px;
                                        text-align: center;
                                        border-bottom: 2px solid #ffd700;
                                        padding-bottom: 10px;
                                    }

                                    .scenario-setup h2 {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(16px, 4vw, 20px);
                                        color: #4CAF50;
                                        text-transform: uppercase;
                                        letter-spacing: 2px;
                                        margin: 20px 0 10px 0;
                                    }

                                    .scenario-list {
                                        display: flex;
                                        flex-direction: column;
                                        gap: 15px;
                                        margin: 20px 0;
                                    }

                                    .scenario-card {
                                        background: #2C2C2C;
                                        border: 2px solid #4CAF50;
                                        box-shadow: 3px 3px 0 #000;
                                        padding: 15px;
                                        display: flex;
                                        gap: 15px;
                                        align-items: flex-start;
                                    }

                                    .scenario-card.selected {
                                        border-color: #ffd700;
                                        background: #3a3a3a;
                                    }

                                    .scenario-checkbox {
                                        width: 24px;
                                        height: 24px;
                                        cursor: pointer;
                                        flex-shrink: 0;
                                    }

                                    .scenario-details {
                                        flex: 1;
                                    }

                                    .scenario-title {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(16px, 4vw, 18px);
                                        color: #ffd700;
                                        font-weight: bold;
                                        margin-bottom: 5px;
                                        letter-spacing: 1px;
                                    }

                                    .scenario-description {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(14px, 3.5vw, 16px);
                                        color: #f0f0f0;
                                        margin-bottom: 8px;
                                        line-height: 1.4;
                                    }

                                    .scenario-meta {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(12px, 3vw, 14px);
                                        color: #4CAF50;
                                        margin-top: 8px;
                                    }

                                    .scenario-actions {
                                        display: flex;
                                        gap: 10px;
                                        flex-shrink: 0;
                                        flex-direction: column;
                                    }

                                    .edit-scenario-btn, .delete-scenario-btn {
                                        font-family: "Courier New", monospace;
                                        padding: 8px 15px;
                                        border: 2px solid #fff;
                                        box-shadow: 2px 2px 0 #000;
                                        font-weight: bold;
                                        letter-spacing: 1px;
                                        text-transform: uppercase;
                                        font-size: 12px;
                                        cursor: pointer;
                                        background: #4169e1;
                                        color: white;
                                    }

                                    .delete-scenario-btn {
                                        background: #8b0000;
                                    }

                                    .edit-scenario-btn:active, .delete-scenario-btn:active {
                                        transform: translate(2px, 2px);
                                        box-shadow: none;
                                    }

                                    .setup-controls {
                                        display: flex;
                                        gap: 15px;
                                        justify-content: center;
                                        margin: 30px 0;
                                        flex-wrap: wrap;
                                    }

                                    .add-scenario-btn, .start-selected-btn {
                                        font-family: "Courier New", monospace;
                                        padding: 12px 25px;
                                        border: 2px solid #fff;
                                        box-shadow: 3px 3px 0 #000;
                                        font-weight: bold;
                                        letter-spacing: 2px;
                                        text-transform: uppercase;
                                        font-size: clamp(14px, 3.5vw, 16px);
                                        cursor: pointer;
                                        color: white;
                                    }

                                    .add-scenario-btn {
                                        background: #4169e1;
                                    }

                                    .start-selected-btn {
                                        background: #4CAF50;
                                    }

                                    .add-scenario-btn:active, .start-selected-btn:active {
                                        transform: translate(3px, 3px);
                                        box-shadow: none;
                                    }

                                    /* Edit Scenario Modal */
                                    .edit-modal-overlay {
                                        display: none;
                                        position: fixed;
                                        top: 0;
                                        left: 0;
                                        width: 100%;
                                        height: 100%;
                                        background: rgba(0,0,0,0.9);
                                        z-index: 2200;
                                    }

                                    .edit-modal {
                                        position: fixed;
                                        top: 50%;
                                        left: 50%;
                                        transform: translate(-50%, -50%);
                                        width: 90%;
                                        max-width: 600px;
                                        max-height: 90vh;
                                        background: #2C2C2C;
                                        padding: 25px;
                                        border: 3px solid #4CAF50;
                                        box-shadow: 5px 5px 0 #000;
                                        overflow-y: auto;
                                        z-index: 2201;
                                    }

                                    .edit-modal h2 {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(18px, 4vw, 24px);
                                        color: #ffd700;
                                        text-transform: uppercase;
                                        letter-spacing: 2px;
                                        margin-bottom: 20px;
                                        border-bottom: 2px solid #ffd700;
                                        padding-bottom: 10px;
                                    }

                                    .form-group {
                                        margin-bottom: 20px;
                                    }

                                    .form-group label {
                                        font-family: "Courier New", monospace;
                                        color: #4CAF50;
                                        font-size: clamp(14px, 3.5vw, 16px);
                                        display: block;
                                        margin-bottom: 8px;
                                        letter-spacing: 1px;
                                        text-transform: uppercase;
                                    }

                                    .form-group input[type="text"],
                                    .form-group input[type="number"],
                                    .form-group select,
                                    .form-group textarea {
                                        width: 100%;
                                        padding: 10px;
                                        background: #1a1a1a;
                                        border: 2px solid #45a049;
                                        color: #f0f0f0;
                                        font-family: "Courier New", monospace;
                                        font-size: 14px;
                                        box-sizing: border-box;
                                    }

                                    .form-group textarea {
                                        min-height: 80px;
                                        resize: vertical;
                                    }

                                    .items-selector {
                                        display: grid;
                                        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                                        gap: 10px;
                                        margin-top: 10px;
                                    }

                                    .item-option {
                                        background: #1a1a1a;
                                        border: 2px solid #45a049;
                                        padding: 8px;
                                        cursor: pointer;
                                        text-align: center;
                                        font-family: "Courier New", monospace;
                                        font-size: 12px;
                                        color: #f0f0f0;
                                    }

                                    .item-option.selected {
                                        border-color: #ffd700;
                                        background: #4CAF50;
                                    }

                                    .modal-buttons {
                                        display: flex;
                                        gap: 15px;
                                        justify-content: center;
                                        margin-top: 25px;
                                    }

                                    .save-btn, .cancel-btn {
                                        font-family: "Courier New", monospace;
                                        padding: 12px 25px;
                                        border: 2px solid #fff;
                                        box-shadow: 3px 3px 0 #000;
                                        font-weight: bold;
                                        letter-spacing: 2px;
                                        text-transform: uppercase;
                                        font-size: 14px;
                                        cursor: pointer;
                                        color: white;
                                    }

                                    .save-btn {
                                        background: #4CAF50;
                                    }

                                    .cancel-btn {
                                        background: #8b0000;
                                    }

                                    .save-btn:active, .cancel-btn:active {
                                        transform: translate(3px, 3px);
                                        box-shadow: none;
                                    }

                                                            /* Game Start/Complete Screens */
                                                            .game-start {
                                                                position: fixed;
                                                                top: 0;
                                                                left: 0;
                                                                width: 100%;
                                                                height: 100%;
                                                                background: rgba(0, 0, 0, 1) !important;
                                                                z-index: 2000;
                                                                color: white;
                                                                text-align: center;
                                                                padding: min(0px, 1vw) !important;
                                                                display: none;
                                                                align-items: center;
                                                                justify-content: center;
                                                                overflow-y: auto;
                                                               }

                                                            .game-complete {
                                                                position: fixed;
                                                                top: 0;
                                                                left: 0;
                                                                width: 100%;
                                                                height: 100%;
                                                                background: rgba(0, 0, 0, 1) !important;
                                                                z-index: 2000;
                                                                color: white;
                                                                text-align: center;
                                                                padding: 20px;
                                                                display: none;  /* Changed from flex to none */
                                                                align-items: center;
                                                                justify-content: center;
                                                                overflow-y: auto;
                                                            }

                                                            .game-complete-buttons {
                                                                display: flex;
                                                                gap: 15px;
                                                                justify-content: center;
                                                                margin-top: 20px;
                                                                flex-wrap: wrap;
                                                            }

                                    .restart-button {
                            font-family: "Courier New", monospace;
                            background: #4CAF50;  /* Keeping original color */
                            color: white;
                            padding: 12px 25px;   /* Matches survey button */
                            border: 0px solid #fff;
                            box-shadow: 3px 3px 0 #000;
                            border-radius: 0 !important;
                            font-size: 16px;
                            font-weight: bold;
                            letter-spacing: 2px;
                            text-transform: uppercase;
                            -webkit-font-smoothing: none;
                            -moz-osx-font-smoothing: none;
                            cursor: pointer;
                            touch-action: manipulation;
                        }

                        .restart-button:active {
                            background: #45a049;  /* Darker shade for active state */
                            transform: translate(3px, 3px);
                            box-shadow: none;
                        }

                        .survey-button {
                            /* Base styling */
                            font-family: "Courier New", monospace;
                            background: #4169e1;
                            color: white;
                            padding: 12px 25px;          /* Match the submit/reset padding */
                            border: 0px solid #fff;      /* Add border like submit/reset */
                            box-shadow: 3px 3px 0 #000;
                            border-radius: 0 !important;

                            /* Typography */
                            font-size: 16px;            /* Fixed size instead of clamp */
                            font-weight: bold;
                            letter-spacing: 2px;
                            text-transform: uppercase;
                            -webkit-font-smoothing: none;
                            -moz-osx-font-smoothing: none;

                            /* Interactive */
                            cursor: pointer;
                            touch-action: manipulation;
                        }

                        .survey-button:active {
                            background: #3558c0;        /* Darker shade for active state */
                            transform: translate(3px, 3px);
                            box-shadow: none;
                        }

                                                            .game-start-content,
                                                            .game-complete-content {
                                                                max-height: 90vh;
                                                                max-width: 90%;
                                                                margin: 0 auto;
                                                                background: rgba(255, 255, 255, 1);
                                                                padding: min(20px, 4vw);
                                                                border-radius: 0px !important;
                                                                animation: pixelFadeIn 0.8s steps(8) forwards;
                                                                image-rendering: pixelated;
                                                            }

                                                .game-start h1,
                                                .game-complete h1 {
                                                   font-family: "Courier New", monospace !important;
                                                   letter-spacing: 9px;
                                                   font-size: clamp(24px, 8vw, 48px);
                                                   margin-bottom: 20px;
                                                   -webkit-font-smoothing: none;
                                                   -moz-osx-font-smoothing: none;
                                                   color: #ffd700;
                                                   text-transform: uppercase;
                                                   text-shadow: 2px 2px #000;
                                                   font-weight: bold;
                                                   padding-bottom: 4px;
                                                   border-bottom: 2px solid #ffd700;
                                                }


                                    .game-complete h1 {
                                        font-family: "Courier New", monospace !important;
                                        letter-spacing: 9px;
                                        font-size: clamp(24px, 6vw, 48px);
                                        margin-bottom: 20px;
                                        -webkit-font-smoothing: none;
                                        -moz-osx-font-smoothing: none;
                                        color: #ffd700;
                                        text-transform: uppercase;
                                        text-shadow: 2px 2px #000;
                                        font-weight: bold;
                                        padding-bottom: 4px;
                                        border-bottom: 2px solid #ffd700;
                                    }

                                    .game-complete p {
                                        font-family: "Courier New", monospace;
                                        font-size: clamp(14px, 4vw, 18px);
                                        line-height: 1.6;
                                        margin-bottom: 20px;
                                        text-align: center;
                                        -webkit-font-smoothing: none;
                                        -moz-osx-font-smoothing: none;
                                        color: #f0f0f0;
                                        text-shadow: 1px 1px #000;
                                        letter-spacing: 1px;
                                    }

                                    .game-complete span {
                                        font-family: "Courier New", monospace !important;
                                        -webkit-font-smoothing: none;
                                        -moz-osx-font-smoothing: none;
                                        color: #ffd700;
                                        text-transform: uppercase;
                                        text-shadow: 2px 2px #000;
                                        letter-spacing: 5px;
                                    }

                                    .game-start .instructions {
                                       font-family: "Courier New", monospace;
                                       font-size: clamp(14px, 4vw, 18px);
                                       line-height: 1.6;
                                       margin-bottom: 20px;
                                       text-align: left;
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                       color: #f0f0f0;
                                       text-shadow: 1px 1px #000;
                                       letter-spacing: 1px;
                                       padding: 10px;
                                         counter-reset: instruction-counter;
                                    }

                                    .game-start .instructions p {
                                       position: relative;
                                    }

                                    .game-start .instructions p:nth-of-type(n+2):nth-of-type(-n+5) {
                                       padding-left: 30px;
                                    }

                                    .game-start .instructions p:nth-of-type(n+2):nth-of-type(-n+5)::before {
                                       content: counter(instruction-counter) ".";
                                       counter-increment: instruction-counter;
                                       position: absolute;
                                       left: 0;
                                       color: #ffd700;
                                    }

                                                .game-start .instructions span {
                                       font-family: "Courier New", monospace !important;
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                       color: #ffd700;
                                       text-transform: uppercase;
                                       text-shadow: 2px 2px #000;
                                       letter-spacing: 5px;
                                    }

                                    .start-button {
                                       background: #4169e1;
                                       color: #fff;
                                       padding: 15px 30px;
                                       border: 3px solid #fff;
                                       box-shadow: 3px 3px 0 #000;
                                       border-radius: 0px !important;
                                       font-family: "Courier New", monospace;
                                       font-size: clamp(14px,3.5vw, 16px);
                                       font-weight: bold;
                                       letter-spacing: 2px;
                                       text-transform: uppercase;
                                       -webkit-font-smoothing: none;
                                       -moz-osx-font-smoothing: none;
                                       cursor: pointer;
                                       transition: transform 0.1s;
                                       touch-action: manipulation;
                                    }

                                    .start-button:active{
                                       transform: translate(3px, 3px);
                                       box-shadow: none;
                                    }

                                                            /* Mission Controls Container */
                                                            .mission-controls {
                                                                display: flex;
                                                                justify-content: center;
                                                                gap: 10px;
                                                                margin-top: 15px;
                                                                flex-wrap: wrap;
                                                                padding: 0 10px;
                                                            }

                                                            /* Mission Buttons */
                                                            .mission-button {
                                                                min-width: 120px;
                                                                padding: 12px 20px;
                                                                border: none;
                                                                border-radius: 8px;
                                                                cursor: pointer;
                                                                font-weight: bold;
                                                                font-size: clamp(14px, 4vw, 16px);
                                                                transition: background-color 0.2s, transform 0.1s;
                                                                touch-action: manipulation;
                                                            }

                                                            .mission-button:active {
                                                                transform: scale(0.98);
                                                            }

                                    @keyframes pixelFadeIn {
                                       0% {
                                           opacity: 0;
                                           transform: scale(0.5);
                                           image-rendering: pixelated;
                                       }
                                       50% {
                                           opacity: 0.5;
                                           transform: scale(0.8);
                                       }
                                       100% {
                                           opacity: 1;
                                           transform: scale(1);
                                       }
                                    }

                                                                background: white;
                                                                border-radius: 8px;
                                                                padding: 15px;
                                                                height: auto;
                                                                max-height: 50vh;
                                                            }

                                                            @media (min-width: 768px) {
                                                                .user-inventory {
                                                                    height: calc(100vh - 40px);
                                                                    position: sticky;
                                                                    top: 20px;
                                                                }
                                                            }

                                                            .inventory-title {
                                                                font-size: clamp(16px, 5vw, 20px);
                                                                font-weight: bold;
                                                                margin-bottom: 12px;
                                                                padding-bottom: 8px;
                                                                border-bottom: 2px solid #f0f2f5;
                                                            }

                                                            .inventory-items {
                                                                display: grid;
                                                                grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
                                                                gap: 10px;
                                                                overflow-y: auto;
                                                                max-height: calc(100% - 50px);
                                                                padding: 5px;
                                                            }

                                                            .inventory-item {
                                                                background: #4A4A4A;;
                                                                padding: 8px;
                                                                border-radius: 8px;
                                                                text-align: center;
                                                                cursor: pointer;
                                                                touch-action: manipulation;
                                                            }

                                                            .inventory-item:active {
                                                                transform: scale(0.98);
                                                                background: #e9ecef;
                                                            }

                                                            .inventory-item img {
                                                                width: 100%;
                                                                height: auto;
                                                                aspect-ratio: 4/3;
                                                                margin-bottom: 6px;
                                                                border-radius: 4px;
                                                                object-fit: cover;
                                                            }

                                                            /* Game Start/Complete Screens */
                                                            .game-start,
                                                            .game-complete {
                                                                position: fixed;
                                                                top: 0;
                                                                left: 0;
                                                                width: 100%;
                                                                height: 100%;
                                                                background: rgba(0, 0, 0, 0.9);
                                                                z-index: 2000;
                                                                color: white;
                                                                text-align: center;
                                                                padding: 20px;
                                                                display: flex;
                                                                align-items: center;
                                                                justify-content: center;
                                                                overflow-y: auto;
                                                            }

                                                            .game-start-content,
                                                            .game-complete-content {
                                                                max-width: 90%;
                                                                margin: 0 auto;
                                                                background: rgba(255, 255, 255, 0.1);
                                                                padding: 20px;
                                                                border-radius: 16px;
                                                                animation: pixelFadeIn 2.1s steps(5) forwards;
                                                            }

                                                            .game-start h1,
                                                            .game-complete h1 {
                                                                font-size: clamp(24px, 8vw, 48px);
                                                                margin-bottom: 20px;
                                                                color: #4CAF50;
                                                            }

                                                            .game-start .instructions {
                                                                font-size: clamp(14px, 4vw, 18px);
                                                                line-height: 1.6;
                                                                margin-bottom: 20px;
                                                                text-align: left;
                                                            }

                                                            .start-button{
                                                                background: #4CAF50;
                                                                color: white;
                                                                padding: 15px 30px;
                                                                border: none;
                                                                border-radius: 8px;
                                                                font-size: clamp(16px, 5vw, 20px);
                                                                cursor: pointer;
                                                                transition: background-color 0.3s;
                                                                touch-action: manipulation;
                                                            }

                                                            .start-button:active{
                                                                transform: scale(0.98);
                                                                background: #45a049;
                                                            }

                                                            /* Progress Bar */
                                                            .mission-progress {
                                                                display: none;
                                                                background: #f0f2f5;
                                                                padding: 8px;
                                                                border-radius: 8px;
                                                                margin: 10px 0;
                                                                width: 100%;
                                                            }

                                                            .mission-progress-bar {
                                                                background: #e0e0e0;
                                                                height: 10px;
                                                                border-radius: 5px;
                                                                overflow: hidden;
                                                                width: 100%;
                                                                margin: 0 auto;
                                                            }

                                                            .mission-progress-fill {
                                                                background: #4CAF50;
                                                                height: 100%;
                                                                width: 0%;
                                                                transition: width 0.3s ease;
                                                                border-radius: 5px;
                                                            }

                                                            /* Mission Controls Container */
                                                            .mission-controls {
                                                                display: flex;
                                                                justify-content: center;
                                                                gap: 10px;
                                                                margin-top: 15px;
                                                                flex-wrap: wrap;
                                                                padding: 0 10px;
                                                            }

                                                            /* Mission Buttons */
                                                            .mission-button {
                                                                min-width: 120px;
                                                                padding: 12px 20px;
                                                                border: none;
                                                                border-radius: 8px;
                                                                cursor: pointer;
                                                                font-weight: bold;
                                                                font-size: clamp(14px, 4vw, 16px);
                                                                transition: background-color 0.2s, transform 0.1s;
                                                                touch-action: manipulation;
                                                            }

                                                            .mission-button:active {
                                                                transform: scale(0.98);
                                                            }

                                                            @keyframes fadeIn {
                                                                from {
                                                                    opacity: 0;
                                                                    transform: translateY(-20px);
                                                                }
                                                                to {
                                                                    opacity: 1;
                                                                    transform: translateY(0);
                                                                }
                                                            }
        </style>
    </head>
    <body>
        <div class="mission-container">
            <div class="mission-title" id="missionTitle">Current Mission</div>
            <div class="mission-description" id="missionDescription"></div>
            <div class="mission-progress">
                <div class="mission-progress-bar">
                    <div class="mission-progress-fill" id="missionProgress"></div>
                </div>
                <div id="missionProgressText"></div>
            </div>
            <div class="mission-controls">
                <button class="mission-button submit-button" onclick="submitMission()" id="submitButton">
                    Submit Mission
                </button>
                <button class="mission-button reset-button" onclick="resetInventory()">Reset Inventory</button>
            </div>
        </div>

        <div class="inventory-container">
            <div class="main-content">
                <div class="inventory-grid">
                    <!-- Cabinet 1 -->
                    <div class="cabinet">
                        <div class="cabinet-title">Cabinet 1</div>
                        <div class="drawer" onclick="openDrawer(1, '1-1')">Drawer 1-1</div>
                        <div class="drawer" onclick="openDrawer(1, '1-2')">Drawer 1-2</div>
                        <div class="drawer" onclick="openDrawer(1, '1-3')">Drawer 1-3</div>
                        <div class="drawer" onclick="openDrawer(1, '1-4')">Drawer 1-4</div>
                        <div class="drawer" onclick="openDrawer(1, '1-5')">Drawer 1-5</div>
                        <div class="drawer" onclick="openDrawer(1, '1-6')">Drawer 1-6</div>
                        <div class="drawer" onclick="openDrawer(1, '1-7')">Drawer 1-7</div>
                    </div>
                </div>
            </div>

            <div class="user-inventory">
                <div class="inventory-title">My Inventory</div>
                <div class="inventory-items" id="userInventory"></div>
            </div>

            <!-- Modal -->
            <div class="modal-overlay" id="modalOverlay">
                <div class="modal">
                    <button class="close-button" onclick="closeModal()">&times;</button>
                    <div class="breadcrumb" id="modalBreadcrumb"></div>
                    <div class="item-grid" id="modalContent"></div>
                </div>
            </div>

            <script>
                const inventory = {
                    1: {
                        name: "Cabinet 1",
                        drawers: {
                            "1-1": ["Item 1", "Item 2", "Item 3"],
                            "1-2": ["Item 4", "Item 5", "Item 6"],
                            "1-3": ["Item 7", "Item 8", "Item 9"],
                            "1-4": ["Item 10", "Item 11", "Item 12"],
                            "1-5": ["Item 13", "Item 14", "Item 15"],
                            "1-6": ["Item 16", "Item 17", "Item 18"],
                            "1-7": ["Item 19", "Item 20", "Item 21"]
                        }
                    }
                };

                // Define image paths for each item
                const itemImages = {
                    "Item 1": "/images/item1.png",
                    "Item 2": "/images/item2.png",
                    "Item 3": "/images/item3.png",
                    "Item 4": "/images/item4.png",
                    "Item 5": "/images/item5.png",
                    "Item 6": "/images/item6.png",
                    "Item 7": "/images/item7.png",
                    "Item 8": "/images/item8.png",
                    "Item 9": "/images/item9.png",
                    "Item 10": "/images/item10.png",
                    "Item 11": "/images/item11.png",
                    "Item 12": "/images/item12.png",
                    "Item 13": "/images/item13.png",
                    "Item 14": "/images/item14.png",
                    "Item 15": "/images/item15.png",
                    "Item 16": "/images/item16.png",
                    "Item 17": "/images/item17.png",
                    "Item 18": "/images/item18.png",
                    "Item 19": "/images/item19.png",
                    "Item 20": "/images/item20.png",
                    "Item 21": "/images/item21.png",
                    "Item 22": "/images/item22.png",
                    "Item 23": "/images/item23.png",
                    "Item 24": "/images/item24.png",
                    "Item 25": "/images/item25.png",
                    "Item 26": "/images/item26.png",
                    "Item 27": "/images/item27.png"
                };

                let currentCabinet = null;
                let currentDrawer = null;
                // Logging function
                // Array to store all log entries
                let gameLogEntries = [];

                function logAction(action, details) {
                    const actionCodes = {
                        "Mission Progress": "MP",
                        "Mission Completed": "MC",
                        "Mission Failed": "MF",
                        "New Mission": "NM",
                        "All Missions Completed": "AC",
                        "Item Added to Inventory": "AI",
                        "Item Returned to Drawer": "RD",
                        Inventory: "IV",
                        "Drawer Opened": "DO",
                        "Drawer Closed": "DC",
                        "Game Started": "GS",
                        "Game Complete": "GC",
                        "Game Restart": "GR"
                    };

                    const replacements = {
                        "Cabinet ": "C",
                        "Drawer ": "D",
                        " > ": ".",
                        "Item ": "I",
                        " from ": "f",
                        "CExplorer ": "CE",
                        "Specific ICollector": "SIC",
                        "Collected ": "",
                        ": ": ": ",
                        "Congratulations!": "",
                        "All missions completed successfully": "",
                        "All items returned to drawers": ""
                    };

                    const time = new Date().toLocaleTimeString("en-US", {
                        hour12: false,
                        hour: "2-digit",
                        minute: "2-digit",
                        second: "2-digit"
                    });

                    let compressedDetails = details;
                    for (const [key, value] of Object.entries(replacements)) {
                        compressedDetails = compressedDetails.replace(new RegExp(key, "g"), value);
                    }

                    const logEntry = `${time}|${actionCodes[action]}|${compressedDetails}`;
                    gameLogEntries.push(logEntry);
                }

                // Function to get image path for an item
                function getItemImage(item) {
                    return itemImages[item] || "/path/to/default-image.png"; // Fallback to default image if not found
                }

                // Mission System
                const missions = [
                    {
                        id: 1,
                        title: "Cabinet Explorer I",
                        description: "Collect any three items from Drawer 1-1",
                        requirement: {
                            type: "collect",
                            drawer: "1-1",
                            count: 3,
                            fromSpecificDrawer: true
                        },
                        completed: false,
                        progress: 0
                    },
                    {
                        id: 2,
                        title: "Cabinet Explorer II",
                        description: "Collect any three items from Drawer 1-2",
                        requirement: {
                            type: "collect",
                            drawer: "1-2",
                            count: 3,
                            fromSpecificDrawer: true
                        },
                        completed: false,
                        progress: 0
                    },
                    {
                        id: 3,
                        title: "Specific Item Collector",
                        description: "Collect Item 7, Item 8, and Item 9 from Drawer 1-3",
                        requirement: {
                            type: "collect_specific",
                            drawer: "1-3",
                            items: ["Item 7", "Item 8", "Item 9"],
                            progress: {
                                "Item 7": false,
                                "Item 8": false,
                                "Item 9": false
                            }
                        },
                        completed: false,
                        progress: 0
                    }
                ];

                let currentMissionIndex = 0;

                function updateMissionDisplay() {
                    const currentMission = missions[currentMissionIndex];
                    document.getElementById("missionTitle").textContent = currentMission.title;
                    document.getElementById("missionDescription").textContent = currentMission.description;

                    if (currentMission.requirement.type === "collect_specific") {
                        const progressCount = Object.values(currentMission.requirement.progress).filter(Boolean).length;
                        const totalItems = currentMission.requirement.items.length;
                        const progressPercentage = (progressCount / totalItems) * 100;
                        document.getElementById("missionProgress").style.width = `${progressPercentage}%`;
                    } else {
                        const progressPercentage = (currentMission.progress / currentMission.requirement.count) * 100;
                        document.getElementById("missionProgress").style.width = `${progressPercentage}%`;
                    }
                }
                function checkMissionProgress(item, fromDrawer) {
                    const currentMission = missions[currentMissionIndex];
                    if (currentMission.completed) return;

                    if (currentMission.requirement.type === "collect_specific") {
                        if (
                            fromDrawer === currentMission.requirement.drawer &&
                            currentMission.requirement.items.includes(item)
                        ) {
                            currentMission.requirement.progress[item] = true;
                            logAction("Mission Progress", `${currentMission.title}: Collected ${item}`);
                            updateMissionDisplay();
                        }
                    } else if (currentMission.requirement.type === "collect") {
                        if (
                            !currentMission.requirement.fromSpecificDrawer ||
                            fromDrawer === currentMission.requirement.drawer
                        ) {
                            currentMission.progress++;
                            logAction(
                                "Mission Progress",
                                `${currentMission.title}: ${currentMission.progress}/${currentMission.requirement.count}`
                            );
                            updateMissionDisplay();
                        }
                    }
                }

                function returnAllItems() {
                    // Return all items to their original drawers
                    while (userInventory.length > 0) {
                        const item = userInventory[0];
                        const origin = itemOrigins[item];
                        inventory[origin.cabinet].drawers[origin.drawer].push(item);
                        userInventory.splice(0, 1);
                        delete itemOrigins[item];
                    }
                    updateInventoryDisplay();
                    if (currentCabinet && currentDrawer) {
                        openDrawer(currentCabinet, currentDrawer);
                    }
                    logAction("Inventory", "All items returned to drawers");
                }

                function resetInventory() {
                    returnAllItems();
                    logAction("Inventory", "Inventory reset");
                }

                function submitMission() {
                    const currentMission = missions[currentMissionIndex];
                    let isSuccessful = false;

                    if (currentMission.requirement.type === "collect_specific") {
                        isSuccessful = currentMission.requirement.items.every(
                            (item) =>
                                userInventory.includes(item) &&
                                itemOrigins[item].drawer === currentMission.requirement.drawer
                        );
                    } else {
                        const itemsFromRequiredDrawer = userInventory.filter(
                            (item) => itemOrigins[item].drawer === currentMission.requirement.drawer
                        );
                        isSuccessful = itemsFromRequiredDrawer.length >= currentMission.requirement.count;
                    }

                    if (isSuccessful) {
                        currentMission.completed = true;
                        logAction("Mission Completed", currentMission.title);
                        alert("Mission Completed Successfully!");

                        // Return items and move to next mission
                        returnAllItems();
                        if (currentMissionIndex < missions.length - 1) {
                            currentMissionIndex++;
                            updateMissionDisplay();
                            logAction("New Mission", missions[currentMissionIndex].title);
                        } else {
                            logAction("All Missions Completed", "Congratulations!");
                            showGameComplete();
                        }
                    } else {
                        alert("Mission Requirements Not Met - Try Again!");
                        logAction("Mission Failed", "Requirements not met");
                    }
                }

                // Initialize mission display
                updateMissionDisplay();
                const userInventory = [];
                const itemOrigins = {}; // Tracks which cabinet/drawer each item came from

                function openDrawer(cabinetId, drawerId) {
                    currentCabinet = cabinetId;
                    currentDrawer = drawerId;
                    logAction("Drawer Opened", `${inventory[cabinetId].name} > Drawer ${drawerId}`);
                    const cabinet = inventory[cabinetId];
                    const items = cabinet.drawers[drawerId];
                    const modalContent = document.getElementById("modalContent");
                    const modalBreadcrumb = document.getElementById("modalBreadcrumb");

                    modalBreadcrumb.textContent = `${cabinet.name} > Drawer ${drawerId}`;
                    modalContent.innerHTML = "";

                    items.forEach((item) => {
                        const itemDiv = document.createElement("div");
                        itemDiv.className = "item";
                        itemDiv.innerHTML = `
                    <img src="${getItemImage(item)}" alt="${item}">
                    <div>${item}</div>
                `;
                        itemDiv.onclick = () => addToInventory(item);
                        modalContent.appendChild(itemDiv);
                    });

                    document.getElementById("modalOverlay").style.display = "block";
                }

                function addToInventory(item) {
                    // Remove item from drawer and store its origin
                    logAction(
                        "Item Added to Inventory",
                        `${item} from ${inventory[currentCabinet].name} > Drawer ${currentDrawer}`
                    );
                    const drawerItems = inventory[currentCabinet].drawers[currentDrawer];
                    const index = drawerItems.indexOf(item);
                    if (index > -1) {
                        drawerItems.splice(index, 1);
                        userInventory.push(item);
                        itemOrigins[item] = {
                            cabinet: currentCabinet,
                            drawer: currentDrawer
                        };
                        checkMissionProgress(item, currentDrawer);
                        updateInventoryDisplay();
                        openDrawer(currentCabinet, currentDrawer); // Refresh drawer display
                    }
                }

                function removeFromInventory(item) {
                    const index = userInventory.indexOf(item);
                    const origin = itemOrigins[item];
                    logAction(
                        "Item Returned to Drawer",
                        `${item} to ${inventory[origin.cabinet].name} > Drawer ${origin.drawer}`
                    );
                    if (index > -1) {
                        const origin = itemOrigins[item];
                        userInventory.splice(index, 1);
                        inventory[origin.cabinet].drawers[origin.drawer].push(item);
                        delete itemOrigins[item];
                        updateInventoryDisplay();

                        // Only refresh drawer display if we're currently viewing the target drawer
                        if (currentCabinet === origin.cabinet && currentDrawer === origin.drawer) {
                            openDrawer(currentCabinet, currentDrawer);
                        }
                    }
                }

                // Update the inventory display code
                function updateInventoryDisplay() {
                    const inventoryContainer = document.getElementById("userInventory");
                    inventoryContainer.innerHTML = "";

                    userInventory.forEach((item) => {
                        const itemDiv = document.createElement("div");
                        itemDiv.className = "inventory-item";
                        itemDiv.innerHTML = `
                        <img src="${getItemImage(item)}" alt="${item}">
                        <div>${item}</div>
                    `;
                        const origin = itemOrigins[item];
                        itemDiv.onclick = () => removeFromInventory(item);
                        itemDiv.title = `Return to ${inventory[origin.cabinet].name}, Drawer ${origin.drawer}`;

                        inventoryContainer.appendChild(itemDiv);
                    });
                }

                function closeModal() {
                    if (currentCabinet && currentDrawer) {
                        logAction("Drawer Closed", `${inventory[currentCabinet].name} > Drawer ${currentDrawer}`);
                    }
                    document.getElementById("modalOverlay").style.display = "none";
                    currentCabinet = null;
                    currentDrawer = null;
                }

                // Close modal when clicking outside
                document.getElementById("modalOverlay").addEventListener("click", (e) => {
                    if (e.target === document.getElementById("modalOverlay")) {
                        closeModal();
                    }
                });

                function showGameComplete() {
                    document.getElementById("gameComplete").style.display = "flex";
                    logAction("Game Complete", "All missions completed successfully");
                }

                function restartGame() {
                    // Reset all missions
                    missions.forEach((mission) => {
                        mission.completed = false;
                        mission.progress = 0;
                        if (mission.requirement.type === "collect_specific") {
                            Object.keys(mission.requirement.progress).forEach((key) => {
                                mission.requirement.progress[key] = false;
                            });
                        }
                    });

                    // Reset current mission index
                    currentMissionIndex = 0;

                    // Return all items and reset inventory
                    returnAllItems();

                    // Update mission display
                    updateMissionDisplay();

                    // Hide game complete screen
                    document.getElementById("gameComplete").style.display = "none";

                    logAction("Game Restart", "Game has been reset");
                }
                function showGameComplete() {
                    document.getElementById("gameComplete").style.display = "flex";
                    logAction("Game Complete", "All missions completed successfully");
                }

                function startGame() {
                    document.getElementById("gameStart").style.display = "none";
                    logAction("Game Started", "Player started the game");
                }

                function restartGame() {
                    // Reset all missions in allScenarios
                    allScenarios.forEach((mission) => {
                        mission.completed = false;
                        mission.progress = 0;
                        if (mission.requirement.type === "collect_specific") {
                            Object.keys(mission.requirement.progress).forEach((key) => {
                                mission.requirement.progress[key] = false;
                            });
                        }
                    });

                    // Reset current mission index
                    currentMissionIndex = 0;

                    // Return all items and reset inventory
                    returnAllItems();

                    // Hide game complete screen
                    document.getElementById("gameComplete").style.display = "none";

                    // Show scenario setup screen again
                    document.getElementById("scenarioSetup").style.display = "flex";
                    renderScenarioList();

                    logAction("Game Restart", "Game has been reset");
                }

                document.addEventListener("DOMContentLoaded", function () {
                    // Ensure game complete screen is hidden on load
                    document.getElementById("gameComplete").style.display = "none";
                    // Initialize scenario setup
                    renderScenarioList();
                });

                // ===== SCENARIO SETUP SYSTEM =====
                let allScenarios = [...missions]; // Copy of all available scenarios
                let selectedScenarioIds = [1, 2, 3]; // IDs of scenarios selected to play
                let editingScenarioIndex = null; // Index of scenario being edited
                let isAddingNew = false; // Flag for add vs edit mode

                function renderScenarioList() {
                    const scenarioList = document.getElementById('scenarioList');
                    scenarioList.innerHTML = '';

                    allScenarios.forEach((scenario, index) => {
                        const isSelected = selectedScenarioIds.includes(scenario.id);
                        const card = document.createElement('div');
                        card.className = `scenario-card ${isSelected ? 'selected' : ''}`;

                        // Get meta information based on scenario type
                        let metaInfo = '';
                        if (scenario.requirement.type === 'collect') {
                            metaInfo = `Type: Collect Any | Drawer: ${scenario.requirement.drawer} | Count: ${scenario.requirement.count}`;
                        } else if (scenario.requirement.type === 'collect_specific') {
                            metaInfo = `Type: Specific Items | Drawer: ${scenario.requirement.drawer} | Items: ${scenario.requirement.items.join(', ')}`;
                        }

                        card.innerHTML = `
                            <input type="checkbox" class="scenario-checkbox"
                                ${isSelected ? 'checked' : ''}
                                onchange="toggleScenarioSelection(${scenario.id})">
                            <div class="scenario-details">
                                <div class="scenario-title">${scenario.title}</div>
                                <div class="scenario-description">${scenario.description}</div>
                                <div class="scenario-meta">${metaInfo}</div>
                            </div>
                            <div class="scenario-actions">
                                <button class="edit-scenario-btn" onclick="openEditScenario(${index})">Edit</button>
                                <button class="delete-scenario-btn" onclick="deleteScenario(${index})">Delete</button>
                            </div>
                        `;
                        scenarioList.appendChild(card);
                    });

                    // Update selection counter
                    updateSelectionCounter();
                }

                function updateSelectionCounter() {
                    const counterText = `${selectedScenarioIds.length} scenario${selectedScenarioIds.length !== 1 ? 's' : ''} selected`;
                    const startBtn = document.querySelector('.start-selected-btn');
                    if (startBtn) {
                        startBtn.textContent = `Start Game (${counterText})`;
                    }
                }

                function toggleScenarioSelection(scenarioId) {
                    const index = selectedScenarioIds.indexOf(scenarioId);
                    if (index > -1) {
                        selectedScenarioIds.splice(index, 1);
                    } else {
                        selectedScenarioIds.push(scenarioId);
                    }
                    renderScenarioList();
                }

                function openEditScenario(index) {
                    editingScenarioIndex = index;
                    isAddingNew = false;
                    const scenario = allScenarios[index];

                    document.getElementById('modalTitle').textContent = 'Edit Scenario';
                    document.getElementById('scenarioTitleInput').value = scenario.title;
                    document.getElementById('scenarioDescInput').value = scenario.description;
                    document.getElementById('scenarioTypeInput').value = scenario.requirement.type;
                    document.getElementById('scenarioDrawerInput').value = scenario.requirement.drawer;

                    if (scenario.requirement.type === 'collect') {
                        document.getElementById('scenarioCountInput').value = scenario.requirement.count;
                    }

                    updateScenarioTypeFields();

                    if (scenario.requirement.type === 'collect_specific') {
                        populateItemsSelector(scenario.requirement.drawer, scenario.requirement.items);
                    }

                    document.getElementById('editModalOverlay').style.display = 'block';
                }

                function openAddScenario() {
                    editingScenarioIndex = null;
                    isAddingNew = true;

                    document.getElementById('modalTitle').textContent = 'Add New Scenario';
                    document.getElementById('scenarioTitleInput').value = '';
                    document.getElementById('scenarioDescInput').value = '';
                    document.getElementById('scenarioTypeInput').value = 'collect';
                    document.getElementById('scenarioDrawerInput').value = '1-1';
                    document.getElementById('scenarioCountInput').value = 3;

                    updateScenarioTypeFields();
                    document.getElementById('editModalOverlay').style.display = 'block';
                }

                function updateScenarioTypeFields() {
                    const type = document.getElementById('scenarioTypeInput').value;
                    const drawer = document.getElementById('scenarioDrawerInput').value;

                    if (type === 'collect') {
                        document.getElementById('collectCountGroup').style.display = 'block';
                        document.getElementById('specificItemsGroup').style.display = 'none';
                    } else {
                        document.getElementById('collectCountGroup').style.display = 'none';
                        document.getElementById('specificItemsGroup').style.display = 'block';
                        populateItemsSelector(drawer, []);
                    }
                }

                function populateItemsSelector(drawer, selectedItems = []) {
                    const itemsSelector = document.getElementById('itemsSelector');
                    itemsSelector.innerHTML = '';

                    // Get items from the selected drawer
                    const drawerItems = inventory[1].drawers[drawer] || [];

                    // Get all items from 1 to 21
                    const allItems = [];
                    for (let i = 1; i <= 21; i++) {
                        allItems.push(`Item ${i}`);
                    }

                    allItems.forEach(item => {
                        const itemDiv = document.createElement('div');
                        itemDiv.className = `item-option ${selectedItems.includes(item) ? 'selected' : ''}`;
                        itemDiv.textContent = item;
                        itemDiv.onclick = function() {
                            itemDiv.classList.toggle('selected');
                        };
                        itemsSelector.appendChild(itemDiv);
                    });
                }

                // Update items selector when drawer changes
                document.addEventListener('DOMContentLoaded', function() {
                    const drawerSelect = document.getElementById('scenarioDrawerInput');
                    if (drawerSelect) {
                        drawerSelect.addEventListener('change', function() {
                            if (document.getElementById('scenarioTypeInput').value === 'collect_specific') {
                                populateItemsSelector(this.value, []);
                            }
                        });
                    }
                });

                function saveScenario() {
                    const title = document.getElementById('scenarioTitleInput').value.trim();
                    const description = document.getElementById('scenarioDescInput').value.trim();
                    const type = document.getElementById('scenarioTypeInput').value;
                    const drawer = document.getElementById('scenarioDrawerInput').value;

                    if (!title || !description) {
                        alert('Please fill in all required fields');
                        return;
                    }

                    const newScenario = {
                        id: isAddingNew ? (Math.max(...allScenarios.map(s => s.id)) + 1) : allScenarios[editingScenarioIndex].id,
                        title: title,
                        description: description,
                        requirement: {},
                        completed: false,
                        progress: 0
                    };

                    if (type === 'collect') {
                        const count = parseInt(document.getElementById('scenarioCountInput').value);
                        newScenario.requirement = {
                            type: 'collect',
                            drawer: drawer,
                            count: count,
                            fromSpecificDrawer: true
                        };
                    } else {
                        const selectedItems = Array.from(document.querySelectorAll('.item-option.selected'))
                            .map(el => el.textContent);

                        if (selectedItems.length === 0) {
                            alert('Please select at least one item for specific collection');
                            return;
                        }

                        const progress = {};
                        selectedItems.forEach(item => {
                            progress[item] = false;
                        });

                        newScenario.requirement = {
                            type: 'collect_specific',
                            drawer: drawer,
                            items: selectedItems,
                            progress: progress
                        };
                    }

                    if (isAddingNew) {
                        allScenarios.push(newScenario);
                        selectedScenarioIds.push(newScenario.id);
                    } else {
                        allScenarios[editingScenarioIndex] = newScenario;
                    }

                    closeEditModal();
                    renderScenarioList();
                }

                function deleteScenario(index) {
                    if (confirm('Are you sure you want to delete this scenario?')) {
                        const scenarioId = allScenarios[index].id;
                        allScenarios.splice(index, 1);

                        // Remove from selected if it was selected
                        const selectedIndex = selectedScenarioIds.indexOf(scenarioId);
                        if (selectedIndex > -1) {
                            selectedScenarioIds.splice(selectedIndex, 1);
                        }

                        renderScenarioList();
                    }
                }

                function closeEditModal() {
                    document.getElementById('editModalOverlay').style.display = 'none';
                }

                // Close edit modal when clicking outside
                document.addEventListener('DOMContentLoaded', function() {
                    document.getElementById('editModalOverlay').addEventListener('click', function(e) {
                        if (e.target === this) {
                            closeEditModal();
                        }
                    });
                });

                function startWithSelectedScenarios() {
                    if (selectedScenarioIds.length === 0) {
                        alert('Please select at least one scenario to play');
                        return;
                    }

                    // Update missions array with only selected scenarios, in order
                    missions.length = 0;
                    selectedScenarioIds.sort((a, b) => a - b).forEach(id => {
                        const scenario = allScenarios.find(s => s.id === id);
                        if (scenario) {
                            // Create a deep copy to avoid reference issues
                            const scenarioCopy = JSON.parse(JSON.stringify(scenario));
                            missions.push(scenarioCopy);
                        }
                    });

                    // Reset mission state
                    currentMissionIndex = 0;
                    missions.forEach(mission => {
                        mission.completed = false;
                        mission.progress = 0;
                        if (mission.requirement.type === 'collect_specific') {
                            Object.keys(mission.requirement.progress).forEach(key => {
                                mission.requirement.progress[key] = false;
                            });
                        }
                    });

                    // Update the display and show game start screen
                    updateMissionDisplay();
                    document.getElementById('scenarioSetup').style.display = 'none';
                    document.getElementById('gameStart').style.display = 'flex';
                }

                async function continueToSurvey() {
                    try {
                        const logString = gameLogEntries.join(" | ");
                        const jsonData = `{"gameLogEntries":"${logString}"}`;
                        const encodedData = btoa(jsonData);
                        window.location.href =
                            "https://stonybrookuniversity.co1.qualtrics.com/jfe/form/SV_4U6HuNElynf0gd0?Q_EED=" +
                            encodedData;
                    } catch (err) {
                        console.error("Error:", err);
                        alert("Error saving game data.");
                    }
                }
            </script>

            <!-- Scenario Setup Screen -->
            <div class="scenario-setup" id="scenarioSetup">
                <div class="scenario-setup-content">
                    <h1>Teaching Scenario Setup</h1>
                    <p style="text-align: center; font-family: 'Courier New', monospace; color: #f0f0f0; margin-bottom: 20px; font-size: clamp(14px, 3.5vw, 16px);">
                        Configure which teaching scenarios to include in your game session
                    </p>

                    <h2>Available Scenarios</h2>
                    <div class="scenario-list" id="scenarioList"></div>

                    <div class="setup-controls">
                        <button class="add-scenario-btn" onclick="openAddScenario()">+ Add New Scenario</button>
                        <button class="start-selected-btn" onclick="startWithSelectedScenarios()">Start Game</button>
                    </div>
                </div>
            </div>

            <!-- Edit/Add Scenario Modal -->
            <div class="edit-modal-overlay" id="editModalOverlay">
                <div class="edit-modal">
                    <h2 id="modalTitle">Edit Scenario</h2>

                    <div class="form-group">
                        <label>Scenario Title</label>
                        <input type="text" id="scenarioTitleInput" placeholder="e.g., Cabinet Explorer I">
                    </div>

                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="scenarioDescInput" placeholder="e.g., Collect any three items from Drawer 1-1"></textarea>
                    </div>

                    <div class="form-group">
                        <label>Mission Type</label>
                        <select id="scenarioTypeInput" onchange="updateScenarioTypeFields()">
                            <option value="collect">Collect Any Items</option>
                            <option value="collect_specific">Collect Specific Items</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Target Drawer</label>
                        <select id="scenarioDrawerInput">
                            <option value="1-1">Drawer 1-1</option>
                            <option value="1-2">Drawer 1-2</option>
                            <option value="1-3">Drawer 1-3</option>
                            <option value="1-4">Drawer 1-4</option>
                            <option value="1-5">Drawer 1-5</option>
                            <option value="1-6">Drawer 1-6</option>
                            <option value="1-7">Drawer 1-7</option>
                        </select>
                    </div>

                    <div class="form-group" id="collectCountGroup">
                        <label>Number of Items to Collect</label>
                        <input type="number" id="scenarioCountInput" min="1" max="10" value="3">
                    </div>

                    <div class="form-group" id="specificItemsGroup" style="display: none;">
                        <label>Select Specific Items (click to toggle)</label>
                        <div class="items-selector" id="itemsSelector"></div>
                    </div>

                    <div class="modal-buttons">
                        <button class="save-btn" onclick="saveScenario()">Save</button>
                        <button class="cancel-btn" onclick="closeEditModal()">Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Game Start Screen -->
            <div class="game-start" id="gameStart">
                <div class="game-start-content">
                    <h1>Cabinet Quest</h1>
                    <div class="instructions">
                        <p>
                            Welcome to <span>Cabinet Quest</span>! <br /><br />
                            Brave adventurer, your mission awaits!
                        </p>
                        <br />
                        <p>Collect specific items from designated cabinet drawers</p>
                        <p>Click cabinets to open, click items to collect</p>
                        <p>Click inventory items to return them</p>
                        <p>Submit when your mission is complete</p>
                        <br />
                        <p>
                            Complete all quests to become <br />
                            the <span>Cabinet Champion</span>!
                        </p>
                    </div>
                    <button class="start-button" onclick="startGame()">Start Game</button>
                </div>
            </div>
            <!-- Game Complete Screen -->
            <div class="game-complete" id="gameComplete">
                <div class="game-complete-content">
                    <h1>Well Done!</h1>
                    <p>
                        You are now a <br />
                        <br />
                        <span> Cabinet Champion </span> <br />
                        <br />
                    </p>
                    <div class="game-complete-buttons">
                        <button class="restart-button" onclick="restartGame()">Play Again</button>
                        <button class="survey-button" onclick="continueToSurvey()">Continue to Survey</button>
                    </div>
                </div>
            </div>
        </div>
    </body>
</html>
